# AutoPaperWeb - å­¦æœ¯è®ºæ–‡ç›¸å…³æ€§ç­›é€‰å·¥å…·

## é¡¹ç›®ç®€ä»‹

AutoPaperWeb æ˜¯ä¸€ä¸ªåŸºäºäººå·¥æ™ºèƒ½çš„å­¦æœ¯è®ºæ–‡ç›¸å…³æ€§ç­›é€‰å·¥å…·ï¼Œæ—¨åœ¨å¸®åŠ©ç ”ç©¶äººå‘˜å¿«é€Ÿä»å¤§é‡å­¦æœ¯è®ºæ–‡ä¸­ç­›é€‰å‡ºä¸ç‰¹å®šç ”ç©¶é—®é¢˜ç›¸å…³çš„æ–‡çŒ®ã€‚è¯¥ç³»ç»Ÿç»“åˆäº†Webç•Œé¢å’Œæ¡Œé¢åº”ç”¨ç¨‹åºï¼Œæä¾›äº†çµæ´»çš„è®ºæ–‡å¤„ç†å’Œç­›é€‰åŠŸèƒ½ã€‚

## ğŸ“š å¿«é€Ÿå¯¼èˆª
- æœ¬åœ°å¼€å‘è€…æ¨¡å¼ï¼ˆWindows ç›´è¿æœ¬æœº MySQLã€æ— éœ€ Dockerï¼‰ï¼š`docs/LocalDevelop.md`
- éƒ¨ç½²ä¸è¿ç»´ï¼ˆDockerã€Nginxã€å®¿ä¸»æœº MySQLã€æ’é”™ï¼‰ï¼š`docs/DEPLOYMENT.md`
- Nginx å¿«é€Ÿéƒ¨ç½²ï¼ˆåä»£/è´Ÿè½½å‡è¡¡/HTTPSï¼‰ï¼š`docs/NginxDeploy.md`
- ç®¡ç†å‘˜é¢æ¿ä½¿ç”¨æŒ‡å—ï¼š`docs/ADMIN.md`

## ä¸»è¦åŠŸèƒ½

### ğŸ” æ™ºèƒ½è®ºæ–‡ç­›é€‰
- åŸºäºç ”ç©¶é—®é¢˜å’Œè¦æ±‚çš„AIé©±åŠ¨ç›¸å…³æ€§åˆ¤æ–­
- æ”¯æŒå¤šç§å­¦æœ¯æ•°æ®æºçš„è®ºæ–‡å¤„ç†
- çµæ´»çš„å¹´ä»½èŒƒå›´ç­›é€‰
- æ‰¹é‡å¤„ç†å’Œå¹¶å‘å¤„ç†æ”¯æŒ

### ğŸ”„ è’¸é¦åŠŸèƒ½
- åŸºäºå·²ç­›é€‰ç»“æœçš„äºŒæ¬¡ç²¾ç‚¼
- æ›´ç²¾ç¡®çš„ç›¸å…³æ€§åˆ¤æ–­
- æ”¯æŒå¤šè½®ç­›é€‰ä¼˜åŒ–

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶
- **Main.py**: ä¸»ç¨‹åºå…¥å£ï¼Œå¯åŠ¨WebæœåŠ¡å™¨
- **lib/webserver/**: WebæœåŠ¡å™¨å’ŒAPIæ¥å£
- **lib/process/**: è®ºæ–‡å¤„ç†å’ŒAIç­›é€‰é€»è¾‘
- **lib/load_data/**: æ•°æ®åŠ è½½å’Œæ•°æ®åº“æ“ä½œ
- **lib/html/**: Webå‰ç«¯é¡µé¢

### æ•°æ®åº“è¡¨ç»“æ„
- `user_info`: ç”¨æˆ·ä¿¡æ¯è¡¨
- `api_list`: APIå¯†é’¥ç®¡ç†è¡¨
- `query_log`: æŸ¥è¯¢å†å²è®°å½•è¡¨
- `search_*`: åŠ¨æ€åˆ›å»ºçš„æœç´¢ç»“æœè¡¨
- `PaperInfo`: è®ºæ–‡åŸºç¡€ä¿¡æ¯è¡¨
- `ContentList`: è®ºæ–‡å†…å®¹åˆ—è¡¨è¡¨

## å®‰è£…å’Œé…ç½®

### ç¯å¢ƒè¦æ±‚
- Python 3.10+
- MySQL 8+
- å¿…è¦çš„Pythonä¾èµ–åŒ…

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd AutoPaperWeb
```

2. ï¼ˆå¯é€‰ï¼Œä»…ç”¨äºæœ¬åœ°å¼€å‘è®¡ç®—æœºï¼‰**å®‰è£… Conda å¹¶åˆ›å»º/æ¿€æ´»ç¯å¢ƒ**

   é‡è¦è¯´æ˜ï¼šæ­¤æ­¥éª¤åªæ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒçš„ç”µè„‘ä¸Šï¼ˆä¾‹å¦‚ Windows 11ï¼‰è¿›è¡Œ Python ç¯å¢ƒçš„é…ç½®ä¸ç®¡ç†ã€‚é¡¹ç›®åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šéƒ¨ç½²è¿è¡Œæ—¶ä¸éœ€è¦åœ¨ Conda ä¸­è¿è¡Œï¼Œå¯ç›´æ¥ä½¿ç”¨ç³»ç»Ÿ Pythonï¼ˆæˆ–æŒ‰éƒ¨ç½²æ–‡æ¡£ä½¿ç”¨ Dockerï¼‰ã€‚

   - å®‰è£…æ–¹å¼ï¼š
   å¯é€‰æ–¹å¼1ï¼šå®‰è£…å®˜æ–¹ç»´æŠ¤çš„ç‰ˆæœ¬ã€‚å‰å¾€ Anaconda æˆ– Miniconda å®˜ç½‘ä¸‹è½½å®‰è£…ï¼ˆæ¨è Minicondaï¼Œä½“ç§¯å¾ˆå°ï¼‰ã€‚ä¸¤è€…éƒ½ä¼šå¯¹å•†ä¸šç”¨é€”æ”¶è´¹ã€‚
   å¯é€‰æ–¹å¼2ï¼ˆæ¨èï¼‰ï¼šå®‰è£…ç¤¾åŒºç»´æŠ¤çš„ç‰ˆæœ¬ã€‚æ­¤ç‰ˆæœ¬å¼€æºä¸”å…è´¹ï¼Œä½¿ç”¨å‘½ä»¤å’Œæ–¹æ³•ä¸å®˜æ–¹ç‰ˆæœ¬å®Œå…¨ä¸€è‡´ã€‚é“¾æ¥ï¼šhttps://conda-forge.org/download/

   - åˆ›å»ºå¹¶æ¿€æ´»ç¯å¢ƒï¼ˆç¤ºä¾‹ä½¿ç”¨ Python 3.10ï¼‰ï¼š
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ autopaperweb
conda create -n autopaperweb python=3.10 -y
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ autopaperweb
conda activate autopaperweb
# å¯é€‰ï¼šå‡çº§ pip
python -m pip install --upgrade pip
```

3. **å®‰è£…ä¾èµ–**
```bash
python install_requirements.py
```

4. **é…ç½®æ•°æ®åº“ä¸ Redisï¼ˆå•ä¸€çœŸæºï¼‰**
ç¼–è¾‘ `config.json` æ–‡ä»¶ï¼Œæ‰€æœ‰é…ç½®ä»…ä»æ­¤å¤„è¯»å–ï¼›ä¸å†è¯»å–ç¯å¢ƒå˜é‡è¦†ç›–ï¼Œé¿å…æ©ç›–é…ç½®é—®é¢˜ã€‚

é€‰é¡¹1ï¼šæœ¬åœ°å¼€å‘è€…æ¨¡å¼ï¼ˆlocal_develop_mode=trueï¼Œç›´è¿æœ¬æœº MySQLï¼ŒRedis ä½¿ç”¨ compose å†…ç½®å®¹å™¨ï¼‰

```json
{
  "local_develop_mode": true,
  "database": {
    "local": {
      "host": "127.0.0.1",
      "port": 3306,
      "user": "root",
      "password": "123456",
      "name": "paperdb"
    },
    "cloud": {
      "host": "<ä½ çš„RDSå†…ç½‘åœ°å€>",
      "port": 3306,
      "user": "<äº‘ç«¯ç”¨æˆ·å>",
      "password": "<äº‘ç«¯å¯†ç >",
      "name": "<äº‘ç«¯æ•°æ®åº“å>"
    }
  },
  "redis": {
    "use_queue": true,
    "use_rate_limiter": true,
    "local_url": "redis://redis:6379/0",
    "cloud_url": "redis://<ç”¨æˆ·>:<å¯†ç >@<äº‘ç«¯Redisåœ°å€>:6379/0"
  }
}
```

é€‰é¡¹2ï¼šç›´æ¥è¿æ¥äº‘æ•°æ®åº“ä¸äº‘ Redisï¼ˆlocal_develop_mode=falseï¼‰

å°† `local_develop_mode` è®¾ä¸º `false`ï¼Œå¹¶ä»…å¡«å†™ `database.cloud` ä¸ `redis.cloud_url`ã€‚åç«¯ä¼šä½¿ç”¨è¿™äº›é…ç½®ç›´è¿é˜¿é‡Œäº‘ RDS/Redisï¼ˆVPC å†…ç½‘ï¼‰ã€‚

## å‰ç½®æ¡ä»¶ï¼ˆå†…ç½‘ç›´è¿å¿…é¡»æ»¡è¶³ï¼‰
- åŒåœ°åŸŸä¸åŒä¸€ VPCï¼šECS ä¸ RDS å¿…é¡»åœ¨åŒä¸€åœ°åŸŸä¸”åŒä¸€ VPCï¼›ä½¿ç”¨ RDS æä¾›çš„â€œå†…ç½‘åœ°å€â€ï¼ˆå½¢å¦‚ `*.mysql.rds.aliyuncs.com`ï¼‰ã€‚
- RDS è®¿é—®æ§åˆ¶ï¼šåœ¨ RDS çš„â€œç™½åå•/è®¿é—®æ§åˆ¶â€ä¸­æ”¾é€š ECS æ‰€åœ¨ç½‘æ®µæˆ–ç§ç½‘ IPï¼ˆä¾‹å¦‚ä½ çš„ VPC ç½‘æ®µ 172.16.0.0/12ã€172.31.x.x/16ï¼Œæˆ– ECS ç§ç½‘ IPï¼‰ã€‚
- å®‰å…¨ç»„ç­–ç•¥ï¼ˆè¯¦æƒ…å‚è€ƒé˜¿é‡Œäº‘æ‰‹å†Œï¼‰ï¼š
  - RDS å®‰å…¨ç­–ç•¥å…è®¸æ¥è‡ª ECS çš„ 3306/TCP è®¿é—®ï¼›
  - ECS å®‰å…¨ç»„å…è®¸å¯¹å¤–å‘èµ· 3306/TCP å‡ºç«™ï¼ˆé»˜è®¤æ”¾é€šå³å¯ï¼‰ã€‚
- æ•°æ®åº“ä¸è´¦å·å·²åˆ›å»ºï¼Œå¹¶æˆäºˆè¯¥è´¦å·å¯¹åº“çš„è¯»å†™æƒé™ã€‚

## ä¿®æ”¹æœ¬é¡¹ç›®çš„æ•°æ®åº“è¿æ¥æŒ‡å‘ RDS/Redisï¼ˆDocker éƒ¨ç½²ï¼‰
ç”Ÿäº§ä¸æµ‹è¯•ç¯å¢ƒå‡é€šè¿‡ `config.json` åˆ‡æ¢ï¼Œä¸å†ä½¿ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥ã€‚è¯·ç›´æ¥ç¼–è¾‘ `config.json` ä¸­çš„ `database.cloud` ä¸ `redis.cloud_url`ï¼Œå¹¶ç¡®ä¿ `local_develop_mode=false`ã€‚

## é‡å¯å®¹å™¨ï¼ˆå½“å‰ç‰ˆæœ¬ä¸ºâ€œæ¯å°å®ä¾‹ 1 ä¸ªåç«¯å®¹å™¨â€ï¼‰
å½“å‰æ¶æ„æ¯å°æœåŠ¡å™¨ä»…éœ€ 1 ä¸ªåç«¯å®¹å™¨ï¼ˆæ­é… 1 ä¸ªå‰ç«¯å®¹å™¨ï¼Œå¯é€‰ï¼‰ã€‚æ›´æ–°é…ç½®æˆ–ä»£ç åï¼Œå¯ç›´æ¥é‡å»ºå¹¶æ‹‰èµ·ï¼š

```bash
docker compose up -d --build
```

è¯¦æƒ…å‚è€ƒé˜¿é‡Œäº‘æ‰‹å†Œï¼šè¿æ¥RDS MySQLå®ä¾‹ï¼ˆæ–¹æ³•äºŒï¼‰
https://help.aliyun.com/zh/rds/apsaradb-rds-for-mysql/step-2-connect-to-an-apsaradb-rds-for-mysql-instance?spm=a2c4g.11186623.help-menu-26090.d_1_2.621a676b5scKYm&scm=20140722.H_2807944._.OR_help-T_cn~zh-V_1#696eafcd62pfi

5. **å®¿ä¸»æœºå®‰è£…ä¸é…ç½® Nginxï¼ˆåå‘ä»£ç† + è´Ÿè½½å‡è¡¡ï¼‰**
ä¸ºä¿æŒæœ¬æ–‡ç®€æ´ï¼Œæœ¬èŠ‚è¿ç§»è‡³ç‹¬ç«‹æ–‡æ¡£

- è¯·å‚è§ï¼š`docs/NginxDeploy.md`

è¯¥æ–‡æ¡£åŒ…å«ï¼šæœ€å°åŒ–å®‰è£…æ­¥éª¤ã€HTTP/HTTPS é…ç½®ç¤ºä¾‹ï¼ˆå« 80 è·³è½¬ 443ï¼‰ã€è¯ä¹¦æ”¾ç½®ä¸æƒé™ã€å¯ç”¨ç«™ç‚¹ã€é‡è½½æ ¡éªŒã€DNS/å®‰å…¨ç»„ã€é˜²ç«å¢™ã€åŸŸåå˜æ›´æ—¶éœ€åŒæ­¥ä¿®æ”¹çš„é¡¹ç­‰ã€‚æ›´æ·±å…¥è¯´æ˜ä¸å¯é€‰å‚æ•°è¯·å‚è€ƒä¸Šæ–‡é“¾æ¥çš„é˜¿é‡Œäº‘å®˜æ–¹æ‰‹å†Œã€‚

6. **å¯åŠ¨ç³»ç»Ÿï¼ˆå¼€å‘è€…æœ¬åœ° / Dockerï¼‰**

æ–¹å¼ Aï¼ˆå¼€å‘è€…æœ¬åœ°ç›´è¿ MySQLï¼Œä¸ç”¨ Dockerï¼‰ï¼š

```bash
python .\main.py
```

æ–¹å¼ Bï¼ˆDockerï¼Œæ¨èç”¨äºä¸€é”®å¯åŠ¨ä¸éš”ç¦»ï¼‰ï¼š

ç¡®ä¿è·¯å¾„ä¸­ä¸åŒ…å«ä¸­æ–‡ï¼›ç„¶åï¼š

```bash
docker compose down
docker ps -a --format "{{.Names}}" | ForEach-Object { if ($_ -match "redis") { docker rm -f $_ } }
$Env:DOCKER_BUILDKIT="0"
$Env:COMPOSE_DOCKER_CLI_BUILD="0"
docker compose -f docker-compose.yml -f docker-compose.local.yml up -d --build
```

# æœ¬åœ°å¯ä½¿ç”¨çš„ç½‘é¡µï¼š
ä¸»é¡µé¢ï¼šhttp://127.0.0.1:8080/
ç®¡ç†å‘˜é¡µé¢ï¼šhttp://127.0.0.1:8080/AutoPaperSearchControlPanelAdmin.html
å®¹å™¨è°ƒè¯•é¡µé¢ï¼šhttp://127.0.0.1:8080/debugLog.html

6. **6.2 å¯åŠ¨ç³»ç»Ÿï¼ˆäº‘ç«¯æœåŠ¡å™¨ï¼‰**


# ğŸš€ AutoPaperWeb éƒ¨ç½²è„šæœ¬ä½¿ç”¨è¯´æ˜

æœ¬è„šæœ¬ç”¨äºä¸€é”®éƒ¨ç½² **AutoPaperWeb_Server**ï¼Œè‡ªåŠ¨å®Œæˆå®¹å™¨æ¸…ç†ã€æ–‡ä»¶æ›´æ–°ä¸å®¹å™¨é‡å¯ã€‚

---

## ğŸ“ 1. æ”¾ç½®æ›´æ–°åŒ…å’Œè„šæœ¬
æ¯æ¬¡æ›´æ–°å‰é€šè¿‡MobaXtermæŠŠå‹ç¼©åŒ…AutoPaperWeb_Server.zipæ”¾åœ¨æœåŠ¡å™¨æ–‡ä»¶çš„æ ¹ç›®å½•/opt/ä¸‹ã€‚
ç¬¬ä¸€æ¬¡æ›´æ–°éœ€è¦å°†è„šæœ¬æ–‡ä»¶ `deploy_autopaperweb.sh` æ”¾åœ¨/opt/ä¸‹ï¼š

```bash
/opt/deploy_autopaperweb.sh
```

---

## ğŸ” 2. é¦–æ¬¡æ‰§è¡Œå‰èµ‹äºˆæ‰§è¡Œæƒé™

é¦–æ¬¡è¿è¡Œå‰éœ€è¦ä¸ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆåªéœ€æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼š

```bash
chmod +x /opt/deploy_autopaperweb.sh
```

> âœ… ä¹‹åå†æ¬¡è¿è¡Œè„šæœ¬æ—¶ **æ— éœ€é‡å¤æˆæƒ**ã€‚

---

## â–¶ï¸ 3. è¿è¡Œè„šæœ¬

è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼š

```bash
sudo /opt/deploy_autopaperweb.sh
```

# è¯·ç¡®ä¿æœ¬è„šæœ¬ä¸º LF è¡Œå°¾ï¼ˆé CRLFï¼‰ï¼›è‹¥å‡ºç° â€œNo such file or directoryâ€ï¼Œè¯·æ‰§è¡Œï¼š
```bash
sudo sed -i 's/\r$//' /opt/deploy_autopaperweb.sh && sudo chmod +x /opt/deploy_autopaperweb.sh
sudo /opt/deploy_autopaperweb.sh
```

è„šæœ¬å°†è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰ç°æœ‰ Docker å®¹å™¨  
2. åˆ é™¤æ—§çš„ `/opt/AutoPaperWeb_Server` ç›®å½•  
3. è§£å‹ `AutoPaperWeb_Server.zip`  
4. è®¾ç½®ç¯å¢ƒå˜é‡å¹¶é€šè¿‡ `docker compose` å¯åŠ¨å®¹å™¨  

---

## ğŸ” 4. éªŒè¯éƒ¨ç½²ç»“æœ

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼š

```bash
docker ps
```

å¦‚æœéƒ¨ç½²æˆåŠŸï¼Œä½ åº”èƒ½çœ‹åˆ°å¤šä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œã€‚

## å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çš„å®æ—¶æ—¥å¿—
```bash
# å®æ—¶è·Ÿè¸ªæ‰€æœ‰è¿è¡Œä¸­å®¹å™¨çš„æ—¥å¿—ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
for container in $(docker ps -q); do
  # å…ˆè¾“å‡ºå®¹å™¨åç§°ä½œä¸ºåˆ†éš”æ ‡è¯†
  echo "===== å®¹å™¨ $(docker inspect --format '{{.Name}}' $container) æ—¥å¿— ====="
  # å®æ—¶è·Ÿè¸ªè¯¥å®¹å™¨æ—¥å¿—ï¼ˆ-f å®æ—¶ï¼Œ-t æ—¶é—´æˆ³ï¼‰
  docker logs -f -t $container &
done
```

### å¦‚ä½•æ‰‹åŠ¨åˆ é™¤å¹¶é‡æ–°æ‹‰èµ·æ‰€æœ‰å®¹å™¨
```bash
# åœæ­¢æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„å®¹å™¨IDï¼Œè‹¥æ²¡æœ‰å®¹å™¨åˆ™å¿½ç•¥é”™è¯¯ï¼‰
docker stop $(docker ps -aq) || true
# åˆ é™¤æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„å®¹å™¨IDï¼Œè‹¥æ²¡æœ‰å®¹å™¨åˆ™å¿½ç•¥é”™è¯¯ï¼‰
docker rm $(docker ps -aq) || true
# æ‹‰èµ·å®¹å™¨
cd /opt/AutoPaperWeb_Server
sudo docker compose up -d --build
```

## APIæ¥å£

### ç”¨æˆ·è®¤è¯
- `POST /api/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/login` - ç”¨æˆ·ç™»å½•

### è®ºæ–‡æœç´¢
- `POST /api/start_search` - å¼€å§‹è®ºæ–‡æœç´¢
- `POST /api/start_distillation` - å¼€å§‹è’¸é¦å¤„ç†
- `GET /api/query_progress` - æŸ¥è¯¢å¤„ç†è¿›åº¦

### æ•°æ®ç®¡ç†
- `GET /api/folders` - è·å–å¯ç”¨æ•°æ®æº
- `GET /api/query_history` - è·å–æŸ¥è¯¢å†å²
- `GET /api/download_csv` - ä¸‹è½½CSVç»“æœ
- `GET /api/download_bib` - ä¸‹è½½BibTeXç»“æœ


## Docker éƒ¨ç½²ï¼ˆç®€è¦ï¼‰

æœåŠ¡å™¨ä¾§æ¨èä½¿ç”¨ Docker éƒ¨ç½²ã€‚æ•°æ®åº“ä¸ Redis æŒ‡å‘å‡åœ¨ `config.json` ä¸­é…ç½®ï¼ˆä¸è¯»å–ç¯å¢ƒå˜é‡è¦†ç›–ï¼‰ã€‚

å¿«é€Ÿå¯åŠ¨ï¼ˆæœåŠ¡å™¨ä¸Šï¼‰ï¼š
```bash
cd /opt/AutoPaperWeb
sudo docker compose up -d --build
```

æ›´å¤šéƒ¨ç½²ç»†èŠ‚ï¼ˆNginx åä»£ã€å¯¼å‡ºé•œåƒã€æ—¥å¿—ä¸è¿ç»´ï¼‰è¯·å‚è€ƒ `docs/DEPLOYMENT.md`ã€‚

## æ¶æ„è¯´æ˜ï¼ˆå›ºå®šå…±äº«æ±  + å•ä¸€ FIFO é˜Ÿåˆ—ï¼‰

å½“å‰ç‰ˆæœ¬æ¶æ„å·²æ”¶æ•›ä¸ºï¼š

1. å•ä¸€ FIFO ä»»åŠ¡é˜Ÿåˆ—ï¼ˆRedis ä¼˜å…ˆï¼ŒMySQL å›é€€ï¼‰ï¼Œä¸å†å­˜åœ¨â€œç›´æ¥é¢†å–â€æˆ–å¤šæ¨¡å¼åˆ‡æ¢ï¼›æ‰€æœ‰ä»»åŠ¡å…¥é˜Ÿåç”±è°ƒåº¦å™¨ç»Ÿä¸€åˆ†å‘ç»™å·¥ä½œçº¿ç¨‹ã€‚
2. å…¨å±€å…±äº« API Key è´¦æˆ·æ± ï¼šä¸å†æä¾›â€œå…±äº«å• Key å¹¶å‘å¼€å…³â€ï¼Œç³»ç»Ÿå§‹ç»ˆèšåˆæ‰€æœ‰æ¿€æ´»è´¦å·çš„ RPM/TPM è®¡ç®—å®é™…å¯ç”¨æœ‰æ•ˆå®¹é‡ã€‚
3. å®¹é‡ä¸‰å…ƒç»„ä¸é—¨æ§è§„åˆ™ï¼ˆç»Ÿä¸€å•ä½ï¼šè¯·æ±‚/åˆ†é’Ÿ req/minï¼‰ï¼š
  - æœ€å¤§å®¹é‡ï¼š`max_capacity_per_min = api_tpm_total / tokens_per_req`
  - å·²å ç”¨å®¹é‡ï¼š`occupied_capacity_per_min = running_perm_sum`
  - å‰©ä½™å®¹é‡ï¼š`remaining_capacity_per_min = max - occupied`
  - æ”¾è¡Œæ¡ä»¶ï¼ˆä¸¥æ ¼å°äºï¼‰ï¼š`expected_used_capacity = permission` ä¸” `permission < remaining_capacity_per_min`
4. è°ƒåº¦å™¨ä¼°ç®—çº¿ç¨‹æ•°ï¼š`capacity_threads = max_capacity_per_min // worker_req_per_min`ï¼Œå¹¶å‘çº¿ç¨‹å—é™äºå®¹é‡è€Œéè´¦å·æ•°é‡ã€‚
5. è§‚æµ‹æ¥å£ï¼š`GET /api/queue/stats` ä¸ `GET /api/admin/capacity` å…¨éƒ¨åªè¯»ï¼›ä¸æš´éœ²ä»»ä½•â€œåˆ‡æ¢/å¯ç”¨å…±äº«â€ç±»è¯­ä¹‰ã€‚

å·²åˆ é™¤ï¼š`/admin/settings/allow_shared_api_key` ç«¯ç‚¹ä¸å‰ç«¯ç›¸å…³ UIï¼›æ—§è¯·æ±‚å°†æ”¶åˆ° 404ã€‚`ALLOW_SHARED_API_KEY` é”®äº¦å·²ä» `config.json` ç§»é™¤ï¼Œé…ç½®æ–‡ä»¶ä¸­ä¸å†åŒ…å«å…¼å®¹ä¿ç•™å­—æ®µã€‚

å¤±è´¥ç­–ç•¥ï¼šè‹¥ Redis ä¸å¯ç”¨åˆ™è‡ªåŠ¨å›é€€ MySQL è·¯å¾„ï¼›æ‰€æœ‰åªè¯»è§‚æµ‹æ¥å£ä»å¯è¿”å›åŸºæœ¬ backlog ä¸å®¹é‡ä¼°ç®—ï¼ˆå¯èƒ½ä¸º 0ï¼‰ã€‚

### å¦‚ä½•è§‚å¯Ÿ apw:* å˜åŒ–ä¸é—¨æ§æ—¥å¿—ï¼ˆStep9ï¼‰

1) å¯åŠ¨åç«¯å¹¶æ‰“å¼€ç®¡ç†é¢æ¿ï¼š
  - åç«¯æ—¥å¿—ä¼šæ‰“å° scheduler/worker å…³é”®è¡Œï¼›å½“é—¨æ§æ‹’ç»æ—¶å¯è§å½¢å¦‚ï¼š
    `[gate-wait-<uid>] head_task=<id> perm=<p> eff=<e> (condition perm < eff not met)`
  - å½“ä»»åŠ¡å¤„ç†æ—¶ä¼šçœ‹åˆ°ï¼š`[worker-queue-<uid>] Processing task: ... (perm=<p>, eff=<e>)`

2) è§‚æµ‹ Redis é”®ï¼ˆå¦‚ä½¿ç”¨æœ¬åœ° redis-cliï¼‰ï¼š
  - Windows PowerShell ç¤ºä¾‹ï¼ˆè‹¥è®¾ç½®äº† cloud_urlï¼Œè¯·æ›¿æ¢ä¸ºäº‘ç«¯è¿æ¥ä¸²ï¼‰ï¼š
    - `redis-cli -u redis://redis:6379/0 GET apw:max_capacity_per_min`
    - `redis-cli -u redis://redis:6379/0 GET apw:occupied_capacity_per_min`
    - `redis-cli -u redis://redis:6379/0 GET apw:remaining_capacity_per_min`
    - `redis-cli -u redis://redis:6379/0 GET apw:running_perm_sum`
    - `redis-cli -u redis://redis:6379/0 SMEMBERS apw:active_uids`
    - `redis-cli -u redis://redis:6379/0 GET apw:perm_sum_active`
    - `redis-cli -u redis://redis:6379/0 GET apw:tokens_per_req`

3) è§¦å‘æœ€å°ç”¨ä¾‹ï¼ˆHappy path + æ‹’ç»ï¼‰ï¼š
  - å°†æŸç”¨æˆ· permission è°ƒä½ï¼Œç¡®ä¿ `permission < remaining_capacity_per_min`ï¼Œæäº¤æŸ¥è¯¢ååº”å¾ˆå¿«å‡ºé˜Ÿï¼Œæ—¥å¿—å‡ºç° Processingã€‚
  - å°† permission æé«˜åˆ°å¤§äºç­‰äºå‰©ä½™å®¹é‡ï¼Œæäº¤æŸ¥è¯¢åå¯è§å¤šæ¬¡ gate-wait æ—¥å¿—ï¼Œç›´åˆ°å®¹é‡æå‡æˆ–æƒé™é™ä½æ‰å‡ºé˜Ÿã€‚

æç¤ºï¼šè‹¥ Redis ä¸å¯ç”¨ï¼Œä¸Šè¿°é”®å¯èƒ½ä¸å¯è§ï¼›æ­¤æ—¶æœ‰æ•ˆå®¹é‡ç”±å›é€€è·¯å¾„ä¼°ç®—å¹¶å¯ä¸º 0ã€‚

## ä¼šè¯éš”ç¦»ä¿éšœï¼ˆé‡è¦ä¿®å¤ï¼‰

ä¸ºé¿å…åœ¨å…±äº«è´¦æˆ·æ±  + é˜Ÿåˆ—æ¨¡å¼ä¸‹å‡ºç°ä¼šè¯ä¸²æ‰°ï¼Œç³»ç»Ÿåœ¨å‘å¤§æ¨¡å‹å‘èµ·çš„æ¯ä¸€æ¬¡åˆ¤å®šè¯·æ±‚ä¸­éƒ½ä¼šé™„å¸¦ä»¥ä¸‹ä¼šè¯æ ‡è¯†ï¼Œå¹¶è¦æ±‚æ¨¡å‹åœ¨ JSON å“åº”ä¸­åŸæ ·å›æ˜¾ï¼š

- uidï¼šå‘èµ·è¯¥ä»»åŠ¡çš„ç”¨æˆ· ID
- query_indexï¼šè¯¥æ¬¡æ£€ç´¢çš„æŸ¥è¯¢ç´¢å¼•

åç«¯ä¼šè‡ªåŠ¨è§£ææ¨¡å‹è¿”å›çš„ `uid` ä¸ `query_index`ï¼Œå¹¶åœ¨ä¸ä»»åŠ¡æœŸæœ›å€¼ä¸ä¸€è‡´æ—¶åˆ¤å®šä¸ºâ€œä¼šè¯æ ‡è¯†ä¸ä¸€è‡´â€ï¼Œæ”¾å¼ƒå†™å›æœ¬æ¬¡ç»“æœï¼š

- æ•°æ®åº“è·¯å¾„ï¼šå°†ä»»åŠ¡è¿˜åŸä¸ºæœªå¤„ç†çŠ¶æ€ï¼Œç¨åè‡ªåŠ¨é‡è¯•
- é˜Ÿåˆ—è·¯å¾„ï¼šå°†ä»»åŠ¡æ ‡è®°ä¸ºå¤±è´¥ï¼ˆä¿ç•™å¤±è´¥åŸå› ï¼‰ï¼Œä¾¿äºè¿½è¸ª

è¯¥æœºåˆ¶å¯æœ‰æ•ˆé˜²æ­¢ä¸åŒç”¨æˆ·/æŸ¥è¯¢ä¹‹é—´çš„æ•°æ®ä¸²æ‰°ï¼Œä¿éšœä¼šè¯éš”ç¦»ä¸æ•°æ®ä¸€è‡´æ€§ã€‚

## è¿›åº¦éš”ç¦»ä¸æ ¡æ­£ï¼ˆStage4 æ–°å¢ï¼‰

ä¸ºå½»åº•è§£å†³ä¸åŒæŸ¥è¯¢è¿›åº¦ç›¸äº’å¹²æ‰°ä¸æ˜¾ç¤ºè¶…è¿‡ 100% çš„é—®é¢˜ï¼ŒStage4 å¼•å…¥â€œä¼šè¯éš”ç¦»è¿›åº¦æ¡¶ + DB æ ¡æ­£â€çš„æ··åˆæ–¹æ¡ˆï¼š

- è¿›åº¦æ¡¶ï¼šæŒ‰ (uid, query_index) ç»´æŠ¤ processedã€æœ€è¿‘è€—æ—¶çª—å£ timesã€total ç­‰ä¿¡æ¯ï¼›
- DB æ ¡æ­£ï¼šè¿›åº¦ç›‘æ§çº¿ç¨‹æ¯çº¦ 3 ç§’ä»æ•°æ®åº“ç»Ÿè®¡ total/completed è¿›è¡Œå¢é‡æ ¡æ­£ï¼Œå®¹å¿æœåŠ¡é‡å¯/å›æ»šï¼›
- èµ·æ­¢æ—¶é—´ï¼šä»¥ query_log.start_time ä¸ºå‡†ï¼›å…¨éƒ¨å®Œæˆåå†™å…¥ end_timeï¼›
- å®Œæˆå¤„ç†ï¼šåœ¨ `finalize_query_if_done` åˆ¤å®šå®Œæˆæ—¶ä¼šæ‰“å°æœ€ç»ˆç»Ÿè®¡å¹¶é‡Šæ”¾å¯¹åº”æ¡¶ï¼›
- å•å…ƒæµ‹è¯•æ¨¡å¼ï¼š`unit_test_mode=true` æ—¶ï¼Œæ¨¡æ‹Ÿè·¯å¾„ä¹Ÿä¼šå›æ˜¾ `uid` ä¸ `query_index`ï¼Œç¡®ä¿è°ƒç”¨ç­¾åä¸€è‡´ã€‚

å½±å“ä¸æ³¨æ„ï¼š
- API ä¸å‰ç«¯æ— éœ€æ”¹åŠ¨ï¼›
- åç«¯è°ƒç”¨ `update_progress(elapsed, uid, query_index)` æ›´æ–°è¿›åº¦ï¼›
- ç›‘æ§å±‚ä»…æ˜¾ç¤ºå½“å‰èšç„¦çš„ä¼šè¯ï¼ˆdata.current_uid + data.current_query_indexï¼‰ã€‚