# 需要手动操作的事项

## 创建时间: 2025-11-25 17:45
## 最后更新: 2025-11-25 21:10
## 项目: AutoPaperWeb 新架构重构

---

## 一、数据库迁移

### 1.1 执行数据库初始化脚本
```bash
cd DB_tools
python init_database.py --config ../config.json
```

### 1.2 创建初始管理员账户
使用新创建的管理员脚本：
```bash
# 1. 先编辑脚本，修改用户名和密码
# 2. 运行脚本
python DB_tools/create_admin.py
```

---

## 二、配置文件更新

### 2.1 确保config.json包含以下配置
```json
{
  "database": {
    "local": {
      "host": "127.0.0.1",
      "port": 3306,
      "user": "root",
      "password": "your_password",
      "name": "paperdb"
    }
  },
  "redis": {
    "local_url": "redis://apw-redis:6379/0"
  },
  "local_develop_mode": true,
  "unit_test_mode": false
}
```

### 2.2 配置模式说明
- `local_develop_mode`: true=使用本地配置, false=使用云端配置
- `unit_test_mode`: true=AI返回模拟响应（不消耗API额度）

---

## 三、依赖安装

### 3.1 新增Python依赖
确保安装以下包：
- redis
- bcrypt
- mysql-connector-python
- bibtexparser (用于DB_tools)
- openai (用于AI调用)

```bash
pip install redis bcrypt mysql-connector-python bibtexparser openai
# 或使用
python install_requirements.py
```

---

## 四、服务启动顺序

### 4.1 使用Docker Compose（推荐）
```bash
# 启动所有服务（Redis会先启动并健康检查）
docker compose up -d

# 查看状态
docker ps

# 查看日志
docker logs -f apw-backend-1
```

### 4.2 首次启动后执行
1. 执行数据库初始化（如未初始化）
2. 创建管理员账户
3. 等待Redis数据预加载完成（日志会显示进度）

### 4.3 Redis数据手动预加载（如需要）
```python
from lib.redis.init_loader import init_redis_from_mysql
from lib.load_data.db_base import _get_connection

conn = _get_connection()
init_redis_from_mysql(conn, load_papers=True)
conn.close()
```

---

## 五、已删除的废弃文件清单

以下文件已被删除，如果版本控制中仍有残留，请手动清理：

### 5.1 DB_tools目录
- [x] tools_refresh_db_sentence.py (sentence表已废弃)

### 5.2 lib/load_data目录
- [x] app_settings_dao.py (静态配置走config.json)
- [x] task_dao.py (任务队列由Redis接管)
- [x] queue_dao.py (队列管理由Redis模块实现)

### 5.3 lib/process目录
- [x] queue_facade.py
- [x] queue_manager.py
- [x] redis_queue_manager.py
- [x] rate_limiter.py
- [x] rate_limiter_facade.py
- [x] redis_rate_limiter.py
- [x] redis_aggregates.py

### 5.4 lib/html目录
- [x] AutoPaperSearchControlPanelAdmin.html (新版管理页面在admin/目录下)

### 5.5 scripts目录（2025-11-25更新）
- [x] redis_cleanup_active_uids.py (旧架构Redis结构)
- [x] self_check_capacity.py (旧容量计算逻辑)
- [x] self_check.py (依赖旧架构模块)

### 5.6 tests目录（2025-11-25更新）
- [x] test_gate_behavior.py (依赖已删除的worker.gate_permits)
- [x] test_capacity_fifo.py (旧容量队列逻辑)
- [x] test_fairness_multi_user.py (旧架构逻辑)
- [x] test_integration_gate_wait_then_release.py (旧架构逻辑)
- [x] test_remaining_capacity_gate.py (旧架构逻辑)

### 5.7 deploy目录（2025-11-25更新）
- [x] nginx_host.conf (旧多后端配置，已被autopaperweb.conf替代)
- [x] nginx_host_ssl.conf (功能已合并到autopaperweb.conf)

### 5.8 根目录（2025-11-25更新）
- [x] docker-compose.local.yml (已合并到docker-compose.yml)

---

## 六、Docker部署注意事项

### 6.1 Docker Compose结构（已更新）
- `docker-compose.yml` 已整合所有配置
- Redis服务带健康检查，后端容器会等待Redis就绪后再启动
- Redis使用持久化模式（appendonly yes）

### 6.2 清理Redis数据（开发测试用）
```bash
python scripts/clear_redis_data.py
```

### 6.3 部署到云服务器
```bash
# 在服务器上执行
sudo chmod +x /opt/deploy_autopaperweb.sh
sudo /opt/deploy_autopaperweb.sh
```

---

## 七、单元测试

### 7.1 运行综合测试
```bash
python tests/FullTest_20251125_2106.py
```

### 7.2 测试内容
1. MySQL连接测试（本地/云端）
2. Redis连接测试
3. 用户注册/登录API测试
4. 管理员登录API测试
5. 标签/期刊数据加载测试
6. 查询任务创建测试
7. Worker启动测试（unit_test_mode下）
8. 计费扣减测试
9. 结果缓存测试

### 7.3 压力测试
```bash
# 本地测试（5个用户）
python scripts/autopaper_scraper.py --base-url http://localhost:18080 --start-id 1 --end-id 5

# 生产测试（无界面模式）
python scripts/autopaper_scraper.py --start-id 1 --end-id 10 --headless
```

---

## 八、新增脚本说明

### 8.1 DB_tools/create_admin.py
创建管理员账户，修改脚本开头的变量后运行。

### 8.2 scripts/clear_redis_data.py
清除Redis持久化数据，用于开发测试环境重置。

### 8.3 scripts/autopaper_scraper.py
Selenium压力测试工具，支持 `--base-url` 参数指定测试地址。

---

## 九、其他注意事项

1. 首次启动需要较长时间进行Redis数据预加载（取决于文献数量）
2. 管理员初始密码请在首次登录后立即修改
3. 生产环境部署前，请确保：
   - 关闭debug模式
   - 设置强密码
   - 配置HTTPS
   - 设置适当的Redis过期策略
4. 详细文档请参考：
   - `README.md` - 项目说明和快速开始
   - `RefactoryDocs/INTERFACE_SUMMARY.md` - 接口文档
   - `RefactoryDocs/PROGRESS_LOG.md` - 开发日志

---

文档更新日期: 2025-11-25 21:10
