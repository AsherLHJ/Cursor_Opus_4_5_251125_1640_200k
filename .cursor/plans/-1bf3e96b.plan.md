<!-- 1bf3e96b-1e97-428c-954c-84dba5d75861 bec5b039-d525-4867-a5d3-d7c43733bbb0 -->
# 新架构完整重构计划

## 重构概述

本计划将按照"新架构项目重构完整指导文件20251124.txt"的详细指导，对整个项目进行彻底重构。重构分为8个主要阶段，每个阶段完成后会生成阶段检查点文档，确保进度可恢复。

## 阶段检查点与Context Window管理策略

由于重构任务庞大，每个阶段完成后将：

1. 提交Git commit保存进度
2. 在`RefactoryDocs/`目录生成阶段进度文档
3. 生成接口摘要文件，便于新Agent会话重新加载上下文

---

## 阶段一：基础设施准备与文档目录创建

**目标**：创建重构所需的文档目录和基础架构文件

**任务**：

1. 创建`RefactoryDocs/`目录
2. 创建进度跟踪文档`RefactoryDocs/PROGRESS_LOG.md`
3. 创建手动操作事项文档`需要手动操作的事项.txt`
4. 创建阶段总结模板

**关键文件**：

- `RefactoryDocs/PROGRESS_LOG.md` - 进度日志
- `RefactoryDocs/INTERFACE_SUMMARY.md` - 接口摘要（供新会话加载）

---

## 阶段二：DB_tools重构与数据库初始化套件

**目标**：按照指导文件第17章，重构DB_tools为标准化数据库初始化套件

**任务**：

1. 创建新目录结构：`DB_tools/lib/`
2. 实现`DB_tools/lib/db_schema.py` - 定义所有CREATE TABLE SQL
3. 实现`DB_tools/lib/loader_bib.py` - Bib文件解析与导入
4. 实现`DB_tools/lib/loader_tags.py` - 标签与映射导入
5. 实现`DB_tools/lib/loader_api.py` - API Key导入
6. 创建统一入口脚本`DB_tools/init_database.py`
7. 删除废弃脚本：`tools_refresh_db_sentence.py`

**新表定义**（在`db_schema.py`中）：

```sql
-- user_info (保留，增加created_at)
-- admin_info (新增)
-- contentlist (保留)
-- contentlist_year_number (新增)
-- paperinfo (重构为仅DOI, Bib两列)
-- info_tag (保留)
-- info_paper_with_tag (保留)
-- query_log (新结构)
-- search_result (新增，替代动态search_YYYYMMDD)
-- api_list (保留并简化)
```

**废弃表**：

- `sentence` - 彻底移除
- `api_usage_minute` - 彻底移除（流控改为内存滑动窗口）
- `app_settings` - 彻底移除（静态配置走config.json）
- `task_queue` - 彻底移除（任务队列完全由Redis接管）

---

## 阶段三：Redis数据层设计与实现

**目标**：按照指导文件设计实现完整的Redis数据层

**任务**：

1. 创建`lib/redis/`目录作为Redis操作统一模块
2. 实现`lib/redis/connection.py` - Redis连接管理
3. 实现`lib/redis/user_cache.py` - 用户数据缓存

   - `user:{uid}:info` (Hash, TTL 8h)
   - `user:{uid}:balance` (String, TTL 8h)
   - `user:{uid}:history` (ZSet)

4. 实现`lib/redis/system_cache.py` - 系统元数据缓存

   - `sys:tags:info` (Hash)
   - `sys:tag_journals:{Tag}` (Set)
   - `sys:journals:info` (Hash)
   - `sys:journals:price` (Hash)
   - `contentlist_year_number:{Name}` (String/JSON)

5. 实现`lib/redis/paper_blocks.py` - 文献Block存储

   - `meta:{JournalName}:{Year}` (Hash)

6. 实现`lib/redis/task_queue.py` - 任务队列

   - `task:{uid}:{qid}:pending_blocks` (List)
   - `query:{uid}:{qid}:status` (Hash)
   - `query:{uid}:{qid}:pause_signal` (String)

7. 实现`lib/redis/result_cache.py` - 结果缓存

   - `result:{uid}:{qid}` (Hash)

8. 实现`lib/redis/billing.py` - 计费队列

   - `billing_queue:{uid}` (List)

9. 实现`lib/redis/download.py` - 下载队列

   - `download_queue` (List)

10. 实现`lib/redis/admin.py` - 管理员会话

    - `admin:session:{token}` (String)
    - `admin:{uid}:info` (Hash)

11. 实现`lib/redis/init_loader.py` - Redis初始化加载脚本
12. 删除旧模块`lib/process/redis_aggregates.py`

---

## 阶段四：DAO层重构

**目标**：重构数据访问层，适配新的数据库和Redis结构

**任务**：

1. 重构`lib/load_data/user_dao.py`

   - 实现Redis优先、MySQL回源的Lazy Loading策略
   - 实现余额写回MySQL的策略

2. 重构`lib/load_data/journal_dao.py`

   - 从Redis读取期刊和标签数据

3. 重构`lib/load_data/paper_dao.py`

   - 适配新的paperinfo表结构（仅DOI, Bib）

4. 重构`lib/load_data/query_dao.py`

   - 适配新的query_log表结构

5. 重构`lib/load_data/search_dao.py`

   - 适配新的search_result表（替代动态search_YYYYMMDD）

6. 删除废弃DAO：

   - `lib/load_data/app_settings_dao.py` - 删除
   - `lib/load_data/task_dao.py` - 删除（任务队列由Redis接管）
   - `lib/load_data/queue_dao.py` - 删除

---

## 阶段五：Worker与调度器重构

**目标**：按照指导文件规则R1-R6重构Worker和调度器

**任务**：

1. 重构`lib/process/worker.py`

   - 实现任务池+抢占模式
   - 从`task:{uid}:{qid}:pending_blocks`领取Block
   - 检查暂停信号`query:{uid}:{qid}:pause_signal`
   - Block处理：从Redis Block获取Bib，解析构造Prompt
   - 原子扣费（Lua脚本）
   - 结果写入`result:{uid}:{qid}`
   - 进度更新`progress:{uid}:{qid}:finished_count`

2. 重构`lib/process/scheduler.py`

   - 移除旧的容量计算逻辑
   - 实现新的TPM/RPM滑动窗口统计
   - 实现系统资源计算器
   - 实现Worker线程生产器

3. 创建`lib/process/tpm_accumulator.py` - TPM累加器
4. 创建`lib/process/sliding_window.py` - 滑动窗口实现
5. 删除废弃模块：

   - `lib/process/queue_facade.py` - 删除
   - `lib/process/queue_manager.py` - 删除
   - `lib/process/redis_queue_manager.py` - 删除
   - `lib/process/rate_limiter.py` - 删除
   - `lib/process/rate_limiter_facade.py` - 删除
   - `lib/process/redis_rate_limiter.py` - 删除

---

## 阶段六：计费系统重构（Billing System）

**目标**：实现Redis实时扣费+异步流水对账模式

**任务**：

1. 重构`lib/price_calculate/price_calculator.py`

   - 实现Redis实时扣费逻辑
   - 实现消费流水写入`billing_queue:{uid}`

2. 创建`lib/process/billing_syncer.py` - 后台对账线程

   - 扫描`billing_queue:{uid}`
   - 批量同步到MySQL
   - 事务保证：MySQL更新成功后才截断Redis队列

3. 删除旧的计费相关代码

---

## 阶段七：管理员系统实现

**目标**：按照指导文件第16章实现新版管理员系统

**任务**：

1. 实现`lib/load_data/admin_dao.py` - 管理员数据访问
2. 实现`lib/webserver/admin_auth.py` - 管理员鉴权
3. 创建新的管理员前端页面：

   - `lib/html/admin/login.html` - 管理员登录页
   - `lib/html/admin/dashboard.html` - 监控大盘
   - `lib/html/admin/users.html` - 用户管理
   - `lib/html/admin/tasks.html` - 任务管理

4. 实现管理员API：

   - `POST /api/admin/login`
   - `GET /api/admin/dashboard`
   - `GET/POST /api/admin/users`
   - `POST /api/admin/tasks/terminate`

5. 删除旧管理页面`lib/html/AutoPaperSearchControlPanelAdmin.html`

---

## 阶段八：API层与前端适配

**目标**：重构server.py API层，适配新架构

**任务**：

1. 重构`lib/webserver/server.py`

   - 移除废弃API端点
   - 实现新的API端点
   - 实现下载队列机制

2. 重构`lib/webserver/auth.py`

   - 适配Redis用户缓存

3. 更新前端页面适配新API：

   - `lib/html/index.html`
   - `lib/html/login.html`
   - `lib/html/history.html`
   - `lib/html/distill.html`
   - `lib/html/billing.html`

4. 删除废弃功能：

   - 删除历史记录功能（`delete_history` API）
   - 删除`/api/random_sentences`（sentence表废弃）

---

## 阶段九：蒸馏任务重构

**目标**：按照指导文件第14章重构蒸馏任务

**任务**：

1. 更新蒸馏任务队列结构

   - 使用`distill_chunk:{uid}:{qid}:{chunk_id}`

2. 更新Worker识别蒸馏任务
3. 实现0.1倍费率扣费

---

## 阶段十：清理与测试准备

**目标**：清理所有旧架构冗余代码，准备测试

**任务**：

1. 删除所有废弃文件
2. 删除所有废弃变量和参数
3. 更新`config.json`移除废弃配置
4. 更新`docker-compose.yml`和`docker-compose.local.yml`
5. 更新部署文档
6. 生成最终接口文档

**待删除文件清单**：

- `lib/load_data/app_settings_dao.py`
- `lib/load_data/task_dao.py`
- `lib/load_data/queue_dao.py`
- `lib/process/queue_facade.py`
- `lib/process/queue_manager.py`
- `lib/process/redis_queue_manager.py`
- `lib/process/rate_limiter.py`
- `lib/process/rate_limiter_facade.py`
- `lib/process/redis_rate_limiter.py`
- `lib/process/redis_aggregates.py`
- `lib/html/AutoPaperSearchControlPanelAdmin.html`
- `DB_tools/tools_refresh_db_sentence.py`
- 根目录下的冗余脚本

---

## 执行时间估算

| 阶段 | 预计时间 | 说明 |

|------|----------|------|

| 阶段一 | 5分钟 | 创建目录和文档 |

| 阶段二 | 30分钟 | DB_tools重构 |

| 阶段三 | 45分钟 | Redis数据层 |

| 阶段四 | 30分钟 | DAO层重构 |

| 阶段五 | 45分钟 | Worker/调度器 |

| 阶段六 | 20分钟 | 计费系统 |

| 阶段七 | 30分钟 | 管理员系统 |

| 阶段八 | 30分钟 | API/前端 |

| 阶段九 | 15分钟 | 蒸馏任务 |

| 阶段十 | 20分钟 | 清理与文档 |

**总计**：约4-5小时

---

## 阶段检查点文档格式

每个阶段完成后在`RefactoryDocs/`生成：

```
RefactoryDocs/
├── PROGRESS_LOG.md              # 进度日志
├── INTERFACE_SUMMARY.md         # 接口摘要（供新会话）
├── Stage1_Complete_YYYYMMDD_HHMM.md
├── Stage2_Complete_YYYYMMDD_HHMM.md
├── ...
└── MANUAL_STEPS.md              # 需要人工操作的步骤
```

---

## 新Agent会话恢复流程

若当前会话Context Window耗尽：

1. 用户在新会话中提供：`@RefactoryDocs/INTERFACE_SUMMARY.md`
2. Agent读取该文档了解已完成阶段和当前进度
3. 从检查点继续执行

### To-dos

- [ ] 阶段一：创建RefactoryDocs目录和进度跟踪文档
- [ ] 阶段二：重构DB_tools为标准化数据库初始化套件
- [ ] 阶段三：实现完整的Redis数据层模块
- [ ] 阶段四：重构DAO层适配新数据库和Redis结构
- [ ] 阶段五：重构Worker和调度器（任务池+抢占模式）
- [ ] 阶段六：实现新计费系统（Redis扣费+异步对账）
- [ ] 阶段七：实现新版管理员系统
- [ ] 阶段八：重构API层和前端适配
- [ ] 阶段九：重构蒸馏任务流程
- [ ] 阶段十：清理废弃代码和生成最终文档