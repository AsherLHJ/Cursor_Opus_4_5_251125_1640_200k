sequenceDiagram
    autonumber
    actor User as User (用户)
    participant Server as Server (Web/Worker)
    participant Redis as Redis (Cache/Queue)
    participant MySQL as MySQL (DB)
    participant AI as AI API (VolcEngine)

    Note over User, MySQL: === 1. 用户登录与初始化 (修复37: Token认证) ===
    User->>Server: 访问主页 / 登录 (Login)
    Server->>Redis: GET user:{uid}:info (尝试读取用户信息缓存)
    alt Redis缓存未命中 (Cache Miss)
        Server->>MySQL: SELECT * FROM user_info WHERE username=...
        MySQL-->>Server: 返回用户信息
        Server->>Redis: SET user:{uid}:info (写入用户信息, TTL 8h)
        Server->>Redis: SET user:{uid}:balance (写入余额, TTL 8h)
    else Redis缓存命中 (Cache Hit)
        Redis-->>Server: 返回用户信息
    end
    Server->>Server: 生成安全随机Token (secrets.token_urlsafe)
    Server->>Redis: SET user:session:{token} {uid} (创建用户会话, TTL 24h)
    Server-->>User: 登录成功 (返回Token + uid)
    Note right of User: 前端保存token到localStorage<br/>后续所有API请求携带Authorization头

    Note over User, MySQL: === 1.5 公告栏与维护模式检查 (修复35) ===
    User->>Server: 访问主页 (带Authorization: Bearer {token})
    Server->>Redis: GET sys:config:maintenance_mode
    alt 维护模式开启
        Server-->>User: 重定向到 /maintenance.html
    else 正常访问
        Server->>Redis: GET sys:config:announcement_enabled
        alt 公告栏开启
            Server->>Redis: GET sys:config:announcement_content
            Server-->>User: 返回页面 + 公告内容 (顶部横幅)
        else 公告栏关闭
            Server-->>User: 返回正常页面
        end
    end

    Note over User, MySQL: === 2. 加载主页数据 (需Token认证) ===
    User->>Server: 获取主页数据 (Authorization: Bearer {token})
    Server->>Redis: GET user:session:{token} (验证Token)
    alt Token无效/过期
        Server-->>User: 401 Unauthorized
    else Token有效 -> 获取uid
        par 获取余额
            Server->>Redis: GET user:{uid}:balance
        and 获取历史记录
            Server->>Redis: ZREVRANGE user:{uid}:history (获取最近任务ID)
            Server->>Redis: HGETALL query:{uid}:{qid}:info (获取任务详情)
        and 获取学科标签
            Server->>Redis: HGETALL sys:tags:info (获取标签列表)
        end
        Server-->>User: 返回主页渲染数据
    end

    Note over User, MySQL: === 3. 提交查询任务 (修复36: 语言适配) ===
    User->>Server: 选择标签 -> 获取期刊列表
    Server->>Redis: SMEMBERS sys:tag_journals:{Tag} (根据标签查期刊)
    Redis-->>Server: 返回期刊列表
    Server-->>User: 展示期刊列表

    User->>Server: 选中期刊 + 年份范围 -> 点击"更新统计"
    Server->>Redis: HGET sys:journals:price (获取单价)
    Server->>Redis: HGET contentlist_year_number {JournalName} (获取该刊各年份文献数)
    Server-->>User: 返回估算费用与文献总数

    User->>Server: 点击"开始检索" (含 language='zh'/'en')
    Note right of Server: search_params 包含 language 字段<br/>用于AI回复语言控制
    Server->>Redis: GET user:session:{token} (验证Token获取uid)
    Server->>Redis: GET user:{uid}:balance (验证余额)
    Server->>Redis: HSET query:{uid}:{qid}:status (初始化任务状态, total_blocks)
    Server->>Redis: RPUSH task:{uid}:{qid}:pending_blocks (将任务拆解为Block Keys入队)
    Note right of Server: Block Key 示例: meta:NATURE:2024
    
    Server->>Server: 检查用户Permission -> 启动对应数量 Worker线程

    Note over Server, AI: === 4. 任务执行循环 (修复36: AI语言适配) ===
    loop Every Worker Thread
        Server->>Redis: LPOP task:{uid}:{qid}:pending_blocks (抢占任务Block)
        
        alt 队列为空
            Server->>Server: Worker线程退出
        else 成功取到 Block Key
            Server->>Redis: GET query:{uid}:{qid}:terminate_signal (检查终止信号)
            alt 收到终止信号
                Server->>Server: Worker线程立即销毁 (不推回Block)
            else 检查暂停信号
                Server->>Redis: GET query:{uid}:{qid}:pause_signal
                alt 收到暂停信号
                    Server->>Redis: LPUSH task:{uid}:{qid}:pending_blocks (任务回退到队列头)
                    Server->>Server: Worker线程立即销毁
                else 正常执行
                    Server->>Redis: HGETALL {BlockKey} (一次性拉取该年份所有文献DOI和压缩Bib)
                    Redis-->>Server: 返回 DOIs + Bib Strings
                    
                    loop Block内每一篇文献
                        Server->>Server: 解析 Bib -> 提取摘要 -> 构造 Prompt
                        Server->>Server: 读取 search_params.language
                        Server->>Server: LANGUAGE_MAP: zh→中文, en→English
                        Server->>Server: 替换 system_prompt 中 {language} 占位符
                        Server->>AI: 发送请求 (Prompt含语言指令)
                        AI-->>Server: 返回分析结果 (按指定语言) + Token Usage
                        
                        Server->>Server: 累加 Token 到 TPM统计器
                        
                        Server->>Redis: GET user:{uid}:balance (检查余额)
                        alt 余额充足
                            Server->>Redis: DECRBY user:{uid}:balance (原子扣费)
                            Server->>Redis: HSET result:{uid}:{qid} (存储AI结果)
                            Server->>Redis: RPUSH billing_queue:{uid} (写入流水队列, 用于异步对账)
                            Server->>Redis: HINCRBY progress:{uid}:{qid}:finished_count (更新进度条)
                        else 余额不足
                            Server->>Server: 标记跳过/失败
                        end
                    end

                    Server->>Redis: HINCRBY query:{uid}:{qid}:status finished_blocks 1 (Block完成计数)
                    
                    Server->>Redis: GET query:{uid}:{qid}:terminate_signal (再次检查终止)
                    Server->>Redis: GET query:{uid}:{qid}:pause_signal (再次检查暂停)
                    alt 收到终止/暂停信号
                        Server->>Server: 不标记完成,Worker退出
                    else 正常判定
                        Server->>Redis: HGET query:{uid}:{qid}:status
                        alt finished_blocks == total_blocks (任务全部完成)
                            Server->>Redis: HSET query:{uid}:{qid}:status state=DONE
                            Server->>Server: 触发结果归档 (Redis -> MySQL)
                        end
                    end
                end
            end
        end
    end

    Note over Server, MySQL: === 5. 计费同步 (Billing Sync) ===
    loop 后台 BillingSyncer 线程 (1秒/2000条)
        Server->>Redis: LPOP billing_queue:{uid} (批量取出消费流水)
        Server->>MySQL: UPDATE user_info SET balance = balance - total WHERE uid=... (批量更新数据库)
    end

    Note over User, AI: === 6. 蒸馏任务 (修复29-31: 蒸馏专用Block) ===
    User->>Server: 对任务QID发起"蒸馏" (含 language='zh'/'en')
    Server->>Redis: GET user:session:{token} (验证Token获取uid)
    Server->>Redis: HGETALL result:{uid}:{parent_qid} (读取父任务结果)
    alt Redis缓存命中
        Server->>Server: 筛选 search_result=Y 的文献 -> 获取相关DOI列表
    else Redis MISS (超过7天TTL)
        Server->>MySQL: SELECT doi, ai_result FROM search_result WHERE query_id=...
        MySQL-->>Server: 返回归档的结果数据
        Server->>Server: 筛选"相符"文献 -> 获取相关DOI列表
    end
    
    Note right of Server: 创建蒸馏专用Block (修复29-31)
    Server->>Redis: HGETALL sys:journals:price (获取所有期刊价格)
    Server->>Redis: HMGET idx:doi_to_block {DOI1} {DOI2}... (批量获取DOI对应的block_key)
    Server->>Redis: Pipeline HGET {block_key} {DOI} (批量获取Bib数据)
    
    loop 每100个相关DOI创建一个蒸馏Block
        Server->>Server: 构建Block数据: {DOI: {"bib": bib_str, "price": price}}
        Server->>Redis: HSET distill:{uid}:{qid}:{index} (存储蒸馏专用Block, TTL 7天)
    end
    
    Server->>Redis: RPUSH task:{uid}:{qid}:pending_blocks distill:{uid}:{qid}:0, distill:{uid}:{qid}:1...
    Server->>Server: 启动 DistillWorker (数量=min(permission, block数量))
    
    loop Distill Worker
        Server->>Redis: LPOP task:{uid}:{qid}:pending_blocks (取蒸馏Block)
        Server->>Redis: HGETALL distill:{uid}:{qid}:{index} (获取Block数据含价格)
        loop Block内每个DOI
            Server->>Server: 解析JSON获取bib和price
            Server->>Server: 替换 system_prompt 中 {language} 占位符
            Server->>AI: 发送蒸馏 Prompt
            AI-->>Server: 返回深度分析
            Server->>Redis: 存结果 + 扣费 (price × 蒸馏系数)
            Note right of Server: 蒸馏系数从sys:config:distill_rate获取
        end
    end

    Note over User, Server: === 7. 结果下载 (修复36-37+40: 异步队列+Token验证+MySQL回源) ===
    User->>Server: 点击"下载CSV" / "下载Bib" (Authorization: Bearer {token})
    Server->>Redis: GET user:session:{token} (验证Token获取uid)
    alt Token无效
        Server-->>User: 401 Unauthorized
    else Token有效
        Server->>Redis: 创建任务 HSET download:{task_id}:status (state=PENDING, language=zh/en)
        Server->>Redis: RPUSH download_queue {task_id, uid, qid, type, language}
        Server-->>User: 立即返回 task_id (<100ms)
    end
    
    par 前端轮询状态
        loop 每秒轮询
            User->>Server: GET /api/download/status?task_id=xxx (带Token)
            Server->>Redis: GET user:session:{token} (验证Token)
            Server->>Redis: HGET download:{task_id}:status
            alt 任务归属验证 (status.uid == uid)
                Redis-->>Server: 返回状态 (PENDING/PROCESSING/READY)
                Server-->>User: 返回当前状态
            else uid不匹配
                Server-->>User: 403 Forbidden
            end
        end
    and DownloadWorker处理 (10个Worker并发)
        loop DownloadWorker Pool
            Server->>Redis: LPOP download_queue (抢占任务)
            Server->>Redis: HSET download:{task_id}:status state=PROCESSING
            
            Note right of Server: 修复40: search_dao.get_all_results()
            Server->>Redis: HGETALL result:{uid}:{qid} (获取AI结果)
            alt Redis缓存命中
                Redis-->>Server: 返回缓存结果
            else Redis MISS (7天TTL过期或数据清空)
                Server->>MySQL: SELECT doi, ai_result FROM search_result WHERE query_id=...
                MySQL-->>Server: 返回归档的结果数据
                Server->>Redis: HMGET idx:doi_to_block {DOI1} {DOI2}... (批量获取block_key)
                Redis-->>Server: 返回DOI对应的block_key
                Server->>Server: 组装完整结果 {doi: {ai_result, block_key}}
            end
            
            Note right of Server: Pipeline批量获取Bib优化
            Server->>Redis: Pipeline HGETALL {BlockKey1}, HGETALL {BlockKey2}... (批量获取Bib)
            Redis-->>Server: 返回所有Bib数据 (O(1)网络往返)
            Server->>Server: 按相关性排序 (Y在前, N在后)
            Server->>Server: Is_Relevant列本地化: zh→符合/不符, en→Relevant/Irrelevant
            Server->>Server: 内存生成 CSV / Bib 文件 (BIB无头信息)
            Server->>Redis: SET download:{task_id}:file (存储文件, TTL 5分钟)
            Server->>Redis: HSET download:{task_id}:status state=READY
        end
    end
    
    User->>Server: GET /api/download/file?task_id=xxx&token=xxx (状态为READY后)
    Note right of Server: 文件下载支持URL参数传Token(浏览器跳转无法设header)
    Server->>Redis: GET user:session:{token} (验证Token)
    Server->>Redis: HGET download:{task_id}:status (验证任务归属)
    Server->>Redis: GET download:{task_id}:file
    Server-->>User: 返回文件流 (Content-Disposition)

    Note over User, Server: === 8. API请求Token认证通用流程 (修复37) ===
    User->>Server: 任意需认证API请求 (Authorization: Bearer {token})
    Server->>Server: 从Authorization头提取Token
    Server->>Redis: GET user:session:{token}
    alt Token存在且有效
        Server->>Redis: EXPIRE user:session:{token} (刷新TTL)
        Server->>Server: 解析出uid，继续处理业务逻辑
    else Token无效/过期/不存在
        Server-->>User: 401 Unauthorized {"error": "Invalid or expired token"}
    end
    Note right of Server: 受保护端点: 除login/register/tags/journals/count_papers/<br/>registration_status/system_announcement/maintenance_status外<br/>所有/api/*端点都需要Token认证
