classDiagram
    direction TB

    %% ==========================================
    %% MySQL Database Structure (Persistent Store)
    %% ==========================================
    namespace MySQL {
        class UserInfo {
            +int uid (PK)
            +varchar username
            +varchar password
            +decimal balance
            +int permission
            +datetime created_at
        }
        
        class AdminInfo {
            +int uid (PK)
            +varchar username
            +varchar password
            +varchar role
        }

        class ApiList {
            +int api_index (PK)
            +varchar api_key
            +varchar api_name
            +int rpm_limit
            +bigint tpm_limit
            +tinyint is_active
        }

        class ContentList {
            +varchar Name (PK)
            +text FullName
            +text DataRange
            +int Price
            +datetime UpdateDate
        }
        
        class ContentListYearNumber {
            +varchar Name (PK)
            +text YearNumberJson
        }

        class PaperInfo {
            +varchar DOI (PK)
            +json Bib
        }

        class InfoTag {
            +varchar tag (PK)
            +varchar tagtype
        }

        class InfoPaperWithTag {
            +int id (PK)
            +varchar Name (FK)
            +varchar Tag (FK)
        }

        class SearchResult {
            +int id (PK)
            +int uid
            +varchar query_id
            +varchar doi
            +json ai_result
            +datetime created_at
        }
        
        class QueryLog {
            +varchar query_id (PK)
            +int uid
            +text search_params
            +datetime start_time
            +datetime end_time
            +varchar status
        }

        class SystemSettings {
            +varchar setting_key (PK)
            +text setting_value
            +datetime updated_at
            Note: 系统配置持久化存储
            Note: 包含permission_min/max
            Note: distill_rate蒸馏系数
            Note: registration_enabled注册开关
            Note: debug_console_enabled调试开关
            Note: announcement_enabled公告栏开关
            Note: announcement_content公告内容
            Note: maintenance_mode维护模式
            Note: maintenance_message维护公告
        }
    }

    %% ==========================================
    %% Redis Data Structure (Cache & Hot Data)
    %% ==========================================
    namespace Redis {
        %% --- User Data ---
        class UserInfoCache {
            Key: user:<uid>:info
            Type: Hash
            Fields: username, permission
            TTL: 8h
        }
        class UserBalance {
            Key: user:<uid>:balance
            Type: String/Hash
            Value: decimal_amount
            TTL: 8h
        }
        class UserHistory {
            Key: user:<uid>:history
            Type: ZSet
            Member: query_id
            Score: timestamp
        }
        class UserSession {
            Key: user:session:<token>
            Type: String
            Value: uid
            TTL: 24h
            Note: 用户登录Token映射(修复37)
        }

        %% --- Admin Data ---
        class AdminSession {
            Key: admin:session:<token>
            Type: String
            Value: uid
            TTL: SessionTime
        }
        class AdminCache {
            Key: admin:<uid>:info
            Type: Hash
            Fields: username, role
            TTL: 8h
        }

        %% --- System Metadata (Preloaded) ---
        class JournalInfo {
            Key: sys:journals:info
            Type: Hash
            Field: Name
            Value: JSON(FullName, DataRange)
        }
        class JournalPrice {
            Key: sys:journals:price
            Type: Hash
            Field: Name
            Value: Integer
        }
        class TagInfo {
            Key: sys:tags:info
            Type: Hash
            Field: TagName
            Value: Type
        }
        class TagIndex {
            Key: sys:tag_journals:<Tag>
            Type: Set
            Members: JournalName[]
        }
        class PaperBlock {
            Key: meta:<JournalName>:<Year>
            Type: Hash
            Field: DOI
            Value: Compressed_Bib_String
            TTL: 永不过期
        }
        class DOIIndex {
            Key: idx:doi_to_block
            Type: Hash
            Field: DOI
            Value: block_key
            Note: DOI反向索引O(1)查询(修复26)
        }
        class SystemConfig {
            Key: sys:config:<key>
            Type: String
            Value: config_value
            Note: 系统配置Redis缓存
        }

        %% --- Task & Queue ---
        class TaskQueue {
            Key: task:<uid>:<qid>:pending_blocks
            Type: List
            Value: BlockKey (meta:... 或 distill:...)
        }
        class QueryStatus {
            Key: query:<uid>:<qid>:status
            Type: Hash
            Fields: total_blocks, finished_blocks, state
        }
        class QueryResultCache {
            Key: result:<uid>:<qid>
            Type: Hash
            Field: DOI
            Value: JSON_Result
            TTL: 7天
            Note: 过期后蒸馏/下载回源MySQL(修复40)
        }
        class PauseSignal {
            Key: query:<uid>:<qid>:pause_signal
            Type: String
            Value: "1"
            Note: 暂停信号(可恢复)
        }
        class TerminateSignal {
            Key: query:<uid>:<qid>:terminate_signal
            Type: String
            Value: "1"
            TTL: 7天
            Note: 终止信号(优先级高于暂停,不可恢复)
        }

        %% --- Distillation (修复29-31) ---
        class DistillBlock {
            Key: distill:<uid>:<qid>:<index>
            Type: Hash
            Field: DOI
            Value: JSON(bib, price)
            TTL: 7天
            Note: 蒸馏任务专用Block
        }

        %% --- Billing & Monitoring ---
        class BillingQueue {
            Key: billing_queue:<uid>
            Type: List
            Value: (ts, qid, doi, cost)
        }
        class DownloadQueue {
            Key: download_queue
            Type: List
            Value: (task_id, uid, qid, type, timestamp)
        }
        class DownloadTaskStatus {
            Key: download:<task_id>:status
            Type: Hash
            Fields: state, uid, qid, type, created_at, language
            Note: state=PENDING/PROCESSING/READY/FAILED
        }
        class DownloadTaskFile {
            Key: download:<task_id>:file
            Type: String
            Value: Generated_File_Content
            TTL: 5min
        }
    }

    %% ==========================================
    %% Relationships & Data Flow
    %% ==========================================

    %% 1. Initialization / Static Data Sync
    ContentList ..> JournalInfo : Preload Script\n(MySQL -> Redis)
    ContentList ..> JournalPrice : Preload Script
    InfoTag ..> TagInfo : Preload Script
    InfoPaperWithTag ..> TagIndex : Preload Script
    PaperInfo ..> PaperBlock : Preload Script\n(Full Load)
    PaperInfo ..> DOIIndex : Preload Script\n(Build Index)
    ContentListYearNumber ..> JournalInfo : Preload Script
    SystemSettings ..> SystemConfig : Preload Script\n(MySQL -> Redis)

    %% 2. User Authentication & Lazy Loading
    UserInfo "1" -- "0..1" UserInfoCache : Lazy Load (Read Miss)\nWrite Behind (Update)
    UserInfo "1" -- "0..1" UserBalance : Lazy Load (Read Miss)\nWrite Behind (Update)
    UserInfo ..> UserSession : Login Create Token\n(修复37)

    %% 3. Admin Authentication
    AdminInfo ..> AdminSession : Login Create
    AdminInfo ..> AdminCache : Cache Hot Data

    %% 4. Billing Flow (Async)
    UserBalance ..> BillingQueue : Worker Decr Balance\nPush Log
    BillingQueue ..> UserInfo : BillingSyncer Thread\n(Async Batch Update)

    %% 5. Task Execution Flow
    TaskQueue ..> PaperBlock : Worker Reads Data
    TaskQueue ..> DistillBlock : Distill Worker Reads Data
    PaperBlock ..> QueryResultCache : Worker Computes & Writes
    DistillBlock ..> QueryResultCache : Distill Worker Writes
    QueryResultCache ..> SearchResult : Archiver Thread\n(Async Archive DONE)
    QueryStatus ..> QueryLog : Archiver Thread\n(Update Status)
    DOIIndex ..> PaperBlock : O(1) Lookup\n(修复26)

    %% 6. Download Flow (Async Queue, 修复40: MySQL回源)
    DownloadQueue ..> DownloadTaskStatus : DownloadWorker\n(Update Status)
    QueryResultCache ..> DownloadTaskFile : DownloadWorker\n(Generate File)
    SearchResult ..> DownloadTaskFile : DownloadWorker\n(MySQL Fallback 修复40)
    PaperBlock ..> DownloadTaskFile : DownloadWorker\n(Pipeline Batch Get)
    DOIIndex ..> DownloadTaskFile : DownloadWorker\n(Get block_key 修复40)

    %% 7. Foreign Keys / Logical Links
    InfoPaperWithTag --> ContentList : FK Name
    InfoPaperWithTag --> InfoTag : FK Tag
    SearchResult --> UserInfo : FK uid
    QueryLog --> UserInfo : FK uid
