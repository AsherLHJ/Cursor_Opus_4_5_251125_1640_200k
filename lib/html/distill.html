<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="distill.title">AutoPaperWeb è’¸é¦æ£€ç´¢</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
      color: white;
      padding: 30px;
      position: relative;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin: 0;
    }

    .user-info {
      position: absolute;
      top: 20px;
      right: 30px;
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 16px;
      border-radius: 25px;
      font-size: 14px;
      backdrop-filter: blur(10px);
    }

    .user-info a {
      color: white;
      text-decoration: none;
      margin-left: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .user-info a:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .content {
      padding: 40px;
    }

    .form-section {
      margin-bottom: 32px;
    }

    .form-section h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #555;
      font-weight: 500;
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .original-info-section {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 32px;
      border-left: 4px solid #ff6b6b;
    }

    .original-info-section h3 {
      color: #ff6b6b;
      margin-bottom: 16px;
    }

    .info-item {
      margin-bottom: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 4px;
    }

    .info-value {
      color: #6c757d;
      font-size: 14px;
      line-height: 1.5;
    }

    .action-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      padding: 24px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status {
      font-size: 16px;
      font-weight: 600;
      color: #28a745;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-icon {
      width: 20px;
      height: 20px;
      background: #28a745;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .user-info {
        position: static;
        margin-top: 16px;
        text-align: center;
      }

      .action-section {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 data-i18n="distill.title">ğŸ”¬ AutoPaperWeb è’¸é¦æ£€ç´¢</h1>
      <div class="user-info">
        <span id="userWelcome">æ¬¢è¿ï¼Œæ¸¸å®¢</span>
        <a href="billing.html" data-i18n="common.billing">æ£€ç´¢è´¦å•</a>
        <a href="history.html" id="historyBtn" data-i18n="distill.view_history">æŸ¥çœ‹å†å²</a>
        <a href="index.html" id="homeBtn" data-i18n="distill.back_home">è¿”å›é¦–é¡µ</a>
        <a href="#" id="logoutBtn" data-i18n="common.logout">é€€å‡ºç™»å½•</a>
      </div>
    </div>

    <div class="content">
      <div class="original-info-section">
        <h3 data-i18n="distill.original_info">ğŸ“‹ åŸå§‹æŸ¥è¯¢ä¿¡æ¯</h3>
        <div id="originalInfo">
          <div style="text-align: center; color: #666; padding: 20px;">
            <span data-i18n="distill.loading_original">æ­£åœ¨åŠ è½½åŸå§‹æŸ¥è¯¢ä¿¡æ¯...</span>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 data-i18n="distill.new_config">ğŸ” æ–°çš„ç ”ç©¶é…ç½®</h3>
        <div class="form-group">
          <label for="question" data-i18n="distill.new_question">æ–°çš„ç ”ç©¶é—®é¢˜</label>
          <textarea id="question" data-i18n-placeholder="distill.new_question_ph" placeholder="è¯·è¾“å…¥æ–°çš„ç ”ç©¶é—®é¢˜ï¼Œå°†åŸºäºåŸå§‹æŸ¥è¯¢çš„ç›¸å…³ç»“æœè¿›è¡Œè’¸é¦æ£€ç´¢"></textarea>
        </div>

        <div class="form-group">
          <label for="requirements" data-i18n="distill.new_req">æ–°çš„ç ”ç©¶è¦æ±‚</label>
          <textarea id="requirements" data-i18n-placeholder="distill.new_req_ph" placeholder="è¯·è¾“å…¥æ–°çš„å…·ä½“è¦æ±‚ï¼Œä¾‹å¦‚ï¼šé‡ç‚¹å…³æ³¨æœ€æ–°æ–¹æ³•ã€ç‰¹å®šåº”ç”¨åœºæ™¯ç­‰"></textarea>
        </div>
      </div>

      <div class="action-section">
        <button id="startDistillBtn" class="btn-primary">
          <div class="loading" id="loadingSpinner"></div>
          <span id="btnText" data-i18n="distill.start">ğŸš€ å¼€å§‹è’¸é¦</span>
        </button>
        <div id="status" class="status">
          <div class="status-icon">ğŸ”¬</div>
          <span id="statusText" data-i18n="distill.status_ready">å‡†å¤‡å¼€å§‹è’¸é¦æ£€ç´¢</span>
        </div>
        <!-- æ–°å¢ï¼šè´¹ç”¨ä¸æ•°é‡æ˜¾ç¤º -->
        <div id="distillCountStatus" class="status" style="display:none;">
          <div class="status-icon">ğŸ“„</div>
          <span id="distillCountText"></span>
        </div>
        <div id="distillCostStatus" class="status" style="display:none;">
          <div class="status-icon">ğŸ’³</div>
          <span id="distillCostText"></span>
        </div>
      </div>

      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>
    </div>
  </div>

  <script src="/static/js/i18n.js"></script>
  <script>
    // æ–°æ¶æ„ä¿®å¤ï¼šä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹çš„ originalQueryId
    let originalQueryId = null;

    // å·¥å…·å‡½æ•°
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function setLoading(isLoading) {
      const btn = document.getElementById('startDistillBtn');
      const spinner = document.getElementById('loadingSpinner');
      const btnText = document.getElementById('btnText');
      
      if (isLoading) {
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        btnText.textContent = i18n.t('distill.starting');
      } else {
        btn.disabled = false;
        spinner.style.display = 'none';
        btnText.textContent = i18n.t('distill.start');
      }
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function updateWelcome(){
      const username = localStorage.getItem('username');
      const el = document.getElementById('userWelcome');
      if (username) {
        el.textContent = (i18n.getLang()==='zh'?'æ¬¢è¿ï¼Œ':'Welcome, ') + username;
      } else {
        el.textContent = (i18n.getLang()==='zh'?'æ¬¢è¿ï¼Œæ¸¸å®¢':'Welcome, Guest');
      }
    }
    window.apw_afterLangChange = function(){ updateWelcome(); };

    function checkLogin() {
      const token = localStorage.getItem('userToken');
      const username = localStorage.getItem('username');
      
      if (!token || !username) {
        window.location.href = '/login.html';
        return false;
      }
      updateWelcome();
      return true;
    }

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('userToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      window.location.href = '/login.html';
    });

    // è·å–URLå‚æ•°
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // åŠ è½½åŸå§‹æŸ¥è¯¢ä¿¡æ¯
    async function loadOriginalQueryInfo() {
      // æ–°æ¶æ„ä¿®å¤ï¼šåŒæ—¶æ”¯æŒ query_index å’Œ query_id å‚æ•°ï¼Œä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹
      const queryId = getUrlParameter('query_index') || getUrlParameter('query_id');
      if (!queryId) {
        showError(i18n.t('distill.err_missing_qid'));
        return;
      }

      const uid = localStorage.getItem('userId');
      if (!uid) {
        showError(i18n.t('distill.err_user_missing'));
        window.location.href = '/login.html';
        return;
      }

      // ä¿æŒå­—ç¬¦ä¸²ç±»å‹ï¼ˆæ–°æ¶æ„æ ¼å¼å¦‚ Q20251127102812_74137bb4ï¼‰
      originalQueryId = queryId;
      
      try {
        const res = await fetch(`/api/get_query_info?query_id=${encodeURIComponent(queryId)}&uid=${encodeURIComponent(uid)}`);
        if (!res.ok) {
          throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${res.status}`);
        }

        const data = await res.json();
        if (!data.success) {
          if (data.error === 'access_denied') {
            throw new Error('access denied');
          }
          throw new Error(data.message || 'è·å–æŸ¥è¯¢ä¿¡æ¯å¤±è´¥');
        }

        const info = data.query_info;
        displayOriginalInfo(info);
        updateStatus(info);
        
      } catch (e) {
        console.error('åŠ è½½åŸå§‹æŸ¥è¯¢ä¿¡æ¯å¤±è´¥', e);
        showError(i18n.t('distill.load_original_failed', { msg: e.message }));
      }
    }

    // æ˜¾ç¤ºåŸå§‹æŸ¥è¯¢ä¿¡æ¯
    function displayOriginalInfo(info) {
      const container = document.getElementById('originalInfo');
      container.innerHTML = '';

      const items = [
        { label: (i18n.getLang()==='zh'?'åŸå§‹ç ”ç©¶é—®é¢˜':'Original Question'), value: info.research_question || (i18n.getLang()==='zh'?'æ— ':'none') },
        { label: (i18n.getLang()==='zh'?'åŸå§‹æŸ¥è¯¢æ—¶é—´':'Original Time'), value: info.query_time || (i18n.getLang()==='zh'?'æ— ':'none') },
        { label: (i18n.getLang()==='zh'?'æ•°æ®èŒƒå›´':'Sources'), value: info.selected_folders || (i18n.getLang()==='zh'?'æ— ':'none') },
        { label: (i18n.getLang()==='zh'?'æ—¶é—´èŒƒå›´':'Range'), value: info.year_range || (i18n.getLang()==='zh'?'æ— ':'none') },
        { label: (i18n.getLang()==='zh'?'åŸå§‹è¦æ±‚':'Original Requirements'), value: info.requirements || (i18n.getLang()==='zh'?'æ— ç‰¹æ®Šè¦æ±‚':'none') }
      ];

      items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'info-item';
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'info-label';
        labelDiv.textContent = item.label;
        
        const valueDiv = document.createElement('div');
        valueDiv.className = 'info-value';
        valueDiv.textContent = item.value;
        
        itemDiv.appendChild(labelDiv);
        itemDiv.appendChild(valueDiv);
        container.appendChild(itemDiv);
      });
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(info) {
      const statusText = document.getElementById('statusText');
      statusText.textContent = i18n.t('distill.status_desc');
      // åŠ è½½é¢„è®¡è´¹ç”¨
      estimateDistillationCost();
    }

    async function estimateDistillationCost() {
      try {
        const uid = parseInt(localStorage.getItem('userId') || '0', 10);
        if (!uid || !originalQueryId) return;

        const res = await fetch('/api/estimate_distillation_cost', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid, original_query_id: originalQueryId })
        });
        const data = await res.json();
        if (!data || !data.success) return;

        // æ˜¾ç¤ºæ•°é‡
        const countEl = document.getElementById('distillCountText');
        const countBox = document.getElementById('distillCountStatus');
        countEl.textContent = i18n.t('distill.paper_count', { count: (data.doi_count || 0).toLocaleString() });
        countBox.style.display = 'flex';

        // æ˜¾ç¤ºé¢„è®¡è´¹ç”¨ä¸ä½™é¢
        const costEl = document.getElementById('distillCostText');
        const costBox = document.getElementById('distillCostStatus');
        const cost = typeof data.estimated_cost === 'number' ? data.estimated_cost : 0.0;
        const bal = typeof data.user_balance === 'number' ? data.user_balance : 0.0;
        let text = i18n.t('distill.estimated_cost', { cost: cost.toLocaleString() }) + ' | ' +
                   i18n.t('distill.balance', { balance: bal.toLocaleString() });
        if (data.insufficient) {
          text += ' | ' + i18n.t('distill.insufficient');
        }
        costEl.textContent = text;
        costBox.style.display = 'flex';
      } catch (e) {
        // é™é»˜å¤±è´¥å³å¯
      }
    }

    // å¼€å§‹è’¸é¦
    async function startDistill() {
      if (!originalQueryId) {
        showError(i18n.t('distill.err_missing_qid'));
        return;
      }

      setLoading(true);
      
      try {
        const uid = parseInt(localStorage.getItem('userId'), 10);
        if (!uid) {
          showError(i18n.t('distill.err_user_missing'));
          window.location.href = '/login.html';
          return;
        }

        const question = document.getElementById('question').value.trim();
        const requirements = document.getElementById('requirements').value.trim();

        if (!question) {
          showError(i18n.t('distill.err_no_question'));
          return;
        }

        const payload = {
          original_query_id: originalQueryId,
          question,
          requirements,
          uid
        };

        const res = await fetch('/api/start_distillation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        
        if (!res.ok || !data.success) {
          const msg = data.message || data.error || ('HTTP ' + res.status);
          throw new Error(msg);
        }

        // æˆåŠŸåè·³è½¬åˆ°å†å²é¡µé¢
  showSuccess(i18n.t('distill.success_redirect'));
        setTimeout(() => {
          window.location.href = '/history.html?focus_query=' + encodeURIComponent(data.query_index);
        }, 1000);
        
      } catch (e) {
        console.error('å¼€å§‹è’¸é¦å¤±è´¥', e);
        showError(i18n.t('distill.start_distill_failed', { msg: e.message }));
      } finally {
        setLoading(false);
      }
    }

    // é¡µé¢åˆå§‹åŒ–
    if (checkLogin()) {
      document.getElementById('startDistillBtn').addEventListener('click', startDistill);
      loadOriginalQueryInfo();
    }
  </script>
</body>
</html>