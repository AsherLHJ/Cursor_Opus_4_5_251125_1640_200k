<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="index.title">AutoPaperWeb æœ¬åœ°ç½‘é¡µ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
      overflow: hidden;
    }

    /* ä¸»å¸ƒå±€å®¹å™¨ */
    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* å·¦ä¾§å†å²é¢æ¿ */
    .sidebar {
      width: 280px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: 60px;
    }

    /* ä¾§è¾¹æ å¤´éƒ¨ */
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .sidebar-title {
      opacity: 0;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: color 0.3s ease;
    }

    .sidebar-toggle:hover {
      color: #fff;
      background: #333;
    }

    /* å†å²è®°å½•æŠ˜å æŒ‰é’® */
    .history-toggle {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
      margin-right: 8px;
    }

    .history-toggle:hover {
      color: #fff;
      background: #333;
    }

    .history-toggle svg {
      transition: transform 0.3s ease;
    }

    .history-toggle.collapsed svg {
      transform: rotate(-90deg);
    }

    .sidebar.collapsed .history-toggle {
      display: none;
    }

    /* å†å²è®°å½•å®¹å™¨ */
    .history-container {
      flex: 1;
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
    }

    .history-container.collapsed {
      max-height: 0;
      opacity: 0;
    }

    /* å†å²åˆ—è¡¨åŒºåŸŸ */
    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      height: 100%;
      scrollbar-width: thin;
      scrollbar-color: #666 #2a2a2a;
    }

    /* å†å²åˆ—è¡¨æ»šåŠ¨æ¡æ ·å¼ */
    .history-list::-webkit-scrollbar {
      width: 12px;
    }

    .history-list::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 6px;
      margin: 4px;
    }

    .history-list::-webkit-scrollbar-thumb {
      background: #666;
      border-radius: 6px;
      border: 2px solid #2a2a2a;
      transition: background-color 0.3s ease;
    }

    .history-list::-webkit-scrollbar-thumb:hover {
      background: #888;
    }

    .history-list::-webkit-scrollbar-thumb:active {
      background: #999;
    }

    .history-item {
      padding: 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-left: 3px solid transparent;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* è’¸é¦ç±»å‹å†å²é¡¹ç›®æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-item.distill-type {
      background: linear-gradient(135deg, #2a2016 0%, #1e1e1e 100%);
      border-left: 3px solid #b87333;
      box-shadow: 0 2px 8px rgba(184, 115, 51, 0.1);
    }

    .history-item:hover {
      background: #2a2a2a;
    }

    .history-item.distill-type:hover {
      background: linear-gradient(135deg, #3a2a1a 0%, #2e2a22 100%);
      box-shadow: 0 4px 12px rgba(184, 115, 51, 0.2);
    }

    .history-item.active {
      background: #2a2a2a;
      border-left-color: #4a9eff;
    }

    .history-item.distill-type.active {
      background: linear-gradient(135deg, #3a2a1a 0%, #2e2a22 100%);
      border-left-color: #c9a06a;
      box-shadow: 0 4px 16px rgba(201, 160, 106, 0.3);
    }

    .history-item-content {
      flex: 1;
      min-width: 0;
    }

    .history-item-title {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* è’¸é¦ç±»å‹å†å²é¡¹ç›®æ ‡é¢˜æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-item.distill-type .history-item-title {
      color: #c9a06a;
      text-shadow: 0 0 8px rgba(201, 160, 106, 0.3);
      font-weight: 600;
    }

    .history-item-meta {
      font-size: 12px;
      color: #888;
    }

    /* è’¸é¦ç±»å‹å†å²é¡¹ç›®å…ƒä¿¡æ¯æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-item.distill-type .history-item-meta {
      color: #b87333;
    }

    .sidebar.collapsed .history-item-title,
    .sidebar.collapsed .history-item-meta {
      display: none;
    }

    /* å†å²è®°å½•çŠ¶æ€æ˜¾ç¤º */
    .history-loading,
    .history-empty,
    .history-error {
      padding: 20px 16px;
      text-align: center;
      font-size: 12px;
      color: #888;
    }

    .history-error {
      color: #ff6b6b;
    }

    .history-loading {
      color: #4a9eff;
    }

    /* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆåº•éƒ¨ï¼‰ */
    .sidebar-footer {
      border-top: 1px solid #333;
      padding: 16px;
    }

    .user-info {
      margin-bottom: 12px;
    }

    .user-welcome {
      font-size: 14px;
      color: #fff;
      margin-bottom: 8px;
    }

    .user-balance {
      font-size: 12px;
      color: #888;
      margin-bottom: 12px;
    }

    .user-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .user-action-btn {
      background: none;
      border: 1px solid #444;
      color: #e5e5e5;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
      text-align: left;
    }

    .user-action-btn:hover {
      background: #333;
      border-color: #555;
    }

    .sidebar.collapsed .user-info,
    .sidebar.collapsed .user-actions {
      display: none;
    }

    /* è¯­è¨€åˆ‡æ¢æŒ‰é’® */
    .lang-toggle {
      background: #333;
      border: none;
      color: #e5e5e5;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-bottom: 8px;
      transition: background-color 0.2s ease;
    }

    .lang-toggle:hover {
      background: #444;
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      flex: 1;
      background: #111;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ä¸»å†…å®¹å¤´éƒ¨ */
    .main-header {
      padding: 20px 24px;
      border-bottom: 1px solid #333;
      background: #1a1a1a;
    }

    .main-title {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
      margin: 0;
    }

    /* ä¸»å†…å®¹ä½“ */
    .main-body {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* è¡¨å•æ ·å¼ */
    .form-section {
      margin-bottom: 32px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
    }

    .form-section h3 {
      color: #fff;
      font-size: 18px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #e5e5e5;
      font-weight: 500;
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 2px solid #333;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.3s, box-shadow 0.3s;
      background: #222;
      color: #e5e5e5;
    }

    textarea:focus {
      outline: none;
      border-color: #4a9eff;
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }

    textarea::placeholder {
      color: #888;
    }

    .year-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
        background: #222;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        border: 1px solid #333;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #4a9eff;
      }

      .checkbox-group label {
        color: #e5e5e5;
        margin-bottom: 0;
      }

      .year-input {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .year-input label {
        color: #e5e5e5;
        margin-bottom: 0;
      }

      .year-input input[type="text"], .year-input input[type="number"] {
        padding: 10px 12px;
        border: 2px solid #333;
        border-radius: 6px;
        font-size: 14px;
        width: 100px;
        transition: border-color 0.3s, box-shadow 0.3s;
        background: #1a1a1a;
        color: #e5e5e5;
      }

      .year-input input[type="text"]:focus, .year-input input[type="number"]:focus {
        outline: none;
        border-color: #4a9eff;
        box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
      }

      /* æ–°çš„ä¸‰åˆ—å¸ƒå±€æ ·å¼ */
      .selection-container {
        display: grid;
        grid-template-columns: 300px 1fr 300px;
        gap: 20px;
        margin-bottom: 32px;
        height: 600px;
      }

      .selection-panel {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .selection-panel.scrollable {
        overflow-y: auto;
        overflow-x: hidden;
        max-height: 100%;
      }

      .panel-header {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #333;
      }

      .filter-section {
        margin-bottom: 16px;
      }

      .filter-item {
        margin-bottom: 12px;
      }

      .filter-label {
        display: flex;
        justify-content: between;
        align-items: center;
        font-weight: 500;
        color: #e5e5e5;
        margin-bottom: 8px;
        cursor: pointer;
        padding: 8px;
        background: #222;
        border-radius: 4px;
        border: 1px solid #333;
        transition: all 0.3s;
      }

      .filter-label:hover {
        background: #2a2a2a;
        border-color: #4a9eff;
      }

      .filter-label.expanded {
        background: #2a2a2a;
        border-color: #4a9eff;
      }

      .expand-icon {
        margin-left: auto;
        transition: transform 0.3s;
        color: #888;
      }

      .expand-icon.rotated {
        transform: rotate(180deg);
      }

      .filter-options {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: #222;
        border: 1px solid #333;
        border-top: none;
        border-radius: 0 0 4px 4px;
      }

      .filter-options.expanded {
        max-height: 200px;
        overflow-y: auto;
      }

      .filter-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.3s;
        color: #e5e5e5;
      }

      .filter-option:hover {
        background: #2a2a2a;
      }

      .filter-option input[type="checkbox"] {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        accent-color: #4a9eff;
      }

      .journal-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #333;
        border-radius: 6px;
        background: #222;
      }

      .journal-item {
        padding: 8px;
        border-bottom: 1px solid #333;
        transition: background-color 0.3s;
        cursor: pointer;
      }

      .journal-item:hover {
        background: #2a2a2a;
      }

      .journal-item:last-child {
        border-bottom: none;
      }

      .journal-name {
        font-weight: 600;
        color: #fff;
        margin-bottom: 2px;
        font-size: 14px;
        line-height: 1.2;
      }

      .journal-info {
        font-size: 12px;
        color: #888;
        margin-bottom: 4px;
        line-height: 1.2;
      }

      .journal-actions {
        display: flex;
        justify-content: flex-end;
      }

      .btn-add, .btn-remove {
        padding: 4px 12px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-add {
        padding: 3px 10px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        background: #28a745;
        color: white;
      }

      .btn-add:hover {
        background: #34ce57;
        transform: translateY(-1px);
      }

      .btn-remove {
        background: #dc3545;
        color: white;
      }

      .btn-remove:hover {
        background: #e74c3c;
        transform: translateY(-1px);
      }

      .selected-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #222;
        border: 1px solid #333;
        border-radius: 4px;
        margin-bottom: 8px;
      }

      .selected-name {
        font-weight: 500;
        color: #fff;
      }

      .panel-actions {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #333;
      }

      .search-container {
        margin-bottom: 16px;
      }

      .search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #333;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s, box-shadow 0.3s;
        background: #222;
        color: #e5e5e5;
        box-sizing: border-box;
        margin: 0;
      }

      .search-input:focus {
        outline: none;
        border-color: #4a9eff;
        box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
      }

      .search-input::placeholder {
        color: #888;
      }

      .btn-clear {
        width: 100%;
        padding: 8px;
        background: #444;
        color: #e5e5e5;
        border: 1px solid #555;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-clear:hover {
        background: #555;
        transform: translateY(-1px);
      }

      .loading-text {
        text-align: center;
        color: #888;
        padding: 20px;
        font-style: italic;
      }

      .empty-text {
        text-align: center;
        color: #666;
        padding: 40px 20px;
        font-style: italic;
      }

      @media (max-width: 1200px) {
        .selection-container {
          grid-template-columns: 1fr;
          height: auto;
        }
        
        .selection-panel {
          margin-bottom: 20px;
        }
      }

    .action-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      padding: 24px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status {
      font-size: 16px;
      font-weight: 600;
      color: #4a9eff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-icon {
      width: 20px;
      height: 20px;
      background: #4a9eff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }

    .error-message {
      background: #2d1b1b;
      color: #ff6b6b;
      border: 1px solid #4a2626;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }

    .success-message {
      background: #1b2d1b;
      color: #51cf66;
      border: 1px solid #264a26;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }

    @media (max-width: 768px) {
      .main-body {
        padding: 20px;
      }

      .main-header {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .user-info {
        position: static;
        margin-top: 16px;
        text-align: center;
      }

      .year-controls {
        flex-direction: column;
        align-items: flex-start;
      }

      .folders {
        grid-template-columns: 1fr;
      }

      .action-section {
        flex-direction: column;
        text-align: center;
      }

      .sidebar {
        width: 60px;
      }
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ç¡®ä¿æ‰€æœ‰è¾“å…¥å…ƒç´ åœ¨æš—è‰²ä¸»é¢˜ä¸‹çš„ä¸€è‡´æ€§ */
    input, select, button {
      color-scheme: dark;
    }

    /* è¯´æ˜è§†å›¾å¡ç‰‡æ ·å¼ */
    .search-summary-card {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      margin-top: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }

    .card-header h3 {
      margin: 0;
      color: #4a9eff;
      font-size: 20px;
    }

    .btn-secondary {
      background: #333;
      color: #e5e5e5;
      border: 1px solid #555;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #444;
      border-color: #666;
    }

    .summary-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .summary-label {
      font-weight: 600;
      color: #4a9eff;
      font-size: 14px;
    }

    .summary-value {
      color: #e5e5e5;
      line-height: 1.5;
      padding: 12px;
      background: #2a2a2a;
      border-radius: 6px;
      border: 1px solid #333;
    }

    /* ä¿®å¤39: ä»»åŠ¡IDæ˜¾ç¤ºæ ·å¼ */
    .query-id-row {
      border-bottom: 1px dashed #444;
      padding-bottom: 12px;
      margin-bottom: 8px;
    }
    
    .query-id-value {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      color: #60a5fa;
      background: #1a1a2e;
      border: 1px solid #3b4a6b;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
    }

    .stat-content {
      text-align: center;
      width: 100%;
    }

    .stat-label {
      font-size: 14px;
      color: #888;
      margin-right: 8px;
    }

    /* è’¸é¦å¡ç‰‡å®¹å™¨æ ·å¼ */
    .distill-cards-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }

    .distill-card {
      background: #1e1e1e;
      border: 1px solid #4a9eff;
      border-radius: 12px;
      padding: 24px;
      position: relative;
      animation: slideInFromTop 0.3s ease-out;
    }

    .distill-card.collapsed {
      padding: 16px;
      border-color: #666;
      background: #2a2a2a;
    }

    .distill-card.collapsed .distill-content {
      display: none;
    }

    .distill-card.collapsed .distill-header {
      margin-bottom: 0;
    }

    @keyframes slideInFromTop {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .distill-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
    }

    .distill-title {
      color: #4a9eff;
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .distill-badge {
      background: #4a9eff;
      color: #000;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .distill-badge.distill-running {
      background: #ffa500;
      color: #000;
    }

    .distill-actions {
      display: flex;
      gap: 8px;
    }

    .distill-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .distill-form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .distill-form-group label {
      font-weight: 600;
      color: #4a9eff;
      font-size: 14px;
    }

    .distill-form-group textarea {
      min-height: 80px;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #2a2a2a;
      color: #e5e5e5;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .distill-form-group textarea:focus {
      outline: none;
      border-color: #4a9eff;
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }

    .distill-form-group textarea::placeholder {
      color: #888;
    }

    .distill-cost-info {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 12px;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 14px;
    }

    .distill-cost-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e5e5;
    }

    .distill-cost-item .icon {
      color: #4a9eff;
    }

    .distill-cost-insufficient {
      color: #ff6b6b;
      font-weight: 600;
    }

    .distill-summary-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .distill-summary-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .distill-summary-label {
      font-weight: 600;
      color: #4a9eff;
      font-size: 14px;
    }

    .distill-summary-value {
      color: #e5e5e5;
      line-height: 1.5;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 6px;
      border: 1px solid #333;
    }

    .btn-orange {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      justify-content: center;  /* ä¿®å¤36è¡¥å……: æ–‡å­—æ°´å¹³å±…ä¸­ */
      align-items: center;      /* ä¿®å¤36è¡¥å……: æ–‡å­—å‚ç›´å±…ä¸­ */
      gap: 8px;
    }

    .btn-orange:hover {
      background: linear-gradient(135deg, #f57c00, #e65100);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }

    .btn-orange:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ç»ˆæ­¢æŒ‰é’®æ ·å¼ï¼ˆä¿®å¤12ï¼‰ */
    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #c82333, #bd2130);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .btn-collapse {
      background: #333;
      color: #888;
      border: 1px solid #555;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .btn-collapse:hover {
      background: #444;
      color: #e5e5e5;
    }

    /* ä¸‹è½½æŒ‰é’®loading spinnerï¼ˆä¿®å¤21ï¼‰ */
    .spinner-small {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      margin-right: 6px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #e5e5e5;
    }

    /* è¾“å…¥åŒºåŸŸéšè—æ—¶çš„æ ·å¼ */
    .input-section.hidden {
      display: none;
    }

    /* é€šç”¨éšè—ç±»ï¼ˆå¯é€‰åŠ å›ºï¼‰ */
    .hidden {
      display: none !important;
    }

    /* è¿›åº¦åŒºåŸŸæ ·å¼ */
    .progress-section {
      margin-top: 24px;
      padding: 20px;
      background: #2a2a2a;
      border: 1px solid #333;
      border-radius: 8px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .progress-header h4 {
      margin: 0;
      color: #4a9eff;
      font-size: 16px;
    }

    .progress-actions {
      display: flex;
      gap: 8px;
    }

    .progress-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .progress-bar-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .progress-bar {
      flex: 1;
      height: 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      font-weight: 600;
      color: #4a9eff;
      min-width: 40px;
      text-align: right;
    }

    .progress-status {
      font-size: 14px;
      color: #888;
      text-align: center;
    }

    /* éšæœºæ–‡å­—æ˜¾ç¤ºæ ·å¼ */
    .progress-random-text {
      font-size: 13px;
      color: #999;
      text-align: center;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
      border-left: 3px solid #4a9eff;
      font-style: italic;
      line-height: 1.4;
      min-height: 20px;
      transition: all 0.3s ease;
    }

    .progress-random-text:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #bbb;
    }

    .progress-random-text.loading {
      color: #666;
    }

    .progress-random-text.loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ""; }
      40% { content: "."; }
      60% { content: ".."; }
      80%, 100% { content: "..."; }
    }

    /* è’¸é¦å¡ç‰‡è¿›åº¦æ˜¾ç¤ºæ ·å¼ */
    .distill-progress {
      margin-top: 20px;
      padding: 16px;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
    }

    .distill-progress .progress-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .distill-progress .progress-bar-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .distill-progress .progress-bar {
      flex: 1;
      height: 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      overflow: hidden;
    }

    .distill-progress .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
      transition: width 0.3s ease;
    }

    .distill-progress .progress-text {
      font-size: 14px;
      font-weight: 600;
      color: #4a9eff;
    }

    .distill-progress .progress-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }

    .distill-summary {
      margin-bottom: 16px;
      padding: 16px;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
    }

    .completion-message {
      text-align: center;
      padding: 20px;
    }

    .completion-message h4 {
      color: #51cf66;
      margin-bottom: 16px;
    }

    .completion-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* å®ŒæˆåæŒ‰é’®åŒºåŸŸæ ·å¼ */
    .completion-section {
      margin-top: 24px;
      padding: 24px;
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
      border: 1px solid #333;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .completion-header {
      margin-bottom: 20px;
      text-align: center;
      padding-bottom: 16px;
      border-bottom: 2px solid #51cf66;
    }

    .completion-header h4 {
      margin: 0;
      color: #51cf66;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .completion-header h4::before {
      content: "âœ…";
      font-size: 20px;
    }

    .completion-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .completion-actions .btn-primary,
    .completion-actions .btn-secondary,
    .completion-actions .btn-danger {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 48px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .completion-actions .btn-primary {
      background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
      border: none;
    }

    .completion-actions .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(74, 158, 255, 0.4);
    }

    .completion-actions .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      border: none;
    }

    .completion-actions .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(108, 117, 125, 0.4);
    }

    .completion-actions .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(220, 53, 69, 0.4);
    }

    .completion-actions .btn-orange {
      background: linear-gradient(135deg, #ff8c00 0%, #ff6600 100%);
      border: none;
      color: white;
    }

    .completion-actions .btn-orange:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 140, 0, 0.4);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .completion-actions {
        grid-template-columns: 1fr;
        max-width: 100%;
      }
      
      .completion-section {
        padding: 20px 16px;
      }
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-danger:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* å†å²æè¿°å¡ç‰‡æ ·å¼ */
    .history-description-card {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    /* è’¸é¦ç±»å‹å†å²æè¿°å¡ç‰‡æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-description-card.distill-type {
      background: linear-gradient(135deg, #2a2016 0%, #1e1e1e 100%);
      border: 1px solid #b87333;
      box-shadow: 0 0 20px rgba(184, 115, 51, 0.1);
    }

    .history-description-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }

    .history-description-card.distill-type .card-header {
      border-bottom: 1px solid #b87333;
    }

    .history-description-card .card-header h3 {
      margin: 0;
      color: #4a9eff;
      font-size: 20px;
    }

    .history-description-card.distill-type .card-header h3 {
      color: #c9a06a;
      text-shadow: 0 0 10px rgba(201, 160, 106, 0.3);
    }

    /* è’¸é¦ç±»å‹å¡ç‰‡ä¸­çš„æŒ‰é’®æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-description-card.distill-type .btn-secondary {
      background: #5c4a2a;
      border-color: #b87333;
      color: #f5e6d3;
    }

    .history-description-card.distill-type .btn-secondary:hover {
      background: #6b5a3a;
      border-color: #c9a06a;
      color: #fff;
    }

    .history-description-card.distill-type .btn-orange {
      background: linear-gradient(135deg, #b87333 0%, #8b6914 100%);
      border: none;
    }

    .history-description-card.distill-type .btn-orange:hover {
      background: linear-gradient(135deg, #c9a06a 0%, #b87333 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(184, 115, 51, 0.4);
    }

    /* è’¸é¦ç±»å‹å¡ç‰‡ä¸­çš„è¿›åº¦æ¡æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-description-card.distill-type .progress-bar {
      background: #2a2016;
      border: 1px solid #b87333;
    }

    .history-description-card.distill-type .progress-fill {
      background: linear-gradient(90deg, #b87333 0%, #c9a06a 100%);
    }

    /* è’¸é¦ç±»å‹å¡ç‰‡ä¸­çš„æ‘˜è¦å€¼æ ·å¼ - ä¿®å¤31: æ”¹ä¸ºä½é¥±å’Œåº¦æ©™è‰² */
    .history-description-card.distill-type .summary-value {
      background: #2a2016;
      border: 1px solid #b87333;
      color: #f5e6d3;
    }

    .history-description-card.distill-type .summary-label {
      color: #c9a06a;
    }

    .btn-close {
      background: transparent;
      border: none;
      color: #999;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .btn-close:hover {
      background: #333;
      color: #fff;
    }

    .history-summary {
      margin-bottom: 24px;
    }

    .history-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      color: #999;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #333;
      border-top: 3px solid #4a9eff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: #999;
    }

    .error-content {
      padding: 20px;
    }

    .error-message {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .basic-info {
      margin-bottom: 20px;
    }

    /* å¡ç‰‡é«˜äº®æ•ˆæœ */
    .highlight-card {
      border-color: #4a9eff !important;
      box-shadow: 0 0 20px rgba(74, 158, 255, 0.3) !important;
      transform: scale(1.02);
    }

    /* å†å²é¡¹å½“å‰ä¼šè¯é«˜äº® */
    .history-item.active {
      background: linear-gradient(135deg, #4a9eff20, #4a9eff10);
      border-left: 3px solid #4a9eff;
    }

    .history-item.active .history-item-title {
      color: #4a9eff;
      font-weight: 600;
    }

    .history-item.active .history-item-meta {
      color: #4a9eff;
    }

    /* ä¿®å¤35æ–°å¢ï¼šå…¬å‘Šæ æ ·å¼ */
    .announcement-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1a3d5c 0%, #0f2940 100%);
      color: #e5e5e5;
      padding: 12px 20px;
      text-align: center;
      font-size: 14px;
      z-index: 1000;
      border-bottom: 1px solid #2a5a8a;
      display: none;
    }
    body.has-announcement .app-container {
      height: calc(100vh - 50px);
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <!-- ä¿®å¤35æ–°å¢ï¼šå…¬å‘Šæ  -->
  <div id="announcementBar" class="announcement-bar">
    <span id="announcementText"></span>
  </div>
  
  <div class="app-container">
    <!-- å·¦ä¾§å†å²é¢æ¿ -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title" data-i18n="common.history_title">å†å²è®°å½•</span>
        <button class="history-toggle" id="historyToggle" title="æŠ˜å /å±•å¼€å†å²è®°å½•">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
          </svg>
        </button>
        <button class="sidebar-toggle" id="sidebarToggle">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
      </div>
      
      <div class="history-container" id="historyContainer">
        <div class="history-list" id="historyList">
          <!-- å†å²è®°å½•é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
          <div class="history-item active">
            <div class="history-item-title" data-i18n="index.new_search">æ–°å»ºæœç´¢</div>
            <div class="history-item-meta" data-i18n="index.current">å½“å‰</div>
          </div>
        </div>
        
        <div class="history-loading" id="historyLoading" style="display: none;">
          <span data-i18n="common.loading_history">æ­£åœ¨åŠ è½½å†å²è®°å½•...</span>
        </div>
        
        <div class="history-empty" id="historyEmpty" style="display: none;">
          <span data-i18n="common.no_history">æš‚æ— å†å²è®°å½•</span>
        </div>
        
        <div class="history-error" id="historyError" style="display: none;">
          <span data-i18n="common.load_history_failed">åŠ è½½å†å²è®°å½•å¤±è´¥</span>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-welcome">
            <span id="welcomeName" data-i18n="common.welcome_guest">æ¬¢è¿ï¼Œæ¸¸å®¢</span>
          </div>
          <div class="user-balance">
            <strong data-i18n="common.balance">ä½™é¢</strong>ï¼š
            <span id="userBalance">--</span>
            <span data-i18n="common.credit_unit">æ£€ç´¢ç‚¹</span>
          </div>
        </div>
        
        <div class="user-actions">
          <button class="user-action-btn" onclick="window.location.href='billing.html'" data-i18n="common.billing">æ£€ç´¢è´¦å•</button>
          <button class="user-action-btn" id="logoutBtn" data-i18n="common.logout">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <div class="main-header">
        <h1 class="main-title">
          <span data-i18n="index.title">AutoPaperWeb ç ”ç©¶åŠ©æ‰‹</span>
          <span class="user-greeting" style="margin-left: 20px;" data-i18n="index.user_greeting" data-username="">ä½ å¥½ï¼Œ{username}</span>
        </h1>
      </div>

      <div class="main-body">
      <!-- è’¸é¦å¡ç‰‡å®¹å™¨ -->
      <div id="distillCardsContainer" class="distill-cards-container">
        <!-- è’¸é¦å¡ç‰‡å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div id="inputSection" class="input-section">
        <div class="form-section">
          <h3 data-i18n="index.research_config">ğŸ” ç ”ç©¶é…ç½®</h3>
          <div class="form-group">
            <label for="question" data-i18n="index.question_label">ç ”ç©¶é—®é¢˜</label>
            <textarea id="question" data-i18n-placeholder="index.question_ph" placeholder="è¯·è¾“å…¥æ‚¨çš„ç ”ç©¶é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæœºå™¨å­¦ä¹ åœ¨åŒ»ç–—è¯Šæ–­ä¸­çš„åº”ç”¨ç°çŠ¶å¦‚ä½•ï¼Ÿ"></textarea>
          </div>

          <div class="form-group">
            <label for="requirements" data-i18n="index.req_label">ç ”ç©¶è¦æ±‚</label>
            <textarea id="requirements" data-i18n-placeholder="index.req_ph" placeholder="è¯·è¾“å…¥å…·ä½“è¦æ±‚ï¼Œä¾‹å¦‚ï¼šéœ€è¦åŒ…å«æœ€æ–°çš„æ·±åº¦å­¦ä¹ æ–¹æ³•ï¼Œé‡ç‚¹å…³æ³¨å‡†ç¡®æ€§å’Œå¯è§£é‡Šæ€§"></textarea>
          </div>
        </div>

        <!-- æ–°çš„ä¸‰åˆ—é€‰æ‹©ç•Œé¢ -->
        <div class="selection-container">
        <!-- ç¬¬ä¸€åˆ—ï¼šç­›é€‰æ¡ä»¶ -->
        <div class="selection-panel scrollable">
          <div class="panel-header" data-i18n="index.filter_panel">ç­›é€‰æ¡ä»¶</div>
          <div style="margin-bottom: 12px;">
            <button class="btn-clear" id="clearTagsBtn" data-i18n="index.clear_tags">æ¸…é™¤å·²å‹¾é€‰æ ‡ç­¾</button>
          </div>
          <!-- åœ¨æ­¤æ’å…¥æ—¶é—´èŒƒå›´æ§ä»¶ -->
          <div class="filter-item">
            <div class="filter-label" data-filter="time_range">
              <span data-i18n="index.time_range">ğŸ“… æ—¶é—´èŒƒå›´</span>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="filter-options expanded" style="display:block;">
              <div class="year-controls">
                <div class="checkbox-group">
                  <input type="checkbox" id="includeAllYears" />
                  <label for="includeAllYears" data-i18n="index.include_all_years">åŒ…å«æ‰€æœ‰å¹´ä»½</label>
                </div>
                <div class="year-input">
                  <label data-i18n="index.start_year">èµ·å§‹å¹´ä»½ï¼š</label>
                  <input type="number" id="startYear" placeholder="2000" min="1900" max="2030" />
                </div>
                <div class="year-input">
                  <label data-i18n="index.end_year">ç»“æŸå¹´ä»½ï¼š</label>
                  <input type="number" id="endYear" placeholder="2025" min="1900" max="2030" />
                </div>
              </div>
            </div>
          </div>
          
          <!-- åˆŠç‰©ç±»å‹ -->
          <div class="filter-item">
            <div class="filter-label" data-filter="journal_type">
              <span data-i18n="index.journal_type">åˆŠç‰©ç±»å‹</span>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="filter-options" id="journalTypeOptions">
              <div class="loading-text" data-i18n="index.loading_tags">æ­£åœ¨åŠ è½½æ ‡ç­¾...</div>
            </div>
          </div>

          <!-- åˆŠç‰©æ¥æº -->
          <div class="filter-item">
            <div class="filter-label" data-filter="journal_source">
              <span data-i18n="index.journal_source">åˆŠç‰©æ¥æº</span>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="filter-options" id="journalSourceOptions">
              <div class="loading-text" data-i18n="index.loading_tags">æ­£åœ¨åŠ è½½æ ‡ç­¾...</div>
            </div>
          </div>

          <!-- å¤§ç±»å­¦ç§‘ -->
          <div class="filter-item">
            <div class="filter-label" data-filter="major_category">
              <span data-i18n="index.major_category">å¤§ç±»å­¦ç§‘</span>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="filter-options" id="majorCategoryOptions">
              <div class="loading-text" data-i18n="index.loading_tags">æ­£åœ¨åŠ è½½æ ‡ç­¾...</div>
            </div>
          </div>

          <!-- å°ç±»å­¦ç§‘ -->
          <div class="filter-item">
            <div class="filter-label" data-filter="minor_category">
              <span data-i18n="index.minor_category">å°ç±»å­¦ç§‘</span>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="filter-options" id="minorCategoryOptions">
              <div class="loading-text" data-i18n="index.loading_tags">æ­£åœ¨åŠ è½½æ ‡ç­¾...</div>
            </div>
          </div>
        </div>

        <!-- ç¬¬äºŒåˆ—ï¼šå¯é€‰æœŸåˆŠ/ä¼šè®® -->
        <div class="selection-panel">
          <div class="panel-header">
            <span data-i18n="index.available_journals">å¯é€‰æœŸåˆŠ/ä¼šè®®</span>
            <span id="availableCount" style="font-size: 12px; font-weight: normal; color: #888;"></span>
          </div>
          <div class="search-container">
            <input type="text" class="search-input" id="journalSearchInput" placeholder="æœç´¢æœŸåˆŠæˆ–ä¼šè®®åç§°..." data-i18n-placeholder="index.search_journals_ph">
          </div>
          <div class="journal-list" id="availableJournals">
            <div class="loading-text" data-i18n="index.loading_journals">æ­£åœ¨åŠ è½½æœŸåˆŠ...</div>
          </div>
        </div>

        <!-- ç¬¬ä¸‰åˆ—ï¼šå·²é€‰æœŸåˆŠ/ä¼šè®® -->
        <div class="selection-panel">
          <div class="panel-header">
            <span data-i18n="index.selected_journals">å·²é€‰æœŸåˆŠ/ä¼šè®®</span>
            <span id="selectedCount" style="font-size: 12px; font-weight: normal; color: #888;"></span>
          </div>
          <div class="journal-list" id="selectedJournals">
            <div class="empty-text" data-i18n="index.no_journals_found">è¯·ä»å·¦ä¾§æ·»åŠ æœŸåˆŠ</div>
          </div>
          <div class="panel-actions">
            <button class="btn-clear" id="clearAllBtn" data-i18n="index.clear_all">æ¸…ç©ºå…¨éƒ¨</button>
          </div>
        </div>
      </div>

      <div class="action-section">
        <button id="submitBtn" class="btn-primary">
          <div class="loading" id="loadingSpinner"></div>
          <span id="btnText" data-i18n="index.update_stats">ğŸ”„ æ›´æ–°ç»Ÿè®¡</span>
        </button>
        <!-- æ–°å¢ï¼šå¼€å§‹æ£€ç´¢æŒ‰é’® -->
        <button id="startSearchBtn" class="btn-primary">
          <span data-i18n="index.start_search">ğŸš€ å¼€å§‹æ£€ç´¢</span>
        </button>
        <div id="status" class="status">
          <div class="status-icon">ğŸ“Š</div>
          <span id="statusCount">å·²é€‰æ‹©æ–‡ç« æ•°ï¼š0</span>
        </div>
        <div id="costStatus" class="status" style="display: none;">
          <div class="status-icon">ğŸ’°</div>
          <span id="costCount" data-i18n="index.estimated_cost">é¢„è®¡èŠ±è´¹ç‚¹æ•°ï¼š0</span>
        </div>
      </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
      </div>

      <!-- è¯´æ˜è§†å›¾å¡ç‰‡ï¼ˆæ£€ç´¢å¼€å§‹åæ˜¾ç¤ºï¼‰ -->
      <div id="searchSummaryCard" class="search-summary-card" style="display: none;">
        <div class="card-header">
          <h3 data-i18n="index.search_summary_title">ğŸ” æ£€ç´¢æ¦‚è§ˆ</h3>
          <button id="backToInputBtn" class="btn-secondary" data-i18n="index.back_to_input">è¿”å›ç¼–è¾‘</button>
        </div>
        
        <div class="summary-content">
          <!-- ä¿®å¤39: æ˜¾ç¤ºä»»åŠ¡ID -->
          <div class="summary-item query-id-row">
            <div class="summary-label" data-i18n="index.query_id_label">ä»»åŠ¡IDï¼š</div>
            <div id="summaryQueryId" class="summary-value query-id-value"></div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.research_question">ç ”ç©¶é—®é¢˜ï¼š</div>
            <div id="summaryQuestion" class="summary-value"></div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.research_requirements">ç ”ç©¶è¦æ±‚ï¼š</div>
            <div id="summaryRequirements" class="summary-value"></div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.time_range_summary">æ—¶é—´èŒƒå›´ï¼š</div>
            <div id="summaryTimeRange" class="summary-value"></div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.selected_journals_summary">å·²é€‰æœŸåˆŠï¼š</div>
            <div id="summaryJournals" class="summary-value"></div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.start_time_summary">å¼€å§‹æ—¶é—´ï¼š</div>
            <div id="summaryStartTime" class="summary-value"></div>
          </div>
          
          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label" data-i18n="index.total_articles">æ–‡ç« æ€»æ•°</span>: 
                <span id="summaryArticleCount" class="stat-value">-</span>
              </div>
            </div>
            
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label" data-i18n="index.estimated_cost_summary">é¢„è®¡èŠ±è´¹</span>: 
                <span id="summaryCost" class="stat-value">- <span data-i18n="common.credit_unit">ç‚¹æ•°</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¿›åº¦åŒºåŸŸ -->
      <div id="progressSection" class="progress-section" style="display: none;">
        <div class="progress-header">
          <h4 data-i18n="index.progress_title">æ£€ç´¢è¿›åº¦</h4>
          <div class="progress-actions">
            <button id="pauseResumeBtn" class="btn-secondary" style="display: none;">
              <span data-i18n="index.pause">æš‚åœ</span>
            </button>
            <button id="terminateBtn" class="btn-danger" style="display: none;">
              <span data-i18n="index.terminate">ç»ˆæ­¢</span>
            </button>
          </div>
        </div>
        <div class="progress-container">
          <div class="progress-bar-wrapper">
            <div id="progressBar" class="progress-bar">
              <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">0%</div>
          </div>
          <div id="progressStatus" class="progress-status" data-i18n="index.status_running">è¿è¡Œä¸­</div>
        </div>
      </div>
      
      <!-- å®ŒæˆåæŒ‰é’®åŒºåŸŸ -->
      <div id="completionSection" class="completion-section" style="display: none;">
        <div class="completion-header">
          <h4 data-i18n="index.completion_title">æ£€ç´¢å®Œæˆ</h4>
        </div>
        <div class="completion-actions">
          <button id="downloadCsvBtn" class="btn-secondary">
            <span data-i18n="index.download_all_results">ä¸‹è½½å…¨éƒ¨åˆ†æç»“æœ</span>
          </button>
          <button id="downloadBibBtn" class="btn-secondary">
            <span data-i18n="index.download_bib_results">ä¸‹è½½ç›¸ç¬¦ç»“æœçš„bibå¼•ç”¨</span>
          </button>
          <button id="distillBtn" class="btn-orange">
            <span data-i18n="index.distill">è’¸é¦</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/i18n.js"></script>
  <script>
    // å·¥å…·å‡½æ•°
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      // å»¶é•¿æ˜¾ç¤ºæ—¶é—´ï¼Œé¿å…ä¸è·³è½¬å†²çª
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function showInfo(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 3000);
    }

    function setLoading(isLoading) {
      const btn = document.getElementById('submitBtn');
      const spinner = document.getElementById('loadingSpinner');
      const btnText = document.getElementById('btnText');
      
      if (isLoading) {
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        btnText.textContent = i18n.t('index.updating');
      } else {
        btn.disabled = false;
        spinner.style.display = 'none';
        btnText.textContent = i18n.t('index.update_stats');
      }
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function updateWelcome() {
      const username = localStorage.getItem('username');
      const nameEl = document.getElementById('welcomeName');
      if (!nameEl) return;
      if (username) {
        nameEl.textContent = i18n.t('common.welcome_user', { username: username });
      } else {
        nameEl.textContent = i18n.t('common.welcome_guest');
      }
    }

    // æ›´æ–°æ ‡é¢˜ä¸­çš„ç”¨æˆ·å
    function updateTitleGreeting() {
      const username = localStorage.getItem('username');
      const greetingEl = document.querySelector('.user-greeting');
      if (!greetingEl) return;
      if (username) {
        greetingEl.textContent = i18n.t('index.user_greeting', { username: username });
        greetingEl.style.display = 'inline';
      } else {
        greetingEl.style.display = 'none';
      }
    }

    // å…¨å±€å˜é‡
    let availableJournals = [];
    let selectedJournals = [];
    let filteredJournals = []; // æ–°å¢ï¼šæœç´¢è¿‡æ»¤åçš„æœŸåˆŠåˆ—è¡¨
    let searchKeyword = ''; // æ–°å¢ï¼šæœç´¢å…³é”®è¯
    let filterTags = {
      'åˆŠç‰©ç±»å‹': [],
      'åˆŠç‰©æ¥æº': [],
      'ä¸€çº§åˆ†ç±»': [],
      'äºŒçº§åˆ†ç±»': []
    };

    // é˜²æŠ–å‡½æ•°ï¼šé¿å…é¢‘ç¹è§¦å‘æ›´æ–°ç»Ÿè®¡
    function debounce(fn, delay) {
      let timer = null;
      return function(...args) {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // é˜²æŠ–ç‰ˆæœ¬çš„ updateStatsï¼ˆå»¶è¿Ÿ 500msï¼‰
    const debouncedUpdateStats = debounce(function() {
      // åªæœ‰é€‰ä¸­äº†æœŸåˆŠæ‰æ‰§è¡Œæ›´æ–°ç»Ÿè®¡
      if (selectedJournals.length > 0) {
        updateStats();
      }
    }, 500);

    // å½“å‰ä¼šè¯ç®¡ç†
    function getCurrentSession() {
      return localStorage.getItem('currentSession');
    }

    function setCurrentSession(queryIndex) {
      if (queryIndex) {
        localStorage.setItem('currentSession', queryIndex);
      } else {
        localStorage.removeItem('currentSession');
      }
    }

    // æ¢å¤å½“å‰ä¼šè¯çŠ¶æ€
    function restoreCurrentSession() {
      const currentSession = getCurrentSession();
      if (!currentSession) {
        // æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œé«˜äº®"æ–°å»ºæœç´¢"
        setTimeout(() => {
          const newSearchItem = document.querySelector('.history-item[data-qid="new"]');
          if (newSearchItem) {
            document.querySelectorAll('.history-item').forEach(item => {
              item.classList.remove('active');
            });
            newSearchItem.classList.add('active');
          }
        }, 100);
        return;
      }
      
      // ç­‰å¾…å†å²è®°å½•åŠ è½½å®Œæˆåæ¢å¤é«˜äº®
      setTimeout(() => {
        const sessionItem = document.querySelector(`.history-item[data-qid="${currentSession}"]`);
        if (sessionItem) {
          document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove('active');
          });
          sessionItem.classList.add('active');
        } else {
          // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„å†å²é¡¹ï¼Œæ¸…é™¤ä¼šè¯çŠ¶æ€
          setCurrentSession(null);
          const newSearchItem = document.querySelector('.history-item[data-qid="new"]');
          if (newSearchItem) {
            newSearchItem.classList.add('active');
          }
        }
      }, 500);
    }

    // è’¸é¦ç›¸å…³å…¨å±€å˜é‡
    let distillCardCounter = 0; // è’¸é¦å¡ç‰‡è®¡æ•°å™¨
    let activeDistillCards = new Map(); // æ´»è·ƒçš„è’¸é¦å¡ç‰‡ Map<cardId, cardData>
    let distillProgressIntervals = new Map(); // è’¸é¦è¿›åº¦è½®è¯¢é—´éš” Map<cardId, intervalId>
    let currentSearchQueryIndex = null; // å½“å‰æ£€ç´¢çš„query_id

    // éšæœºå¥å­ç¼“å­˜ç®¡ç†
    let sentenceCache = []; // å¥å­ç¼“å­˜æ•°ç»„
    let sentenceCacheIndex = 0; // å½“å‰ä½¿ç”¨çš„å¥å­ç´¢å¼•
    let lastSentenceFetchTime = 0; // ä¸Šæ¬¡è·å–å¥å­çš„æ—¶é—´æˆ³
    const SENTENCE_CACHE_DURATION = 5 * 60 * 1000; // ç¼“å­˜5åˆ†é’Ÿ
    const SENTENCE_CACHE_SIZE = 20; // ç¼“å­˜20ä¸ªå¥å­

    // æš´éœ²ç»™ i18n.js çš„è¯­è¨€åˆ‡æ¢å›è°ƒ
    window.apw_afterLangChange = function() { 
      updateWelcome(); 
      updateUITexts();
    };

    // ä¿®å¤35æ–°å¢ï¼šæ£€æŸ¥ç»´æŠ¤æ¨¡å¼
    async function checkMaintenanceMode() {
      try {
        const resp = await fetch('/api/maintenance_status');
        const data = await resp.json();
        if (data.success && data.enabled) {
          window.location.href = '/maintenance.html';
          return true;
        }
      } catch (error) {
        console.log('æ£€æŸ¥ç»´æŠ¤æ¨¡å¼å¤±è´¥:', error);
      }
      return false;
    }

    // ä¿®å¤35æ–°å¢ï¼šæ£€æŸ¥å…¬å‘Šæ 
    async function checkAnnouncement() {
      try {
        const resp = await fetch('/api/system_announcement');
        const data = await resp.json();
        if (data.success && data.enabled && data.content) {
          document.getElementById('announcementText').textContent = data.content;
          document.getElementById('announcementBar').style.display = 'block';
          document.body.classList.add('has-announcement');
        }
      } catch (error) {
        console.log('æ£€æŸ¥å…¬å‘Šæ å¤±è´¥:', error);
      }
    }

    function checkLogin() {
      const token = localStorage.getItem('userToken');
      const username = localStorage.getItem('username');
      
      if (!token || !username) {
        window.location.href = '/login.html';
        return false;
      }
      updateWelcome();
      return true;
    }

    /**
     * ä¿®å¤37: å¸¦è®¤è¯çš„ fetch è¾…åŠ©å‡½æ•°
     * è‡ªåŠ¨æ·»åŠ  Authorization: Bearer {token} å¤´
     * å¦‚æœæ”¶åˆ° 401 å“åº”ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
     * 
     * @param {string} url - è¯·æ±‚ URL
     * @param {Object} options - fetch é€‰é¡¹
     * @returns {Promise<Response>}
     */
    async function authFetch(url, options = {}) {
      const token = localStorage.getItem('userToken');
      
      if (!token) {
        window.location.href = '/login.html';
        throw new Error('æœªç™»å½•');
      }
      
      // åˆå¹¶ headers
      const headers = {
        ...(options.headers || {}),
        'Authorization': `Bearer ${token}`
      };
      
      const response = await fetch(url, { ...options, headers });
      
      // å¦‚æœæ”¶åˆ° 401ï¼Œè¯´æ˜ token å·²å¤±æ•ˆ
      if (response.status === 401) {
        localStorage.removeItem('userToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        window.location.href = '/login.html';
        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      }
      
      return response;
    }

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('userToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      window.location.href = '/login.html';
    });

  // æ–°å¢ï¼šä½™é¢è·å–ï¼ˆå¸¸é©»æ˜¾ç¤ºï¼‰
    let userBalanceCache = null;
    let lastBalanceFetchTs = 0;

    async function fetchUserBalance() {
      const uid = parseInt(localStorage.getItem('userId') || '0', 10);
      const balanceEl = document.getElementById('userBalance');
      if (!balanceEl) return;
      if (!uid) {
        balanceEl.textContent = i18n.t('index.login_required');
        return;
      }
      const now = Date.now();
      if (userBalanceCache !== null && now - lastBalanceFetchTs < 60000) {
        balanceEl.textContent = userBalanceCache;
        return;
      }
      try {
        balanceEl.textContent = i18n.t('index.loading_short');
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
        const res = await authFetch('/api/user_info');
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        if (data.success && data.user_info && typeof data.user_info.balance !== 'undefined') {
          userBalanceCache = data.user_info.balance;
          lastBalanceFetchTs = now;
          balanceEl.textContent = userBalanceCache;
        } else {
          balanceEl.textContent = i18n.t('index.fetch_failed');
        }
      } catch (e) {
        console.error('è·å–ä½™é¢å¤±è´¥:', e);
        balanceEl.textContent = i18n.getLang()==='zh' ? '--' : '--';
      }
    }

    // åˆå§‹åŒ–ä½™é¢ï¼šé¡µé¢åŠ è½½åç›´æ¥æ‹‰å–ä¸€æ¬¡
    function initUserBalance() {
      fetchUserBalance();
    }

    // éšæœºå¥å­ç®¡ç†å‡½æ•°
    async function fetchRandomSentences() {
      try {
        const response = await fetch(`/api/random_sentences?count=${SENTENCE_CACHE_SIZE}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (data.success && Array.isArray(data.sentences)) {
          sentenceCache = data.sentences;
          sentenceCacheIndex = 0;
          lastSentenceFetchTime = Date.now();
          return true;
        }
        return false;
      } catch (error) {
        console.error('è·å–éšæœºå¥å­å¤±è´¥:', error);
        return false;
      }
    }

    // è·å–ä¸‹ä¸€ä¸ªéšæœºå¥å­
    async function getNextRandomSentence() {
      const now = Date.now();
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è·å–å¥å­
      if (sentenceCache.length === 0 || 
          now - lastSentenceFetchTime > SENTENCE_CACHE_DURATION ||
          sentenceCacheIndex >= sentenceCache.length) {
        
        const success = await fetchRandomSentences();
        if (!success) {
          return 'æ­£åœ¨åŠªåŠ›ä¸ºæ‚¨æ£€ç´¢ç›¸å…³æ–‡çŒ®...'; // é»˜è®¤æ–‡æœ¬
        }
      }
      
      // è¿”å›å½“å‰å¥å­å¹¶ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª
      const sentence = sentenceCache[sentenceCacheIndex] || 'æ­£åœ¨åŠªåŠ›ä¸ºæ‚¨æ£€ç´¢ç›¸å…³æ–‡çŒ®...';
      sentenceCacheIndex = (sentenceCacheIndex + 1) % sentenceCache.length;
      
      return sentence;
    }

    // æ›´æ–°è¿›åº¦æ¡ä¸Šæ–¹çš„éšæœºæ–‡å­—
    async function updateProgressRandomText(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      let randomTextEl = container.querySelector('.progress-random-text');
      if (!randomTextEl) {
        // åˆ›å»ºéšæœºæ–‡å­—å…ƒç´ 
        randomTextEl = document.createElement('div');
        randomTextEl.className = 'progress-random-text loading';
        randomTextEl.textContent = 'æ­£åœ¨åŠ è½½åŠ±å¿—æ–‡å­—';
        
        // æ’å…¥åˆ°è¿›åº¦æ¡å®¹å™¨ä¹‹å‰
        const progressContainer = container.querySelector('.progress-container');
        if (progressContainer) {
          progressContainer.parentNode.insertBefore(randomTextEl, progressContainer);
        }
      }
      
      // è·å–å¹¶æ˜¾ç¤ºéšæœºå¥å­
      try {
        const sentence = await getNextRandomSentence();
        randomTextEl.textContent = sentence;
        randomTextEl.classList.remove('loading');
      } catch (error) {
        console.error('æ›´æ–°éšæœºæ–‡å­—å¤±è´¥:', error);
        randomTextEl.textContent = 'æ­£åœ¨åŠªåŠ›ä¸ºæ‚¨æ£€ç´¢ç›¸å…³æ–‡çŒ®...';
        randomTextEl.classList.remove('loading');
      }
    }

    // åŠ è½½æ ‡ç­¾æ•°æ®
    async function loadTags() {
      const tagTypes = {
        'journalTypeOptions': 'åˆŠç‰©ç±»å‹',
        'journalSourceOptions': 'åˆŠç‰©æ¥æº', 
        'majorCategoryOptions': 'ä¸€çº§åˆ†ç±»',
        'minorCategoryOptions': 'äºŒçº§åˆ†ç±»'
      };

      for (const [containerId, tagType] of Object.entries(tagTypes)) {
        try {
          const res = await fetch(`/api/tags?type=${encodeURIComponent(tagType)}`);
          const data = await res.json();
          const tags = Array.isArray(data.tags) ? data.tags : [];
          
          const container = document.getElementById(containerId);
          if (tags.length === 0) {
            container.innerHTML = '<div class="loading-text">' + i18n.t('index.no_tags') + '</div>';
            continue;
          }

          container.innerHTML = '';
          tags.forEach(tag => {
            const option = document.createElement('div');
            option.className = 'filter-option';
            // ä½¿ç”¨ data-tag-value å­˜å‚¨åŸå§‹å€¼ï¼Œæ˜¾ç¤ºç¿»è¯‘åçš„å€¼
            const translatedTag = i18n.translateTag(tag);
            option.innerHTML = `
              <input type="checkbox" id="${containerId}_${tag}" value="${tag}" data-tag-value="${tag}">
              <label for="${containerId}_${tag}" data-tag-value="${tag}">${translatedTag}</label>
            `;
            
            const checkbox = option.querySelector('input');
            checkbox.addEventListener('change', async () => {
              updateFilters();
              await reloadPanelsFiltered(tagType);
              loadJournals();
            });
            
            container.appendChild(option);
          });
        } catch (e) {
          console.error(`åŠ è½½${tagType}æ ‡ç­¾å¤±è´¥:`, e);
          document.getElementById(containerId).innerHTML = '<div class="loading-text">' + i18n.t('index.load_failed_short') + '</div>';
        }
      }
    }

    // æ–°å¢ï¼šå½“é€‰æ‹©äº†â€œä¸€çº§åˆ†ç±»â€åï¼ŒæŒ‰å½“å‰ç­›é€‰ä¸Šä¸‹æ–‡åˆ·æ–°â€œå°ç±»å­¦ç§‘â€
    async function reloadMinorTagsFiltered() {
      try {
        const majors = filterTags['ä¸€çº§åˆ†ç±»'] || [];
        const container = document.getElementById('minorCategoryOptions');

        // è‹¥æœªé€‰æ‹©å¤§ç±»ï¼Œåˆ™æ¢å¤ä¸ºå…¨éƒ¨å°ç±»
        if (!majors || majors.length === 0) {
          const res = await fetch(`/api/tags?type=${encodeURIComponent('äºŒçº§åˆ†ç±»')}`);
          const data = await res.json();
          const tags = Array.isArray(data.tags) ? data.tags : [];
          container.innerHTML = '';
          tags.forEach(tag => {
            const option = document.createElement('div');
            option.className = 'filter-option';
            const translatedTag = i18n.translateTag(tag);
            option.innerHTML = `
              <input type="checkbox" id="minorCategoryOptions_${tag}" value="${tag}" data-tag-value="${tag}">
              <label for="minorCategoryOptions_${tag}" data-tag-value="${tag}">${translatedTag}</label>
            `;
            option.querySelector('input').addEventListener('change', () => {
              updateFilters();
              loadJournals();
            });
            container.appendChild(option);
          });
          updateFilters();
          return;
        }

        // ä¼ å…¥å½“å‰ç­›é€‰ä¸Šä¸‹æ–‡ï¼Œåç«¯ä¼šå¿½ç•¥â€œäºŒçº§åˆ†ç±»â€è‡ªèº«ç»´åº¦è¿›è¡Œè¿‡æ»¤
        const selectedParam = encodeURIComponent(JSON.stringify(filterTags));
        const res = await fetch(`/api/tags?type=${encodeURIComponent('äºŒçº§åˆ†ç±»')}&selected=${selectedParam}`);
        const data = await res.json();
        const tags = Array.isArray(data.tags) ? data.tags : [];

        // è®°å½•ä¹‹å‰å·²å‹¾é€‰çš„å°ç±»ï¼Œåˆ·æ–°åä»…ä¿ç•™ä»ç„¶æœ‰æ•ˆçš„é¡¹
        const prevChecked = new Set(
          Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
        );

        container.innerHTML = '';
        tags.forEach(tag => {
          const option = document.createElement('div');
          option.className = 'filter-option';
          const checkedAttr = prevChecked.has(tag) ? 'checked' : '';
          option.innerHTML = `
            <input type="checkbox" id="minorCategoryOptions_${tag}" value="${tag}" ${checkedAttr}>
            <label for="minorCategoryOptions_${tag}">${tag}</label>
          `;
          option.querySelector('input').addEventListener('change', () => {
            updateFilters();
            loadJournals();
          });
          container.appendChild(option);
        });

        // åˆ·æ–°åè¿›è¡Œä¸€æ¬¡ç­›é€‰åŒæ­¥ï¼Œæ¸…ç†å·²ä¸åœ¨åˆ—è¡¨ä¸­çš„å°ç±»
        updateFilters();
      } catch (e) {
        console.error('åˆ·æ–°å°ç±»å­¦ç§‘å¤±è´¥:', e);
        document.getElementById('minorCategoryOptions').innerHTML = '<div class="loading-text">' + i18n.t('index.load_failed_short') + '</div>';
      }
    }

    // é€šç”¨ï¼šæ ¹æ®å½“å‰ç­›é€‰ä¸Šä¸‹æ–‡åˆ·æ–°å…¶å®ƒé¢æ¿æ ‡ç­¾åˆ—è¡¨ï¼ˆexcludeTypeä¸ºå½“å‰å˜æ›´çš„ç»´åº¦ï¼‰
    async function reloadPanelsFiltered(excludeType) {
        try {
            const tagTypeToContainerId = {
                'åˆŠç‰©ç±»å‹': 'journalTypeOptions',
                'åˆŠç‰©æ¥æº': 'journalSourceOptions',
                'ä¸€çº§åˆ†ç±»': 'majorCategoryOptions',
                'äºŒçº§åˆ†ç±»': 'minorCategoryOptions'
            };
            const selectedParam = encodeURIComponent(JSON.stringify(filterTags));

            for (const [type, containerId] of Object.entries(tagTypeToContainerId)) {
                if (excludeType && type === excludeType) continue;

                const container = document.getElementById(containerId);
                if (!container) continue;

                const prevChecked = new Set(
                    Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
                );

                const res = await fetch(`/api/tags?type=${encodeURIComponent(type)}&selected=${selectedParam}`);
                const data = await res.json();
                const tags = Array.isArray(data.tags) ? data.tags : [];

                container.innerHTML = '';
                tags.forEach(tag => {
                    const option = document.createElement('div');
                    option.className = 'filter-option';
                    const checkedAttr = prevChecked.has(tag) ? 'checked' : '';
                    option.innerHTML = `
                      <input type="checkbox" id="${containerId}_${tag}" value="${tag}" ${checkedAttr}>
                      <label for="${containerId}_${tag}">${tag}</label>
                    `;
                    option.querySelector('input').addEventListener('change', async () => {
                        updateFilters();
                        await reloadPanelsFiltered(type);
                        loadJournals();
                    });
                    container.appendChild(option);
                });

                updateFilters();
            }
        } catch (e) {
            console.error('åˆ·æ–°ç­›é€‰æ ‡ç­¾å¤±è´¥:', e);
        }
    }

    // æ›´æ–°ç­›é€‰æ¡ä»¶
    function updateFilters() {
      const tagMappings = {
        'journalTypeOptions': 'åˆŠç‰©ç±»å‹',
        'journalSourceOptions': 'åˆŠç‰©æ¥æº',
        'majorCategoryOptions': 'ä¸€çº§åˆ†ç±»', 
        'minorCategoryOptions': 'äºŒçº§åˆ†ç±»'
      };

      for (const [containerId, tagType] of Object.entries(tagMappings)) {
        const container = document.getElementById(containerId);
        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
        filterTags[tagType] = Array.from(checkboxes).map(cb => cb.value);
      }
    }

    // æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰å·²å‹¾é€‰çš„æ ‡ç­¾
    async function clearAllTagSelections() {
      const containerIds = [
        'journalTypeOptions',
        'journalSourceOptions',
        'majorCategoryOptions',
        'minorCategoryOptions'
      ];
      containerIds.forEach(id => {
        const container = document.getElementById(id);
        if (!container) return;
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
      });
      updateFilters();
      await reloadPanelsFiltered(); // åˆ·æ–°æ‰€æœ‰é¢æ¿ï¼ˆä¸æ’é™¤ï¼‰
      loadJournals();
    }

    // åŠ è½½æœŸåˆŠæ•°æ®
    async function loadJournals() {
      try {
        const includeAllYears = document.getElementById('includeAllYears').checked;
        const startYear = document.getElementById('startYear').value.trim();
        const endYear = document.getElementById('endYear').value.trim();

        const timeRange = {
          include_all: includeAllYears,
          start_year: includeAllYears ? null : (startYear || null),
          end_year: includeAllYears ? null : (endYear || null)
        };

        const payload = {
          time_range: timeRange,
          selected_tags: filterTags
        };

        const res = await fetch('/api/journals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        availableJournals = Array.isArray(data.journals) ? data.journals : [];
        
        // é‡ç½®æœç´¢çŠ¶æ€
        searchKeyword = '';
        filteredJournals = [];
        document.getElementById('journalSearchInput').value = '';
        
        renderAvailableJournals();
        updateCounts();
      } catch (e) {
        console.error('åŠ è½½æœŸåˆŠå¤±è´¥:', e);
        showError(i18n.t('index.load_journals_failed', { msg: e.message }));
      }
    }

    // æ¸²æŸ“å¯é€‰æœŸåˆŠåˆ—è¡¨
    function renderAvailableJournals() {
      const container = document.getElementById('availableJournals');
      
      // åº”ç”¨æœç´¢è¿‡æ»¤
      const journalsToShow = searchKeyword ? filteredJournals : availableJournals;
      
      if (journalsToShow.length === 0) {
        const noResultsText = searchKeyword ? 
        i18n.t('index.no_journals_search', { keyword: searchKeyword }) :
        i18n.t('index.no_journals_filter');
        container.innerHTML = `<div class="empty-text">${noResultsText}</div>`;
        return;
      }

      container.innerHTML = '';
      journalsToShow.forEach(journal => {
        // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
        const isSelected = selectedJournals.some(s => s.name === journal.name);
        if (isSelected) return; // å·²é€‰ä¸­çš„ä¸æ˜¾ç¤ºåœ¨å¯é€‰åˆ—è¡¨ä¸­

        const item = document.createElement('div');
        item.className = 'journal-item';
        item.innerHTML = `
          <div class="journal-name">${journal.name}</div>
          <div class="journal-info">${journal.full_name || ''}</div>
          <div class="journal-info">${journal.data_range || ''} | ${i18n.t('index.updated')}: ${journal.update_date || ''}</div>
          <div class="journal-actions">
            <button class="btn-add" onclick="addJournal('${journal.name}')" data-i18n="index.add_journal">${i18n.t('index.add_journal')}</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    // æ¸²æŸ“å·²é€‰æœŸåˆŠåˆ—è¡¨
    function renderSelectedJournals() {
      const container = document.getElementById('selectedJournals');
      
      if (selectedJournals.length === 0) {
        container.innerHTML = '<div class="empty-text">' + i18n.t('index.add_from_left') + '</div>';
        return;
      }

      container.innerHTML = '';
      selectedJournals.forEach(journal => {
        const item = document.createElement('div');
        item.className = 'selected-item';
        item.innerHTML = `
          <span class="selected-name">${journal.name}</span>
          <button class="btn-remove" onclick="removeJournal('${journal.name}')" data-i18n="index.remove_journal">${i18n.t('index.remove_journal')}</button>
        `;
        container.appendChild(item);
      });
    }

    // æ·»åŠ æœŸåˆŠ
    window.addJournal = function(journalName) {
      const journal = availableJournals.find(j => j.name === journalName);
      if (journal && !selectedJournals.some(s => s.name === journalName)) {
        selectedJournals.push(journal);
        // å¦‚æœå½“å‰æœ‰æœç´¢ï¼Œéœ€è¦ä»æœç´¢ç»“æœä¸­ä¹Ÿç§»é™¤
        if (searchKeyword && filteredJournals.length > 0) {
          filteredJournals = filteredJournals.filter(j => j.name !== journalName);
        }
        renderAvailableJournals();
        renderSelectedJournals();
        updateCounts();
        // è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
        debouncedUpdateStats();
      }
    };

    // ç§»é™¤æœŸåˆŠ
    window.removeJournal = function(journalName) {
      selectedJournals = selectedJournals.filter(j => j.name !== journalName);
      // å¦‚æœå½“å‰æœ‰æœç´¢ï¼Œéœ€è¦é‡æ–°åº”ç”¨æœç´¢è¿‡æ»¤
      if (searchKeyword) {
        searchJournals(searchKeyword);
      } else {
        renderAvailableJournals();
      }
      renderSelectedJournals();
      updateCounts();
      // è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
      debouncedUpdateStats();
    };

    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
    function updateCounts() {
      const journalsToShow = searchKeyword ? filteredJournals : availableJournals;
      const availableCount = journalsToShow.length - selectedJournals.length;
      document.getElementById('availableCount').textContent = `(${availableCount})`;
      document.getElementById('selectedCount').textContent = `(${selectedJournals.length})`;
    }

    // æœç´¢æœŸåˆŠåŠŸèƒ½
    function searchJournals(keyword) {
      searchKeyword = keyword.toLowerCase().trim();
      
      if (!searchKeyword) {
        filteredJournals = [];
        renderAvailableJournals();
        updateCounts();
        return;
      }
      
      // åœ¨nameå’Œfull_nameä¸­æœç´¢
      filteredJournals = availableJournals.filter(journal => {
        const nameMatch = journal.name && journal.name.toLowerCase().includes(searchKeyword);
        const fullNameMatch = journal.full_name && journal.full_name.toLowerCase().includes(searchKeyword);
        return nameMatch || fullNameMatch;
      });
      
      renderAvailableJournals();
      updateCounts();
    }

    // æ›´æ–°UIæ–‡æœ¬ï¼ˆå¤šè¯­è¨€æ”¯æŒï¼‰
    function updateUITexts() {
      // é‡æ–°æ¸²æŸ“æœŸåˆŠåˆ—è¡¨ä»¥æ›´æ–°è¯­è¨€
      renderAvailableJournals();
      renderSelectedJournals();
      
      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
      updateCounts();
      
      // æ›´æ–°å·²é€‰æ‹©æ–‡ç« æ•°çš„æ˜¾ç¤ºï¼ˆä¿æŒå½“å‰å€¼ï¼Œä»…æ›´æ–°è¯­è¨€ï¼‰
      const statusCountEl = document.getElementById('statusCount');
      if (statusCountEl) {
        // ä»å½“å‰æ–‡æœ¬ä¸­æå–æ•°å­—ï¼Œå¦‚æœæå–ä¸åˆ°åˆ™é»˜è®¤ä¸º 0
        const currentText = statusCountEl.textContent;
        const match = currentText.match(/[\d,]+/);
        const currentCount = match ? match[0] : '0';
        statusCountEl.textContent = i18n.t('index.selected_count', {count: currentCount});
      }
      
      // æ›´æ–°ç­›é€‰æ ‡ç­¾çš„ç¿»è¯‘
      document.querySelectorAll('label[data-tag-value]').forEach(label => {
        const tagValue = label.getAttribute('data-tag-value');
        if (tagValue) {
          label.textContent = i18n.translateTag(tagValue);
        }
      });
      
      // æ›´æ–°ç”¨æˆ·ä½™é¢æ˜¾ç¤ºï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
      if (userBalanceCache !== null) {
        const balanceEl = document.getElementById('userBalance');
        if (balanceEl && userBalanceCache !== i18n.t('index.login_required') && 
            userBalanceCache !== i18n.t('index.loading_short') && 
            userBalanceCache !== i18n.t('index.fetch_failed')) {
          // å¦‚æœä½™é¢æ˜¯æ•°å­—ï¼Œä¿æŒåŸå€¼ï¼Œå¦åˆ™é‡æ–°è·å–
          if (!/^\d+(\.\d+)?\s*/.test(userBalanceCache)) {
            fetchUserBalance();
          }
        }
      }
      
      // æ›´æ–°å†å²è®°å½•åˆ—è¡¨ä¸­çš„åŠ¨æ€æ–‡æœ¬
      const historyItems = document.querySelectorAll('.history-item');
      if (historyItems.length > 0) {
        // ç›´æ¥æ›´æ–°å†å²è®°å½•é¡¹çš„çŠ¶æ€æ–‡æœ¬å’Œç©ºæ ‡é¢˜
        historyItems.forEach(item => {
          // æ›´æ–°çŠ¶æ€æ–‡æœ¬ï¼ˆä¿®å¤10: æ”¯æŒä¸‰æ€çŠ¶æ€æ˜¾ç¤ºï¼‰
          const meta = item.querySelector('.history-item-meta');
          if (meta && meta.hasAttribute('data-datetime') && meta.hasAttribute('data-completed')) {
            const dateTime = meta.getAttribute('data-datetime');
            const completed = meta.getAttribute('data-completed') === 'true';
            const paused = meta.getAttribute('data-paused') === 'true';
            let status;
            if (completed) {
              status = i18n.t('history.status_done');
            } else if (paused) {
              status = i18n.t('index.status_paused');
            } else {
              status = i18n.t('history.status_running');
            }
            meta.textContent = `${dateTime} | ${status}`;
          }
          
          // æ›´æ–°ç©ºæ ‡é¢˜
          const title = item.querySelector('.history-item-title');
          if (title && title.hasAttribute('data-is-empty-title')) {
            const emptyText = i18n.t('history.research_question_empty');
            title.textContent = emptyText;
            title.title = emptyText;
          }
          
        });
        
        // é‡æ–°åŠ è½½å†å²è®°å½•ä»¥æ›´æ–°è¯­è¨€ï¼Œä½†ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        loadHistoryQuietly();
      }
      
      // æ›´æ–°è¿›åº¦ç›¸å…³çš„åŠ¨æ€æ–‡æœ¬
      const progressStatus = document.getElementById('progressStatus');
      if (progressStatus && progressStatus.textContent) {
        // æ ¹æ®å½“å‰çŠ¶æ€é‡æ–°è®¾ç½®æ–‡æœ¬
        if (progressStatus.textContent.includes('è¿è¡Œ') || progressStatus.textContent.includes('Running')) {
          progressStatus.textContent = i18n.t('index.status_running');
          progressStatus.setAttribute('data-i18n', 'index.status_running');
        } else if (progressStatus.textContent.includes('æš‚åœ') || progressStatus.textContent.includes('Paused')) {
          progressStatus.textContent = i18n.t('index.status_paused');
          progressStatus.setAttribute('data-i18n', 'index.status_paused');
        }
      }
      
      // æ›´æ–°æš‚åœ/æ¢å¤æŒ‰é’®æ–‡æœ¬
      const pauseResumeBtn = document.getElementById('pauseResumeBtn');
      if (pauseResumeBtn && pauseResumeBtn.style.display !== 'none') {
        const btnText = pauseResumeBtn.querySelector('span');
        if (btnText) {
          const currentText = btnText.textContent;
          if (currentText.includes('æ¢å¤') || currentText.includes('Resume')) {
            btnText.textContent = i18n.t('index.resume');
            btnText.setAttribute('data-i18n', 'index.resume');
          } else if (currentText.includes('æš‚åœ') || currentText.includes('Pause')) {
            btnText.textContent = i18n.t('index.pause');
            btnText.setAttribute('data-i18n', 'index.pause');
          }
        }
      }
      
      // æ›´æ–°è’¸é¦å¡ç‰‡ä¸­çš„åŠ¨æ€æ–‡æœ¬
      activeDistillCards.forEach((cardData, cardId) => {
        updateDistillCardTexts(cardId);
      });
      
      // æ›´æ–°æœç´¢æ‘˜è¦ä¸­çš„æˆæœ¬æ˜¾ç¤º
      const summaryCostEl = document.getElementById('summaryCost');
      if (summaryCostEl && summaryCostEl.hasAttribute('data-search-cost')) {
        const cost = summaryCostEl.getAttribute('data-search-cost');
        summaryCostEl.textContent = `${cost} ${i18n.t('common.credit_unit')}`;
      }
      
      // æ›´æ–°æˆæœ¬çŠ¶æ€æ˜¾ç¤º
      const costCountEl = document.getElementById('costCount');
      if (costCountEl && costCountEl.hasAttribute('data-cost-value')) {
        const cost = costCountEl.getAttribute('data-cost-value');
        costCountEl.textContent = i18n.t('index.estimated_cost', {cost: parseInt(cost).toLocaleString()});
      }
    }

    // é™é»˜åŠ è½½å†å²è®°å½•ï¼ˆç”¨äºè¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°ï¼‰
    async function loadHistoryQuietly() {
      const token = localStorage.getItem('userToken');
      
      if (!token) {
        return;
      }
      
      try {
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenä¸­è·å–ï¼‰
        const response = await authFetch('/api/query_history');
        if (!response.ok) {
          return;
        }
        
        const data = await response.json();
        if (!data.success) {
          return;
        }
        
        const logs = data.logs || [];
        if (logs.length > 0) {
          renderHistoryList(logs);
        }
      } catch (error) {
        console.error('Failed to quietly load history:', error);
      }
    }

    // æ›´æ–°è’¸é¦å¡ç‰‡ä¸­çš„æ–‡æœ¬
    function updateDistillCardTexts(cardId) {
      // æ›´æ–°è’¸é¦å¡ç‰‡ä¸­çš„å„ç§æ–‡æœ¬å…ƒç´ 
      const card = document.getElementById(cardId);
      if (!card) return;
      
      // æ›´æ–°æŒ‰é’®æ–‡æœ¬
      const startBtn = card.querySelector('.btn-primary');
      if (startBtn && startBtn.textContent) {
        const btnText = startBtn.querySelector('span');
        if (btnText) {
          const currentText = btnText.textContent;
          if (currentText.includes('å¼€å§‹') || currentText.includes('Start')) {
            btnText.textContent = i18n.t('distill.start');
          } else if (currentText.includes('å¯åŠ¨') || currentText.includes('Starting')) {
            btnText.textContent = i18n.t('distill.starting');
          }
        }
      }
      
      // æ›´æ–°çŠ¶æ€æ–‡æœ¬
      const statusEl = card.querySelector('.status');
      if (statusEl && statusEl.textContent) {
        if (statusEl.textContent.includes('å‡†å¤‡') || statusEl.textContent.includes('Ready')) {
          statusEl.textContent = i18n.t('distill.status_desc');
        }
      }
    }

    // æ¸…ç©ºå…¨éƒ¨
    document.getElementById('clearAllBtn').addEventListener('click', function() {
      selectedJournals = [];
      renderAvailableJournals();
      renderSelectedJournals();
      updateCounts();
      // æ¸…ç©ºåé‡ç½®ç»Ÿè®¡æ˜¾ç¤º
      document.querySelector('#statusCount').textContent = i18n.t('index.selected_count', {count: 0});
      const costCountEl = document.getElementById('costCount');
      if (costCountEl) {
        costCountEl.textContent = i18n.t('index.estimated_cost', {cost: 0});
        costCountEl.setAttribute('data-cost-value', '0');
      }
      document.getElementById('costStatus').style.display = 'none';
    });

    // æœç´¢è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
    document.getElementById('journalSearchInput').addEventListener('input', function(e) {
      searchJournals(e.target.value);
    });

    // æœç´¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    document.getElementById('journalSearchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchJournals(e.target.value);
      }
    });

    // ç­›é€‰é¢æ¿å±•å¼€/æ”¶èµ·
    document.addEventListener('click', function(e) {
      if (e.target.closest('.filter-label')) {
        const label = e.target.closest('.filter-label');
        const options = label.nextElementSibling;
        const icon = label.querySelector('.expand-icon');
        
        const isExpanded = options.classList.contains('expanded');
        
        if (isExpanded) {
          options.classList.remove('expanded');
          label.classList.remove('expanded');
          icon.classList.remove('rotated');
        } else {
          options.classList.add('expanded');
          label.classList.add('expanded');
          icon.classList.add('rotated');
        }
      }
    });

    // å¹´ä»½æ§åˆ¶
    document.getElementById('includeAllYears').addEventListener('change', function() {
      const startYear = document.getElementById('startYear');
      const endYear = document.getElementById('endYear');
      
      if (this.checked) {
        startYear.disabled = true;
        endYear.disabled = true;
        startYear.style.opacity = '0.5';
        endYear.style.opacity = '0.5';
      } else {
        startYear.disabled = false;
        endYear.disabled = false;
        startYear.style.opacity = '1';
        endYear.style.opacity = '1';
      }
      
      loadJournals(); // é‡æ–°åŠ è½½æœŸåˆŠ
      // è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
      debouncedUpdateStats();
    });

    // å¹´ä»½è¾“å…¥å˜åŒ–æ—¶é‡æ–°åŠ è½½
    document.getElementById('startYear').addEventListener('change', function() {
      loadJournals();
      // è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
      debouncedUpdateStats();
    });
    document.getElementById('endYear').addEventListener('change', function() {
      loadJournals();
      // è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
      debouncedUpdateStats();
    });

    // æ›´æ–°ç»Ÿè®¡
    async function updateStats() {
      setLoading(true);
      try {
        const question = document.getElementById('question').value.trim();
        const requirements = document.getElementById('requirements').value.trim();
        const includeAllYears = document.getElementById('includeAllYears').checked;
        const startYear = document.getElementById('startYear').value.trim();
        const endYear = document.getElementById('endYear').value.trim();

        if (selectedJournals.length === 0) {
          showError(i18n.t('index.need_select_journal'));
          return;
        }

        const selectedNames = selectedJournals.map(j => j.name);

        const payload = {
          question,
          requirements,
          include_all_years: includeAllYears,
          start_year: startYear,
          end_year: endYear,
          selected_journals: selectedNames
        };

        const res = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${res.status}`);
        }

        const data = await res.json();
        const cnt = typeof data.selected_count === 'number' ? data.selected_count : 0;
        const cost = typeof data.estimated_cost === 'number' ? data.estimated_cost : 0;
        
        document.querySelector('#statusCount').textContent = i18n.t('index.selected_count', {count: cnt.toLocaleString()});
        
        // æ˜¾ç¤ºé¢„è®¡èŠ±è´¹
        const costStatusEl = document.getElementById('costStatus');
        const costCountEl = document.getElementById('costCount');
        if (cost > 0) {
          costCountEl.textContent = i18n.t('index.estimated_cost', {cost: cost.toLocaleString()});
          costCountEl.setAttribute('data-cost-value', cost); // å­˜å‚¨æˆæœ¬å€¼ä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
          costStatusEl.style.display = 'flex';
        } else {
          costStatusEl.style.display = 'none';
        }
        
        if (cnt > 0) {
          showSuccess(i18n.t('index.update_success', {count: cnt.toLocaleString()}));
        } else {
          showError(i18n.t('index.update_empty'));
        }
        
      } catch (e) {
        console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥', e);
        showError(i18n.t('index.update_stats_failed', { msg: e.message }));
      } finally {
        setLoading(false);
      }
    }

    // æ–°å¢ï¼šå¼€å§‹æ£€ç´¢ï¼ˆæ”¹ä¸ºå®é™…è°ƒç”¨åç«¯å†™å…¥ query_logï¼‰
    async function startSearch() {
      console.log('startSearch å‡½æ•°è¢«è°ƒç”¨');
      
      try {
        const uid = parseInt(localStorage.getItem('userId'), 10);
        if (!uid) {
          showError(i18n.t('index.login_missing'));
          window.location.href = '/login.html';
          return;
        }
    
        const question = document.getElementById('question').value.trim();
        const requirements = document.getElementById('requirements').value.trim();
        const includeAllYears = document.getElementById('includeAllYears').checked;
        const startYear = document.getElementById('startYear').value.trim();
        const endYear = document.getElementById('endYear').value.trim();
    
        // å‰ç«¯æ ¡éªŒä¸‰æ¡ä»¶
        if (!question) {
          showError(i18n.t('index.err_no_question'));
          return;
        }
        if (!includeAllYears) {
          const yearRe = /^\d{4}$/;
          if (!yearRe.test(startYear) || !yearRe.test(endYear)) {
            showError(i18n.t('index.err_invalid_year'));
            return;
          }
          const sy = parseInt(startYear, 10), ey = parseInt(endYear, 10);
          if (ey < sy) {
            showError(i18n.t('index.err_year_order'));
            return;
          }
        }

        if (selectedJournals.length === 0) {
          showError(i18n.t('index.need_select_journal'));
          return;
        }

        const selectedNames = selectedJournals.map(j => j.name);
    
        console.log('å‡†å¤‡å‘é€è¯·æ±‚åˆ° /api/start_search');
    
        // å®‰å…¨åŸåˆ™ï¼šä¸ä¼ é€’è´¹ç”¨å‚æ•°å’Œuidï¼Œç”±åç«¯ç‹¬ç«‹è®¡ç®—å’Œä»tokenè·å–
        // ä¿®å¤37: uidä»tokenä¸­è·å–ï¼Œä¸å†åœ¨payloadä¸­ä¼ é€’
        const payload = {
          question,
          requirements,
          include_all_years: includeAllYears,
          start_year: startYear,
          end_year: endYear,
          selected_journals: selectedNames,
          language: i18n.getLang()  // ä¿®å¤36: ä¼ é€’å½“å‰è¯­è¨€ ('zh' æˆ– 'en')
        };
    
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
        const res = await authFetch('/api/start_search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
    
        console.log('API å“åº”çŠ¶æ€:', res.status);
        
        const data = await res.json();
        console.log('API å“åº”æ•°æ®:', data);
        
        if (!res.ok || !data.success) {
          // ç‰¹æ®Šå¤„ç†ä½™é¢ä¸è¶³é”™è¯¯
          if (data.error === 'insufficient_balance') {
            showError(i18n.t('index.insufficient_balance') || 'ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•');
            return;
          }
          const msg = data.message || data.error || ('HTTP ' + res.status);
          throw new Error(msg);
        }
    
        // æˆåŠŸåæ˜¾ç¤ºè¯´æ˜è§†å›¾å¡ç‰‡
        console.log('æ£€ç´¢åˆ›å»ºæˆåŠŸï¼Œæ˜¾ç¤ºè¯´æ˜è§†å›¾');
        showSearchSummary({
          question,
          requirements,
          includeAllYears,
          startYear,
          endYear,
          selectedJournals: selectedNames,
          queryIndex: data.query_id,
          articleCount: data.article_count || 0,
          estimatedCost: data.estimated_cost || 0
        });

        // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
        loadHistory();
        
      } catch (e) {
        console.error('å¼€å§‹æ£€ç´¢å¤±è´¥', e);
        showError(i18n.t('index.start_search_failed', { msg: e.message }));
      }
    }

    // æ˜¾ç¤ºæ£€ç´¢è¯´æ˜è§†å›¾å¡ç‰‡
    function showSearchSummary(searchData) {
      // éšè—è¾“å…¥åŒºåŸŸ
      const inputSection = document.getElementById('inputSection');
      const summaryCard = document.getElementById('searchSummaryCard');
      
      // å¼ºåˆ¶éšè—è¾“å…¥å®¹å™¨ï¼Œé¿å…æ ·å¼è¦†ç›–å¯¼è‡´æœªéšè—
  inputSection.style.display = 'none';
  inputSection.classList.add('hidden');

  // æ˜¾ç¤ºæ‘˜è¦å®¹å™¨
  summaryCard.style.display = 'block';
      
      // å¡«å……æ•°æ®
      // ä¿®å¤39: å¡«å……ä»»åŠ¡ID
      document.getElementById('summaryQueryId').textContent = searchData.queryIndex || '';
      document.getElementById('summaryQuestion').textContent = searchData.question;
      document.getElementById('summaryRequirements').textContent = searchData.requirements || '';
      
      // æ—¶é—´èŒƒå›´
      let timeRangeText;
      if (searchData.includeAllYears) {
        timeRangeText = i18n.t('index.all_years');
      } else {
        timeRangeText = `${searchData.startYear} - ${searchData.endYear}`;
      }
      document.getElementById('summaryTimeRange').textContent = timeRangeText;
      
      // å·²é€‰æœŸåˆŠ
      const journalsText = searchData.selectedJournals.join(', ');
      document.getElementById('summaryJournals').textContent = journalsText;
      
      // å¼€å§‹æ—¶é—´ï¼ˆå½“å‰æ—¶é—´ï¼ŒUTC+8æ—¶åŒºï¼‰
      const now = new Date();
      // è½¬æ¢ä¸ºUTC+8æ—¶åŒº
      const utc8Now = new Date(now.getTime() + (8 * 60 * 60 * 1000));
      
      const year = utc8Now.getUTCFullYear();
      const month = String(utc8Now.getUTCMonth() + 1).padStart(2, '0');
      const day = String(utc8Now.getUTCDate()).padStart(2, '0');
      const hour = String(utc8Now.getUTCHours()).padStart(2, '0');
      const minute = String(utc8Now.getUTCMinutes()).padStart(2, '0');
      const startTimeText = `${year}-${month}-${day} ${hour}:${minute}`;
      document.getElementById('summaryStartTime').textContent = startTimeText;
      
      // è®¾ç½®å…¨å±€å¼€å§‹æ—¶é—´å˜é‡
      currentStartTime = utc8Now;
      
      // ç»Ÿè®¡ä¿¡æ¯
      document.getElementById('summaryArticleCount').textContent = searchData.articleCount.toLocaleString();
      const summaryCostEl = document.getElementById('summaryCost');
      summaryCostEl.textContent = `${searchData.estimatedCost} ${i18n.t('common.credit_unit')}`;
      summaryCostEl.setAttribute('data-search-cost', searchData.estimatedCost); // å­˜å‚¨æˆæœ¬æ•°æ®ä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
      
      // åœ¨å†å²è®°å½•ä¸­é«˜äº®å½“å‰æ£€ç´¢
        highlightCurrentSearch(searchData.queryIndex);
        
        // è®¾ç½®å½“å‰ä¼šè¯
        setCurrentSession(searchData.queryIndex);
        
        // å¼€å§‹è¿›åº¦è½®è¯¢
        startProgressPolling(searchData.queryIndex);
    }

    // å…¨å±€å˜é‡å­˜å‚¨å½“å‰è½®è¯¢çŠ¶æ€
    let currentProgressInterval = null;
    let currentQueryIndex = null;
    let currentStartTime = null;
    // æš‚å­˜ç”¨æˆ·ç‚¹å‡»åæœŸæœ›çš„æš‚åœçŠ¶æ€ï¼ˆtrue=å·²æš‚åœï¼Œfalse=è¿è¡Œä¸­ï¼Œnull=æ— æœŸæœ›/å·²åŒæ­¥ï¼‰
    let intendedShouldPause = null;
    // ä»æœåŠ¡å™¨è·å–åˆ°çš„å½“å‰æš‚åœçŠ¶æ€
    let currentShouldPause = false;
    // æš‚å­˜æœ€åä¸€æ¬¡è¿›åº¦å€¼ï¼Œç”¨äºæš‚åœæ—¶å†»ç»“è¿›åº¦æ¡
    let lastProgress = 0;

    // å¼€å§‹è¿›åº¦è½®è¯¢
    function startProgressPolling(queryIndex) {
      // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
      if (currentProgressInterval) {
        clearInterval(currentProgressInterval);
      }
      
      currentQueryIndex = queryIndex;
      // å¼€å§‹æ–°çš„æ£€ç´¢æ—¶ï¼Œæ¸…ç©ºæœŸæœ›çŠ¶æ€
      intendedShouldPause = null;
      
      // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
      const progressSection = document.getElementById('progressSection');
      const completionSection = document.getElementById('completionSection');
      progressSection.style.display = 'block';
      completionSection.style.display = 'none';
      
      // è®¾ç½®æš‚åœ/æ¢å¤æŒ‰é’®
      setupPauseResumeButton();
      
      // æ·»åŠ éšæœºæ–‡å­—æ˜¾ç¤º
      updateProgressRandomText('progressSection');
      
      // å¼€å§‹è½®è¯¢
      currentProgressInterval = setInterval(async () => {
        try {
          // ä¿®å¤37: å¹¶å‘è·å–è¿›åº¦ä¸æš‚åœçŠ¶æ€ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼‰
          const progressReq = authFetch(`/api/query_progress?query_id=${encodeURIComponent(queryIndex)}`);
          const historyReq = authFetch('/api/query_history');

          const [progressRes, historyRes] = await Promise.all([
            progressReq,
            historyReq
          ]);

          if (!progressRes || !progressRes.ok) return;
          const progressData = await progressRes.json();

          // åˆ·æ–°å½“å‰æš‚åœçŠ¶æ€
          if (historyRes && historyRes.ok) {
            const historyData = await historyRes.json();
            if (historyData.success && Array.isArray(historyData.logs)) {
              const log = historyData.logs.find(l => l.query_id === queryIndex);
              if (log) currentShouldPause = !!log.should_pause;
            }
          }

          // æ›´æ–°UIï¼ˆæ ¹æ®æš‚åœçŠ¶æ€é€‚é…ï¼‰
          updateProgressDisplay(progressData);

          // å®æ—¶æ›´æ–°ç”¨æˆ·ä½™é¢æ˜¾ç¤º
          if (progressData.current_balance !== undefined && progressData.current_balance !== null) {
              userBalanceCache = progressData.current_balance;
              const balanceEl = document.getElementById('userBalance');
              if (balanceEl) {
                  balanceEl.textContent = progressData.current_balance;
              }
          }

          if (progressData.completed) {
            // ä»»åŠ¡å®Œæˆ
            clearInterval(currentProgressInterval);
            currentProgressInterval = null;
            showCompletionSection(queryIndex, progressData);
          }
        } catch (error) {
          console.error('Progress polling error:', error);
        }
      }, 2000);
    }

    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    function updateProgressDisplay(data) {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      const progress = Math.max(0, Math.min(100, Number(data.progress || 0)));

      // è®¡ç®—æœ‰æ•ˆæš‚åœçŠ¶æ€ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·æœŸæœ›ï¼Œå…¶æ¬¡ä½¿ç”¨æœåŠ¡å™¨çŠ¶æ€
      const effectiveShouldPause = (intendedShouldPause !== null)
        ? intendedShouldPause
        : currentShouldPause;

      // æš‚åœæ—¶å†»ç»“è¿›åº¦æ˜¾ç¤ºï¼›è¿è¡Œæ—¶æ›´æ–°å¹¶è®°ä½æœ€åå€¼
      if (effectiveShouldPause) {
        progressFill.style.width = lastProgress + '%';
        progressText.textContent = lastProgress + '%';
      } else {
        lastProgress = progress;
        progressFill.style.width = progress + '%';
        progressText.textContent = progress + '%';
      }

      // æ›´æ–°çŠ¶æ€æ–‡æœ¬ä¸æŒ‰é’®
      updateProgressStatus(!effectiveShouldPause);
      updatePauseResumeButton(effectiveShouldPause);
    }

    // è®¾ç½®æš‚åœ/æ¢å¤æŒ‰é’®å’Œç»ˆæ­¢æŒ‰é’®
    function setupPauseResumeButton() {
      const pauseResumeBtn = document.getElementById('pauseResumeBtn');
      const terminateBtn = document.getElementById('terminateBtn');
      
      pauseResumeBtn.style.display = 'block';
      terminateBtn.style.display = 'block';
      
      // ä½¿ç”¨ onclickï¼Œé¿å…é‡å¤ç»‘å®šå¯¼è‡´å¤šæ¬¡è§¦å‘
      pauseResumeBtn.onclick = handlePauseResume;
      terminateBtn.onclick = handleTerminate;
    }
    
    // å¤„ç†ç»ˆæ­¢ä»»åŠ¡ï¼ˆä¿®å¤12ï¼šä¸ºæ™®é€šç”¨æˆ·æ·»åŠ ç»ˆæ­¢åŠŸèƒ½ï¼‰
    async function handleTerminate() {
      if (!currentQueryIndex) return;
      
      const uid = localStorage.getItem('userId');
      if (!uid) {
        alert(i18n.t('common.login_required'));
        return;
      }
      
      // ç¡®è®¤æç¤º
      if (!confirm(i18n.t('index.terminate_confirm'))) {
        return;
      }
      
      try {
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
        const response = await authFetch('/api/cancel_query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: currentQueryIndex
          })
        });
        
        const data = await response.json();
        if (response.ok && data.success) {
          showSuccess(i18n.t('index.terminate_success'));
          
          // åœæ­¢è¿›åº¦è½®è¯¢
          if (currentProgressInterval) {
            clearInterval(currentProgressInterval);
            currentProgressInterval = null;
          }
          
          // æ˜¾ç¤ºç»ˆæ­¢å®Œæˆç•Œé¢ï¼ˆä¿®å¤12bï¼šæ˜¾ç¤ºå¯ä¸‹è½½éƒ¨åˆ†ç»“æœçš„ç•Œé¢ï¼‰
          showTerminatedSection(currentQueryIndex);
          
          // åˆ·æ–°å†å²è®°å½•
          loadHistory();
        } else {
          showError(i18n.t('index.terminate_fail') + ': ' + (data.message || data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Terminate error:', error);
        showError(i18n.t('index.terminate_fail') + ': ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºç»ˆæ­¢åçš„å®Œæˆç•Œé¢ï¼ˆä¿®å¤12bï¼šä»»åŠ¡ç»ˆæ­¢åæ˜¾ç¤ºå¯ä¸‹è½½éƒ¨åˆ†ç»“æœçš„ç•Œé¢ï¼‰
    function showTerminatedSection(queryIndex) {
      const progressSection = document.getElementById('progressSection');
      const completionSection = document.getElementById('completionSection');
      
      progressSection.style.display = 'none';
      completionSection.style.display = 'block';
      
      // æ›´æ–°æ ‡é¢˜ä¸ºç»ˆæ­¢ä¸“ç”¨æ–‡æœ¬
      const completionTitle = completionSection.querySelector('h4[data-i18n]');
      if (completionTitle) {
        completionTitle.textContent = i18n.t('index.terminate_complete');
        completionTitle.setAttribute('data-i18n', 'index.terminate_complete');
      }
      
      // è®¾ç½®å®Œæˆåçš„æŒ‰é’®äº‹ä»¶ï¼ˆä¸æ­£å¸¸å®Œæˆç›¸åŒï¼‰
      setupCompletionButtons(queryIndex, {});
    }

    // æ›´æ–°æš‚åœ/æ¢å¤æŒ‰é’®çŠ¶æ€
    function updatePauseResumeButton(isPaused) {
      const pauseResumeBtn = document.getElementById('pauseResumeBtn');
      const btnText = pauseResumeBtn.querySelector('span');
      
      if (isPaused) {
        btnText.textContent = i18n.t('index.resume');
        btnText.setAttribute('data-i18n', 'index.resume');
      } else {
        btnText.textContent = i18n.t('index.pause');
        btnText.setAttribute('data-i18n', 'index.pause');
      }
    }

    // å¤„ç†æš‚åœ/æ¢å¤
    async function handlePauseResume() {
      if (!currentQueryIndex) return;
      
      const uid = localStorage.getItem('userId');
      if (!uid) {
        alert(i18n.t('common.login_required'));
        return;
      }

      try {
        // è®¡ç®—å½“å‰çŠ¶æ€ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·æœŸæœ›ï¼Œå…¶æ¬¡ä½¿ç”¨å·²çŸ¥çš„æœåŠ¡å™¨çŠ¶æ€
        const isPaused = (intendedShouldPause !== null)
          ? intendedShouldPause
          : (typeof currentShouldPause === 'boolean' ? currentShouldPause : false);

        const newShouldPause = !isPaused;

        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
        const updateResponse = await authFetch('/api/update_pause_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: currentQueryIndex,
            should_pause: newShouldPause
          })
        });

        const updateData = await updateResponse.json();
        if (updateResponse.ok && updateData.success) {
          const successMessage = isPaused ? i18n.t('index.resume_success') : i18n.t('index.pause_success');
          showSuccess(successMessage);

          // æ›´æ–°æœ¬åœ°çŠ¶æ€å¹¶åˆ·æ–°UI
          intendedShouldPause = newShouldPause;
          currentShouldPause = newShouldPause;

          updatePauseResumeButton(newShouldPause);
          updateProgressStatus(!newShouldPause);

          // æš‚åœæ—¶ç«‹å³å†»ç»“åˆ°æœ€åè¿›åº¦å€¼
          if (newShouldPause) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressFill.style.width = lastProgress + '%';
            progressText.textContent = lastProgress + '%';
          }
          
          // ä¿®å¤11: åˆ·æ–°ä¾§è¾¹æ å†å²è®°å½•ä»¥æ›´æ–°çŠ¶æ€æ˜¾ç¤º
          loadHistory();
        } else {
          const failMessage = isPaused ? i18n.t('index.resume_fail') : i18n.t('index.pause_fail');
          showError(failMessage + ': ' + (updateData.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Pause/Resume error:', error);
        showError(i18n.t('index.operation_failed') + ': ' + error.message);
      }
    }

    // æ›´æ–°è¿›åº¦çŠ¶æ€æ–‡æœ¬
    function updateProgressStatus(isRunning) {
      const progressStatus = document.getElementById('progressStatus');
      if (isRunning) {
        progressStatus.textContent = i18n.t('index.status_running');
        progressStatus.setAttribute('data-i18n', 'index.status_running');
      } else {
        progressStatus.textContent = i18n.t('index.status_paused');
        progressStatus.setAttribute('data-i18n', 'index.status_paused');
      }
    }

    // æ˜¾ç¤ºå®Œæˆåçš„æŒ‰é’®åŒºåŸŸ
    function showCompletionSection(queryIndex, progressData) {
      const progressSection = document.getElementById('progressSection');
      const completionSection = document.getElementById('completionSection');
      
      progressSection.style.display = 'none';
      completionSection.style.display = 'block';
      
      // è®¾ç½®å®Œæˆåçš„æŒ‰é’®äº‹ä»¶
      setupCompletionButtons(queryIndex, progressData);
      
      // æ›´æ–°å†å²è®°å½•åˆ—è¡¨
      loadHistory();
    }

    // é€šç”¨å¼‚æ­¥ä¸‹è½½å‡½æ•°ï¼ˆä½¿ç”¨æ–°çš„å¼‚æ­¥é˜Ÿåˆ—APIï¼‰- ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
    async function downloadWithAsyncQueue(btn, queryId, downloadType) {
      const token = localStorage.getItem('userToken');
      if (!token) {
        showError(i18n.t('index.login_required'));
        return;
      }
      
      const originalHtml = btn.innerHTML;
      const originalDisabled = btn.disabled;
      
      try {
        // æ˜¾ç¤ºloadingçŠ¶æ€
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-small"></span> ${i18n.t('index.download_generating')}`;
        
        // ä¿®å¤37: åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼Œuidä»tokenè·å–ï¼‰
        const createResp = await authFetch('/api/download/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryId,
            type: downloadType
          })
        });
        
        const createData = await createResp.json();
        if (!createData.success || !createData.task_id) {
          throw new Error(createData.error || 'Failed to create download task');
        }
        
        const taskId = createData.task_id;
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        let attempts = 0;
        const maxAttempts = 120; // æœ€å¤šç­‰å¾…2åˆ†é’Ÿ
        
        while (attempts < maxAttempts) {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
          const statusResp = await authFetch(`/api/download/status?task_id=${encodeURIComponent(taskId)}`);
          const status = await statusResp.json();
          
          if (status.state === 'READY') {
            // æ–‡ä»¶å·²å°±ç»ªï¼Œè§¦å‘ä¸‹è½½
            window.location.href = `/api/download/file?task_id=${encodeURIComponent(taskId)}`;
            showSuccess(i18n.t('index.download_success'));
            break;
          } else if (status.state === 'FAILED') {
            throw new Error(status.error || 'Download generation failed');
          } else {
            // ç»§ç»­ç­‰å¾…
            btn.innerHTML = `<span class="spinner-small"></span> ${i18n.t('index.download_processing')}`;
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
          }
        }
        
        if (attempts >= maxAttempts) {
          throw new Error('Download timeout');
        }
        
      } catch (error) {
        console.error('Download error:', error);
        showError(i18n.t('index.download_failed') + ': ' + error.message);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = originalDisabled;
        btn.innerHTML = originalHtml;
      }
    }

    // è®¾ç½®å®Œæˆåçš„æŒ‰é’®äº‹ä»¶
    function setupCompletionButtons(queryIndex, progressData) {
      const downloadCsvBtn = document.getElementById('downloadCsvBtn');
      const downloadBibBtn = document.getElementById('downloadBibBtn');
      const distillBtn = document.getElementById('distillBtn');
      
      // ä¸‹è½½CSVæŒ‰é’®ï¼ˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—ï¼‰
      downloadCsvBtn.onclick = () => {
        downloadWithAsyncQueue(downloadCsvBtn, queryIndex, 'csv');
      };
      
      // ä¸‹è½½BIBæŒ‰é’®ï¼ˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—ï¼‰
      downloadBibBtn.onclick = () => {
        downloadWithAsyncQueue(downloadBibBtn, queryIndex, 'bib');
      };
      
      // è’¸é¦æŒ‰é’®
      if (distillBtn) {
        distillBtn.onclick = () => {
          createDistillInputCard(queryIndex);
        };
      }
    }

    // æŠ˜å æœç´¢æ‘˜è¦å¡ç‰‡
    function collapseSearchSummaryCard() {
      const summaryCard = document.getElementById('searchSummaryCard');
      if (summaryCard) {
        summaryCard.style.display = 'none';
      }
    }

    // å†å²è®°å½•çš„æš‚åœ/æ¢å¤åŠŸèƒ½
    window.toggleHistoryProgress = async function(queryIndex) {
      const uid = localStorage.getItem('userId');
      if (!uid) {
        showError(i18n.t('index.login_required'));
        return;
      }

      const pauseBtn = document.getElementById(`historyPauseResumeBtn_${queryIndex}`);
      if (!pauseBtn) return;

      try {
        const isPaused = pauseBtn.textContent.includes(i18n.t('index.resume'));
        const action = isPaused ? 'resume' : 'pause';
        
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
        const response = await authFetch('/api/update_pause_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryIndex,
            should_pause: action === 'pause'
          })
        });

        const data = await response.json();
        if (data.success) {
          pauseBtn.innerHTML = `<span data-i18n="index.${isPaused ? 'pause' : 'resume'}">${isPaused ? i18n.t('index.pause') : i18n.t('index.resume')}</span>`;
          showSuccess(isPaused ? i18n.t('index.resume_success') : i18n.t('index.pause_success'));
        } else {
          showError((isPaused ? i18n.t('index.resume_fail') : i18n.t('index.pause_fail')) + ': ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Toggle progress error:', error);
        showError(i18n.t('index.operation_failed') + ': ' + error.message);
      }
    };

    // å†å²è®°å½•çš„ç»ˆæ­¢åŠŸèƒ½ï¼ˆä¿®å¤12ï¼‰
    window.terminateHistoryTask = async function(queryIndex) {
      const uid = localStorage.getItem('userId');
      if (!uid) {
        showError(i18n.t('index.login_required'));
        return;
      }
      
      // ç¡®è®¤æç¤º
      if (!confirm(i18n.t('index.terminate_confirm'))) {
        return;
      }
      
      try {
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
        const response = await authFetch('/api/cancel_query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryIndex
          })
        });
        
        const data = await response.json();
        if (data.success) {
          showSuccess(i18n.t('index.terminate_success'));
          
          // åœæ­¢è¯¥ä»»åŠ¡çš„è¿›åº¦è½®è¯¢
          if (window.historyProgressIntervals && window.historyProgressIntervals[queryIndex]) {
            clearInterval(window.historyProgressIntervals[queryIndex]);
            delete window.historyProgressIntervals[queryIndex];
          }
          
          // ä¿®å¤12b: æ›´æ–°å†å²å¡ç‰‡ä¸ºç»ˆæ­¢å®ŒæˆçŠ¶æ€
          updateHistoryCardAsTerminated(queryIndex);
          
          // åˆ·æ–°å†å²è®°å½•
          loadHistory();
        } else {
          showError(i18n.t('index.terminate_fail') + ': ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Terminate history task error:', error);
        showError(i18n.t('index.terminate_fail') + ': ' + error.message);
      }
    };
    
    // æ›´æ–°å†å²å¡ç‰‡ä¸ºç»ˆæ­¢å®ŒæˆçŠ¶æ€ï¼ˆä¿®å¤12bï¼‰
    function updateHistoryCardAsTerminated(queryIndex) {
      const card = document.querySelector(`[data-history-qid="${queryIndex}"]`);
      if (!card) return;
      
      const content = card.querySelector('.card-content');
      if (!content) return;
      
      // ç”Ÿæˆæ—¶é—´æˆ³ç”¨äºæ–‡ä»¶å
      const timestamp = formatTimestampForFilename(new Date());
      
      // æ›¿æ¢è¿›åº¦åŒºåŸŸä¸ºç»ˆæ­¢å®ŒæˆåŒºåŸŸ
      content.innerHTML = `
        <div class="completion-section" style="display: block;">
          <div class="completion-header">
            <h4 data-i18n="index.terminate_complete">${i18n.t('index.terminate_complete')}</h4>
          </div>
          <div class="completion-actions">
            <button class="btn-secondary" onclick="downloadHistoryCsv('${queryIndex}', '${timestamp}')">
              <span data-i18n="index.download_all_results">${i18n.t('index.download_all_results')}</span>
            </button>
            <button class="btn-secondary" onclick="downloadHistoryBib('${queryIndex}', '${timestamp}')">
              <span data-i18n="index.download_bib_results">${i18n.t('index.download_bib_results')}</span>
            </button>
          </div>
        </div>
      `;
    }
    
    // ä¸‹è½½å†å²ä»»åŠ¡CSVï¼ˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—APIï¼‰
    window.downloadHistoryCsv = async function(queryIndex, timestamp) {
      const uid = localStorage.getItem('userId');
      if (!uid) {
        showError(i18n.t('index.login_required'));
        return;
      }
      
      // æ˜¾ç¤ºå…¨å±€loadingæç¤º
      showInfo(i18n.t('index.download_generating'));
      
      try {
        // ä¿®å¤37: åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼Œuidä»tokenè·å–ï¼‰
        const createResp = await authFetch('/api/download/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryIndex,
            type: 'csv'
          })
        });
        
        const createData = await createResp.json();
        if (!createData.success || !createData.task_id) {
          throw new Error(createData.error || 'Failed to create download task');
        }
        
        const taskId = createData.task_id;
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        let attempts = 0;
        const maxAttempts = 120;
        
        while (attempts < maxAttempts) {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
          const statusResp = await authFetch(`/api/download/status?task_id=${encodeURIComponent(taskId)}`);
          const status = await statusResp.json();
          
          if (status.state === 'READY') {
            window.location.href = `/api/download/file?task_id=${encodeURIComponent(taskId)}&token=${encodeURIComponent(localStorage.getItem('userToken'))}`;
            showSuccess(i18n.t('index.download_success'));
            break;
          } else if (status.state === 'FAILED') {
            throw new Error(status.error || 'Download generation failed');
          } else {
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
          }
        }
        
        if (attempts >= maxAttempts) {
          throw new Error('Download timeout');
        }
      } catch (error) {
        console.error('CSV download error:', error);
        showError(i18n.t('index.download_failed') + ': ' + error.message);
      }
    };
    
    // ä¸‹è½½å†å²ä»»åŠ¡BIBï¼ˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—APIï¼‰- ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
    window.downloadHistoryBib = async function(queryIndex, timestamp) {
      const token = localStorage.getItem('userToken');
      if (!token) {
        showError(i18n.t('index.login_required'));
        return;
      }
      
      // æ˜¾ç¤ºå…¨å±€loadingæç¤º
      showInfo(i18n.t('index.download_generating'));
      
      try {
        // ä¿®å¤37: åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼Œuidä»tokenè·å–ï¼‰
        const createResp = await authFetch('/api/download/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryIndex,
            type: 'bib'
          })
        });
        
        const createData = await createResp.json();
        if (!createData.success || !createData.task_id) {
          throw new Error(createData.error || 'Failed to create download task');
        }
        
        const taskId = createData.task_id;
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        let attempts = 0;
        const maxAttempts = 120;
        
        while (attempts < maxAttempts) {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
          const statusResp = await authFetch(`/api/download/status?task_id=${encodeURIComponent(taskId)}`);
          const status = await statusResp.json();
          
          if (status.state === 'READY') {
            window.location.href = `/api/download/file?task_id=${encodeURIComponent(taskId)}&token=${encodeURIComponent(localStorage.getItem('userToken'))}`;
            showSuccess(i18n.t('index.download_success'));
            break;
          } else if (status.state === 'FAILED') {
            throw new Error(status.error || 'Download generation failed');
          } else {
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
          }
        }
        
        if (attempts >= maxAttempts) {
          throw new Error('Download timeout');
        }
      } catch (error) {
        console.error('BIB download error:', error);
        showError(i18n.t('index.download_failed') + ': ' + error.message);
      }
    };

    // å†å²è®°å½•è¿›åº¦è½®è¯¢
    function startHistoryProgressPolling(queryIndex) {
      const progressFill = document.getElementById(`historyProgressFill_${queryIndex}`);
      const progressText = document.getElementById(`historyProgressText_${queryIndex}`);
      const progressStatus = document.getElementById(`historyProgressStatus_${queryIndex}`);
      
      if (!progressFill || !progressText || !progressStatus) return;
      
      // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è½®è¯¢
      if (window.historyProgressIntervals && window.historyProgressIntervals[queryIndex]) {
        clearInterval(window.historyProgressIntervals[queryIndex]);
      }
      
      if (!window.historyProgressIntervals) {
        window.historyProgressIntervals = {};
      }
      
      window.historyProgressIntervals[queryIndex] = setInterval(async () => {
        try {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
          const response = await authFetch(`/api/query_progress?query_id=${encodeURIComponent(queryIndex)}`);
          if (!response.ok) return;
          
          const data = await response.json();
          if (data.success) {
            const progress = Math.round(data.progress || 0);
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (data.is_paused) {
              progressStatus.textContent = i18n.t('index.status_paused');
              const pauseBtn = document.getElementById(`historyPauseResumeBtn_${queryIndex}`);
              if (pauseBtn) {
                pauseBtn.innerHTML = `<span data-i18n="index.resume">${i18n.t('index.resume')}</span>`;
              }
            } else {
              progressStatus.textContent = i18n.t('index.status_running');
              const pauseBtn = document.getElementById(`historyPauseResumeBtn_${queryIndex}`);
              if (pauseBtn) {
                pauseBtn.innerHTML = `<span data-i18n="index.pause">${i18n.t('index.pause')}</span>`;
              }
            }
            
            // å¦‚æœå®Œæˆï¼Œåœæ­¢è½®è¯¢å¹¶åˆ·æ–°å†å²è®°å½•
            if (data.completed) {
              clearInterval(window.historyProgressIntervals[queryIndex]);
              delete window.historyProgressIntervals[queryIndex];
              
              // ä¿®å¤11: é‡æ–°åŠ è½½è¯¦æƒ…å¹¶æ­£ç¡®æ›´æ–°å¡ç‰‡UI
              setTimeout(async () => {
                try {
                  const details = await loadHistoryDetails(queryIndex);
                  // æŸ¥æ‰¾å¯¹åº”çš„å†å²å¡ç‰‡
                  const card = document.querySelector(`[data-history-qid="${queryIndex}"]`);
                  if (card) {
                    // ä¿®å¤37: è·å–å†å²è®°å½•æ•°æ®ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼‰
                    const historyResponse = await authFetch('/api/query_history');
                    const historyJson = await historyResponse.json();
                    if (historyJson.success && Array.isArray(historyJson.logs)) {
                      const historyData = historyJson.logs.find(l => l.query_id === queryIndex);
                      if (historyData) {
                        updateHistoryDescriptionCard(card, historyData, details, queryIndex);
                      }
                    }
                  }
                  // åŒæ—¶åˆ·æ–°ä¾§è¾¹æ å†å²è®°å½•åˆ—è¡¨
                  loadHistory();
                } catch (error) {
                  console.error('Failed to update completed history card:', error);
                }
              }, 1000);
            }
          }
        } catch (error) {
          console.error('History progress polling error:', error);
        }
      }, 2000);
    }

    // æ ¼å¼åŒ–æ—¶é—´æˆ³ç”¨äºæ–‡ä»¶å
    function formatTimestampForFilename(dateTime) {
      if (!dateTime) return 'unknown';
      
      const date = typeof dateTime === 'string' ? new Date(dateTime) : dateTime;
      if (isNaN(date.getTime())) return 'unknown';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      const second = String(date.getSeconds()).padStart(2, '0');
      
      return `${year}${month}${day}_${hour}${minute}${second}`;
    }

    // è¿”å›è¾“å…¥ç¼–è¾‘æ¨¡å¼
    // æ¸…ç†æ‰€æœ‰è’¸é¦ç›¸å…³å†…å®¹
    function clearDistillationContent() {
      // æ¸…ç†è’¸é¦å¡ç‰‡å®¹å™¨
      const distillContainer = document.getElementById('distillCardsContainer');
      if (distillContainer) {
        distillContainer.innerHTML = '';
      }
      
      // æ¸…ç†æ´»è·ƒçš„è’¸é¦å¡ç‰‡è®°å½•
      if (typeof activeDistillCards !== 'undefined') {
        activeDistillCards.clear();
      }
      
      // é‡ç½®è’¸é¦å¡ç‰‡è®¡æ•°å™¨
      if (typeof distillCardCounter !== 'undefined') {
        distillCardCounter = 0;
      }
      
      // æ¸…ç†è’¸é¦ç›¸å…³çš„è½®è¯¢
      if (typeof distillProgressIntervals !== 'undefined') {
        distillProgressIntervals.forEach((interval, cardId) => {
          clearInterval(interval);
        });
        distillProgressIntervals.clear();
      }
    }

    function backToInput() {
      // è·å–æ‰€æœ‰éœ€è¦æ“ä½œçš„å…ƒç´ 
      const inputSection = document.getElementById('inputSection');
      const summaryCard = document.getElementById('searchSummaryCard');
      const progressSection = document.getElementById('progressSection');
      const completionSection = document.getElementById('completionSection');
      
      // æ˜¾ç¤ºè¾“å…¥åŒºåŸŸ
      if (inputSection) {
        inputSection.style.display = 'block';
        inputSection.classList.remove('hidden');
      }
      
      // éšè—æœç´¢æ‘˜è¦å¡ç‰‡
      if (summaryCard) {
        summaryCard.style.display = 'none';
      }
      
      // éšè—è¿›åº¦å’Œå®ŒæˆåŒºåŸŸ
      if (progressSection) progressSection.style.display = 'none';
      if (completionSection) completionSection.style.display = 'none';
      
      // æ¸…é™¤è¿›åº¦è½®è¯¢
      if (currentProgressInterval) {
        clearInterval(currentProgressInterval);
        currentProgressInterval = null;
      }
      
      // æ¸…ç†æ‰€æœ‰è’¸é¦ç›¸å…³å†…å®¹
      clearDistillationContent();
      
      // æ¸…ç†å†å²è®°å½•è¿›åº¦è½®è¯¢
      if (window.historyProgressIntervals) {
        Object.values(window.historyProgressIntervals).forEach(interval => {
          clearInterval(interval);
        });
        window.historyProgressIntervals = {};
      }
      
      // é‡ç½®å…¨å±€å˜é‡
      currentQueryIndex = null;
      currentStartTime = null;
      
      // ç§»é™¤æ‰€æœ‰å†å²æè¿°å¡ç‰‡
      document.querySelectorAll('.history-description-card').forEach(card => {
        card.remove();
      });
      
      // æ¸…é™¤å†å²è®°å½•ä¸­çš„é«˜äº®
      document.querySelectorAll('.history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // æ¸…é™¤å½“å‰ä¼šè¯çŠ¶æ€
      setCurrentSession(null);
      
      // é«˜äº®"æ–°å»ºæœç´¢"é¡¹
      const newSearchItem = document.querySelector('.history-item[data-qid="new"]');
      if (newSearchItem) {
        newSearchItem.classList.add('active');
      }
    }

    // åœ¨å†å²è®°å½•ä¸­é«˜äº®å½“å‰æ£€ç´¢
    function highlightCurrentSearch(queryIndex) {
      // æ¸…é™¤æ‰€æœ‰é«˜äº®
      document.querySelectorAll('.history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // é«˜äº®å½“å‰æ£€ç´¢
      const currentItem = document.querySelector(`.history-item[data-qid="${queryIndex}"]`);
      if (currentItem) {
        currentItem.classList.add('active');
      }
    }

    // å†å²è®°å½•ç›¸å…³åŠŸèƒ½
    let historyCollapsed = false;

    function toggleHistoryCollapse() {
      const historyContainer = document.getElementById('historyContainer');
      const historyToggle = document.getElementById('historyToggle');
      
      historyCollapsed = !historyCollapsed;
      
      if (historyCollapsed) {
        historyContainer.classList.add('collapsed');
        historyToggle.classList.add('collapsed');
        historyToggle.title = i18n.t('index.history_expand');
      } else {
        historyContainer.classList.remove('collapsed');
        historyToggle.classList.remove('collapsed');
        historyToggle.title = i18n.t('index.history_collapse');
      }
    }

    async function loadHistory() {
      const historyList = document.getElementById('historyList');
      const historyLoading = document.getElementById('historyLoading');
      const historyEmpty = document.getElementById('historyEmpty');
      const historyError = document.getElementById('historyError');
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      const uid = localStorage.getItem('userId');
      const token = localStorage.getItem('userToken');
      
      if (!uid || !token) {
        console.log('User not logged in, skipping history load');
        historyLoading.style.display = 'none';
        historyEmpty.style.display = 'block';
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      historyList.style.display = 'none';
      historyEmpty.style.display = 'none';
      historyError.style.display = 'none';
      historyLoading.style.display = 'block';
      
      try {
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
        const response = await authFetch('/api/query_history');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // æ£€æŸ¥APIå“åº”æ˜¯å¦æˆåŠŸ
        if (!data.success) {
          throw new Error(data.error || 'APIè°ƒç”¨å¤±è´¥');
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        historyLoading.style.display = 'none';
        
        const logs = data.logs || [];
        if (logs.length > 0) {
          renderHistoryList(logs);
          historyList.style.display = 'block';
        } else {
          historyEmpty.style.display = 'block';
        }
        
        // è¿”å›Promiseä»¥ä¾¿å¤–éƒ¨çŸ¥é“åŠ è½½å®Œæˆ
        return Promise.resolve();
        
      } catch (error) {
        console.error('Failed to load history:', error);
        historyLoading.style.display = 'none';
        historyError.style.display = 'block';
      }
    }

    function renderHistoryList(historyData) {
      const historyList = document.getElementById('historyList');
      
      // æ¸…ç©ºç°æœ‰å†…å®¹
      historyList.innerHTML = '';
      
      // æ·»åŠ "æ–°å»ºæœç´¢"é¡¹
      const newSearchItem = document.createElement('div');
      newSearchItem.className = 'history-item active';
      newSearchItem.dataset.qid = 'new';
      
      const newSearchTitle = document.createElement('div');
      newSearchTitle.className = 'history-item-title';
      newSearchTitle.textContent = i18n.t('index.new_search');
      newSearchTitle.setAttribute('data-i18n', 'index.new_search');
      
      const newSearchMeta = document.createElement('div');
      newSearchMeta.className = 'history-item-meta';
      newSearchMeta.textContent = i18n.t('index.current');
      newSearchMeta.setAttribute('data-i18n', 'index.current');
      
      newSearchItem.appendChild(newSearchTitle);
      newSearchItem.appendChild(newSearchMeta);
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      newSearchItem.addEventListener('click', () => {
        setCurrentSession(null);
        backToInput();
      });
      
      historyList.appendChild(newSearchItem);
      
      // æ·»åŠ å†å²è®°å½•é¡¹ï¼ˆæŒ‰æ—¶é—´å€’åºï¼Œç»Ÿä¸€ä»¥UTC+8æ’åºï¼‰
      const parseUtcMs = (s) => {
        if (!s) return 0;
        const raw = typeof s === 'string' ? s : String(s);
        const norm = raw.startsWith('UTC-') ? raw.slice(4) : raw;
        const iso = norm.replace(' ', 'T') + 'Z';
        const d = new Date(iso);
        if (isNaN(d.getTime())) {
          const d2 = new Date(raw);
          return isNaN(d2.getTime()) ? 0 : d2.getTime() + 8 * 60 * 60 * 1000;
        }
        return d.getTime() + 8 * 60 * 60 * 1000;
      };

      const sortedData = [...historyData].sort((a, b) => {
        const msA = parseUtcMs(a.query_time || a.start_time);
        const msB = parseUtcMs(b.query_time || b.start_time);
        return msB - msA;
      });
      
      sortedData.forEach(item => {
        const historyItem = createHistoryItem(item);
        historyList.appendChild(historyItem);
      });
    }

    function createHistoryItem(item) {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.dataset.qid = item.query_id;
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºè’¸é¦ç±»å‹å¹¶æ·»åŠ ç›¸åº”çš„CSSç±»
      if (item.is_distillation) {
        div.classList.add('distill-type');
      }
      
      // åˆ›å»ºå†…å®¹å®¹å™¨
      const content = document.createElement('div');
      content.className = 'history-item-content';
      
      const title = document.createElement('div');
      title.className = 'history-item-title';
      // ä¿®å¤30ï¼šè’¸é¦ä»»åŠ¡æ ‡é¢˜æ·»åŠ å‰ç¼€
      const baseTitle = item.research_question || i18n.t('history.research_question_empty');
      const distillPrefix = item.is_distillation ? (i18n.t('index.distill_prefix') || 'ğŸ”¬ ') : '';
      const titleText = distillPrefix + baseTitle;
      title.textContent = titleText;
      title.title = titleText;
      
      // å¦‚æœæ ‡é¢˜æ˜¯ç©ºçš„ç ”ç©¶é—®é¢˜ï¼Œæ·»åŠ data-i18nå±æ€§ä»¥ä¾¿è¯­è¨€åˆ‡æ¢
      if (!item.research_question) {
        title.setAttribute('data-i18n', 'history.research_question_empty');
        title.setAttribute('data-is-empty-title', 'true');
      }
      // ä¿®å¤30ï¼šæ·»åŠ è’¸é¦æ ‡è®°ä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°å‰ç¼€
      if (item.is_distillation) {
        title.setAttribute('data-is-distillation', 'true');
      }
      
      const meta = document.createElement('div');
      meta.className = 'history-item-meta';
      
      // æ ¼å¼åŒ–æ—¶é—´å’ŒçŠ¶æ€ï¼ˆç»Ÿä¸€æŒ‰UTC+8æ˜¾ç¤ºï¼‰
      const formatDateTime = (timeStr) => {
        if (!timeStr) return 'Unknown';
        const raw = typeof timeStr === 'string' && timeStr.startsWith('UTC-') ? timeStr.slice(4) : timeStr;
        const iso = String(raw).replace(' ', 'T') + 'Z'; // æŒ‰UTCè§£æ
        const dateUtc = new Date(iso);
        if (isNaN(dateUtc.getTime())) return 'Unknown';
        // è½¬æ¢åˆ°UTC+8
        const utc8Ms = dateUtc.getTime() + 8 * 60 * 60 * 1000;
        const d = new Date(utc8Ms);
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        const hour = String(d.getUTCHours()).padStart(2, '0');
        const minute = String(d.getUTCMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hour}:${minute}`;
      };
      
      const dateTime = formatDateTime(item.query_time || item.start_time);
      // ä¿®å¤10: çŠ¶æ€æ˜¾ç¤ºä¸‰æ€ï¼ˆå®Œæˆ > å·²æš‚åœ > è¿›è¡Œä¸­ï¼‰
      let status;
      if (item.completed) {
        status = i18n.t('history.status_done');
      } else if (item.should_pause) {
        status = i18n.t('index.status_paused');
      } else {
        status = i18n.t('history.status_running');
      }
      
      // ç§»é™¤è’¸é¦ç±»å‹çš„å›¾æ ‡æ ‡è¯†ï¼Œä¿æŒç®€æ´çš„æ˜¾ç¤º
      meta.textContent = `${dateTime} | ${status}`;
      // æ·»åŠ æ•°æ®å±æ€§ä»¥ä¾¿è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°
      meta.setAttribute('data-datetime', dateTime);
      meta.setAttribute('data-completed', item.completed ? 'true' : 'false');
      meta.setAttribute('data-paused', item.should_pause ? 'true' : 'false');
      
      content.appendChild(title);
      content.appendChild(meta);
      
      div.appendChild(content);
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      content.addEventListener('click', () => {
        setCurrentSession(item.query_id);
        selectHistoryItem(div, item);
      });
      
      return div;
    }

    function getStatusText(status) {
      const statusMap = {
        'completed': i18n.getLang() === 'zh' ? 'å·²å®Œæˆ' : 'Completed',
        'running': i18n.t('index.status_running'),
        'failed': i18n.getLang() === 'zh' ? 'å¤±è´¥' : 'Failed',
        'pending': i18n.getLang() === 'zh' ? 'ç­‰å¾…ä¸­' : 'Pending'
      };
      return statusMap[status] || status;
    }

    function selectHistoryItem(itemElement, historyData) {
      console.log('Selecting history item:', historyData);
      
      // ç§»é™¤å…¶ä»–é¡¹çš„activeçŠ¶æ€
      document.querySelectorAll('.history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // æ·»åŠ å½“å‰é¡¹çš„activeçŠ¶æ€
      itemElement.classList.add('active');
      
      // ä¿å­˜å½“å‰ä¼šè¯çŠ¶æ€
      setCurrentSession(historyData.query_id);
      
      // å°è¯•å¯¼èˆªåˆ°å¯¹åº”çš„å¡ç‰‡
      navigateToHistoryCard(historyData);
      
      console.log('Selected history item:', historyData);
    }

    // å½“å‰ä¼šè¯ç®¡ç†
    function setCurrentSession(queryIndex) {
      if (queryIndex && queryIndex !== 'new') {
        localStorage.setItem('currentSession', queryIndex);
      } else {
        localStorage.removeItem('currentSession');
      }
    }

    function getCurrentSession() {
      return localStorage.getItem('currentSession');
    }

    // å¯¼èˆªåˆ°å†å²å¡ç‰‡
    async function navigateToHistoryCard(historyData) {
      const queryIndex = historyData.query_id;
      console.log('Navigating to history card for query:', queryIndex);
      
      // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰å¯¹åº”çš„å¡ç‰‡åœ¨é¡µé¢ä¸Š
      let targetCard = findExistingCard(queryIndex);
      
      if (targetCard) {
        // å¡ç‰‡å·²å­˜åœ¨ï¼Œç›´æ¥æ»šåŠ¨å®šä½
        console.log('Found existing card, scrolling to it');
        scrollToCard(targetCard);
      } else {
        // å¡ç‰‡ä¸å­˜åœ¨ï¼Œéœ€è¦æ¸…é™¤å…¶ä»–å†…å®¹å¹¶åˆ›å»ºå†å²è¯´æ˜å¡ç‰‡
        console.log('No existing card found, clearing content and creating history description card');
        
        // æ¸…é™¤ä¸»å®¹å™¨ä¸­çš„å…¶ä»–å†…å®¹
        clearMainContent();
        
        // åˆ›å»ºå†å²æè¿°å¡ç‰‡
        targetCard = await createHistoryDescriptionCard(historyData);
        if (targetCard) {
          scrollToCard(targetCard);
        }
      }
    }

    // æ¸…é™¤ä¸»å®¹å™¨å†…å®¹
    function clearMainContent() {
      // è·å–æ‰€æœ‰éœ€è¦éšè—çš„å…ƒç´ 
      const inputSection = document.getElementById('inputSection');
      const summaryCard = document.getElementById('searchSummaryCard');
      const progressSection = document.getElementById('progressSection');
      const completionSection = document.getElementById('completionSection');
      
      // éšè—è¾“å…¥åŒºåŸŸ
      if (inputSection) {
        inputSection.classList.add('hidden');
      }
      
      // éšè—æœç´¢æ‘˜è¦å¡ç‰‡
      if (summaryCard) {
        summaryCard.style.display = 'none';
      }
      
      // éšè—è¿›åº¦å’Œå®ŒæˆåŒºåŸŸ
      if (progressSection) progressSection.style.display = 'none';
      if (completionSection) completionSection.style.display = 'none';
      
      // æ¸…ç†æ‰€æœ‰è’¸é¦ç›¸å…³å†…å®¹
      clearDistillationContent();
      
      // æ¸…ç†å†å²è®°å½•è¿›åº¦è½®è¯¢
      if (window.historyProgressIntervals) {
        Object.values(window.historyProgressIntervals).forEach(interval => {
          clearInterval(interval);
        });
        window.historyProgressIntervals = {};
      }
      
      // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„å†å²æè¿°å¡ç‰‡
      document.querySelectorAll('.history-description-card').forEach(card => {
        card.remove();
      });
    }

    // æŸ¥æ‰¾å·²å­˜åœ¨çš„å¡ç‰‡
    function findExistingCard(queryIndex) {
      // æ£€æŸ¥æœç´¢æ‘˜è¦å¡ç‰‡
      const summaryCard = document.getElementById('searchSummaryCard');
      if (summaryCard && summaryCard.style.display !== 'none' && currentQueryIndex === queryIndex) {
        return summaryCard;
      }
      
      // æ£€æŸ¥è’¸é¦å¡ç‰‡ï¼ˆä½¿ç”¨data-query-indexå±æ€§ï¼‰
      const distillCards = document.querySelectorAll('.distill-card');
      for (const card of distillCards) {
        if (card.dataset.queryIndex == queryIndex) {
          return card;
        }
      }
      
      // æ£€æŸ¥å†å²æè¿°å¡ç‰‡
      const historyCard = document.getElementById(`historyCard_${queryIndex}`);
      if (historyCard) {
        return historyCard;
      }
      
      return null;
    }

    // æ»šåŠ¨åˆ°æŒ‡å®šå¡ç‰‡
    function scrollToCard(card) {
      card.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start',
        inline: 'nearest'
      });
      
      // æ·»åŠ é«˜äº®æ•ˆæœ
      card.classList.add('highlight-card');
      setTimeout(() => {
        card.classList.remove('highlight-card');
      }, 2000);
    }

    // åˆ›å»ºå†å²æè¿°å¡ç‰‡
    async function createHistoryDescriptionCard(historyData) {
      const queryIndex = historyData.query_id;
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      let existingCard = document.getElementById(`historyCard_${queryIndex}`);
      if (existingCard) {
        return existingCard;
      }
      
      // åˆ›å»ºå¡ç‰‡å®¹å™¨
      const card = document.createElement('div');
      card.id = `historyCard_${queryIndex}`;
      card.className = 'history-description-card';
      // ä¿®å¤11: æ·»åŠ dataå±æ€§ä»¥ä¾¿å®Œæˆæ—¶æŸ¥æ‰¾å¡ç‰‡
      card.dataset.historyQid = queryIndex;
      
      // æ·»åŠ åŠ è½½çŠ¶æ€
      card.innerHTML = `
        <div class="card-header">
          <h3>ğŸ“‹ ${i18n.t('index.history_task_title')}</h3>
          <button class="btn-close" onclick="removeHistoryCard('${queryIndex}')">Ã—</button>
        </div>
        <div class="card-content">
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">${i18n.t('index.loading_history_details')}</div>
          </div>
        </div>
      `;
      
      // æ’å…¥åˆ°ä¸»å†…å®¹åŒºåŸŸ
      const mainBody = document.querySelector('.main-body');
      const inputSection = document.getElementById('inputSection');
      mainBody.insertBefore(card, inputSection);
      
      // å¼‚æ­¥åŠ è½½è¯¦ç»†ä¿¡æ¯
      try {
        const details = await loadHistoryDetails(queryIndex);
        updateHistoryDescriptionCard(card, historyData, details, queryIndex);
      } catch (error) {
        console.error('Failed to load history details:', error);
        updateHistoryDescriptionCardError(card, historyData, error);
      }
      
      return card;
    }

    // åŠ è½½å†å²è¯¦æƒ… - ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
    async function loadHistoryDetails(queryIndex) {
      // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
      const response = await authFetch(`/api/get_query_info?query_id=${queryIndex}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      if (!data.success) {
        throw new Error(data.error || 'Failed to load details');
      }
      
      console.log('loadHistoryDetails - API response data:', data);
      console.log('loadHistoryDetails - query_info:', JSON.stringify(data.query_info, null, 2));
      
      return data.query_info;
    }

    // æ›´æ–°å†å²æè¿°å¡ç‰‡å†…å®¹
    function updateHistoryDescriptionCard(card, historyData, details, queryIndex) {
      const content = card.querySelector('.card-content');
      
      // ä¼˜å…ˆä½¿ç”¨ historyData ä¸­çš„ is_distillationï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ details ä¸­çš„
      const isDistillation = historyData.is_distillation !== undefined ? historyData.is_distillation : details.is_distillation;
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºè’¸é¦ç±»å‹å¹¶æ·»åŠ ç›¸åº”çš„CSSç±»
      if (isDistillation) {
        card.classList.add('distill-type');
        // æ›´æ–°æ ‡é¢˜ä¸ºè’¸é¦ç±»å‹
        const headerTitle = card.querySelector('.card-header h3');
        if (headerTitle) {
          headerTitle.innerHTML = `ğŸ”¬ ${i18n.t('index.distill_task_title') || 'è’¸é¦æ£€ç´¢ä»»åŠ¡'}`;
        }
      } else {
        card.classList.remove('distill-type');
        // ç¡®ä¿æ ‡é¢˜ä¸ºæ ‡å‡†ç±»å‹
        const headerTitle = card.querySelector('.card-header h3');
        if (headerTitle) {
          headerTitle.innerHTML = `ğŸ“‹ ${i18n.t('index.history_task_title')}`;
        }
      }
      
      // æ ¼å¼åŒ–æ—¶é—´
      const formatDateTime = (timeStr) => {
        if (!timeStr) return 'Unknown';
        const raw = typeof timeStr === 'string' && timeStr.startsWith('UTC-') ? timeStr.slice(4) : timeStr;
        const iso = String(raw).replace(' ', 'T') + 'Z';
        const dateUtc = new Date(iso);
        if (isNaN(dateUtc.getTime())) return 'Unknown';
        const utc8Ms = dateUtc.getTime() + 8 * 60 * 60 * 1000;
        const d = new Date(utc8Ms);
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        const hour = String(d.getUTCHours()).padStart(2, '0');
        const minute = String(d.getUTCMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hour}:${minute}`;
      };
      
      // ä½¿ç”¨detailsä¸­çš„ä¿¡æ¯ï¼ˆä»get_query_info APIè·å–ï¼‰
      const startTime = formatDateTime(details.query_time || details.start_time);
      // ä¿®å¤10: çŠ¶æ€æ˜¾ç¤ºä¸‰æ€ï¼ˆå®Œæˆ > å·²æš‚åœ > è¿›è¡Œä¸­ï¼‰
      let status;
      if (details.completed) {
        status = i18n.t('history.status_done');
      } else if (details.should_pause) {
        status = i18n.t('index.status_paused');
      } else {
        status = i18n.t('history.status_running');
      }
      const question = details.research_question || i18n.t('history.research_question_empty');
      const requirements = details.requirements || '';
      const selectedFolders = details.selected_folders || '';
      const yearRange = details.year_range || '';
      
      // æ ¹æ®æ˜¯å¦ä¸ºè’¸é¦ç±»å‹é€‰æ‹©ä¸åŒçš„æ ‡ç­¾æ–‡æœ¬
      console.log('updateHistoryDescriptionCard - historyData.is_distillation:', historyData.is_distillation);
      console.log('updateHistoryDescriptionCard - details.is_distillation:', details.is_distillation);
      console.log('updateHistoryDescriptionCard - final isDistillation:', isDistillation);
      console.log('i18n.t test - distill_original_question_requirements:', i18n.t('index.distill_original_question_requirements'));
      console.log('i18n.t test - distill_original_time:', i18n.t('index.distill_original_time'));
      const selectedFoldersLabel = isDistillation ? 
        i18n.t('index.distill_original_question_requirements') : 
        i18n.t('index.selected_folders');
      const yearRangeLabel = isDistillation ? 
        i18n.t('index.distill_original_time') : 
        i18n.t('index.year_range');
      console.log('selectedFoldersLabel:', selectedFoldersLabel);
      console.log('yearRangeLabel:', yearRangeLabel);
      
      // ä¿®å¤30ï¼šè·å–çˆ¶ä»»åŠ¡IDï¼ˆè’¸é¦ä»»åŠ¡ä¸“ç”¨ï¼‰
      const originalQueryId = details.original_query_id || historyData.original_query_id || '';
      
      // ä¿®å¤31ï¼šè·å–æ–‡ç« æ€»æ•°å’Œå¼€é”€
      const totalPapers = details.total_papers_count || historyData.total_papers_count || 0;
      const estimatedCost = details.estimated_cost || historyData.estimated_cost || 0;
      
      content.innerHTML = `
        <div class="history-summary">
          <!-- ä¿®å¤39: æ˜¾ç¤ºä»»åŠ¡ID -->
          <div class="summary-item query-id-row">
            <div class="summary-label">${i18n.t('index.query_id_label') || 'ä»»åŠ¡ID'}ï¼š</div>
            <div class="summary-value query-id-value">${queryIndex}</div>
          </div>
          ${isDistillation && originalQueryId ? `
          <div class="summary-item distill-parent-info">
            <div class="summary-label">${i18n.t('index.distill_based_on') || 'åŸºäºä»»åŠ¡'}ï¼š</div>
            <div class="summary-value">${originalQueryId}</div>
          </div>
          ` : ''}
          <div class="summary-item">
            <div class="summary-label">${i18n.t('index.research_question')}ï¼š</div>
            <div class="summary-value">${question}</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">${i18n.t('index.start_time_summary')}ï¼š</div>
            <div class="summary-value">${startTime}</div>
          </div>
          ${requirements ? `
          <div class="summary-item">
            <div class="summary-label">${i18n.t('index.research_requirements')}ï¼š</div>
            <div class="summary-value">${requirements}</div>
          </div>
          ` : ''}
          ${selectedFolders ? `
          <div class="summary-item">
            <div class="summary-label">${selectedFoldersLabel}ï¼š</div>
            <div class="summary-value">${selectedFolders}</div>
          </div>
          ` : ''}
          ${yearRange ? `
          <div class="summary-item">
            <div class="summary-label">${yearRangeLabel}ï¼š</div>
            <div class="summary-value">${yearRange}</div>
          </div>
          ` : ''}
          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label">${isDistillation ? i18n.t('index.relevant_papers_count') : i18n.t('index.total_articles')}</span>
                <strong>${totalPapers.toLocaleString()}</strong>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label">${i18n.t('index.actual_cost')}</span>
                <strong>${estimatedCost} ${i18n.t('common.credit_unit')}</strong>
              </div>
            </div>
          </div>
        </div>
        ${details.completed ? `
          <!-- å®ŒæˆåæŒ‰é’®åŒºåŸŸ -->
          <div class="completion-section">
            <div class="completion-header">
              <h4 data-i18n="index.completion_title">æ£€ç´¢å®Œæˆ</h4>
            </div>
            <div class="completion-actions">
              <button class="btn-secondary" onclick="downloadHistoryCsv('${queryIndex}', '')">
                <span data-i18n="index.download_all_results">ä¸‹è½½å…¨éƒ¨åˆ†æç»“æœ</span>
              </button>
              <button class="btn-secondary" onclick="downloadHistoryBib('${queryIndex}', '')">
                <span data-i18n="index.download_bib_results">ä¸‹è½½ç›¸ç¬¦ç»“æœçš„bibå¼•ç”¨</span>
              </button>
              <button class="btn-orange" onclick="createDistillFromHistory('${queryIndex}')">
                <span data-i18n="index.distill">è’¸é¦</span>
              </button>
            </div>
          </div>
        ` : `
          <!-- è¿›åº¦åŒºåŸŸ -->
          <div class="progress-section" id="historyProgressSection_${queryIndex}">
            <div class="progress-header">
              <h4 data-i18n="index.progress_title">æ£€ç´¢è¿›åº¦</h4>
              <div class="progress-actions">
                <button id="historyPauseResumeBtn_${queryIndex}" class="btn-secondary" onclick="toggleHistoryProgress('${queryIndex}')">
                  <span data-i18n="index.pause">æš‚åœ</span>
                </button>
                <button id="historyTerminateBtn_${queryIndex}" class="btn-danger" onclick="terminateHistoryTask('${queryIndex}')">
                  <span data-i18n="index.terminate">ç»ˆæ­¢</span>
                </button>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar-wrapper">
                <div class="progress-bar">
                  <div id="historyProgressFill_${queryIndex}" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="historyProgressText_${queryIndex}" class="progress-text">0%</div>
              </div>
              <div id="historyProgressStatus_${queryIndex}" class="progress-status" data-i18n="index.status_running">è¿è¡Œä¸­</div>
            </div>
          </div>
        `}
        <!-- ä¿®å¤10: ç§»é™¤è¿›è¡Œä¸­ä»»åŠ¡çš„è’¸é¦æŒ‰é’®ï¼Œè’¸é¦æŒ‰é’®åªåº”åœ¨ä»»åŠ¡å®Œæˆåæ˜¾ç¤º -->
      `;
      
      // å¦‚æœä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œå¯åŠ¨è¿›åº¦è½®è¯¢
      if (!details.completed) {
        setTimeout(() => {
          // æ·»åŠ éšæœºæ–‡å­—æ˜¾ç¤º
          updateProgressRandomText(`historyProgressSection_${queryIndex}`);
          startHistoryProgressPolling(queryIndex);
        }, 500);
      }
    }

    // æ›´æ–°å†å²æè¿°å¡ç‰‡é”™è¯¯çŠ¶æ€
    function updateHistoryDescriptionCardError(card, historyData, error) {
      const content = card.querySelector('.card-content');
      const question = historyData.research_question || i18n.t('history.research_question_empty');
      
      content.innerHTML = `
        <div class="error-content">
          <div class="error-message">
            ${i18n.t('index.load_history_details_failed')}: ${error.message}
          </div>
          <div class="basic-info">
            <div class="summary-item">
              <div class="summary-label">${i18n.t('index.research_question')}ï¼š</div>
              <div class="summary-value">${question}</div>
            </div>
          </div>
          <div class="history-actions">
            <button class="btn-secondary" onclick="retryLoadHistoryDetails('${historyData.query_id}')">
              ${i18n.t('index.retry')}
            </button>
          </div>
        </div>
      `;
    }

    // ç§»é™¤å†å²å¡ç‰‡
    window.removeHistoryCard = function(queryIndex) {
      const card = document.getElementById(`historyCard_${queryIndex}`);
      if (card) {
        card.remove();
      }
      
      // æ¸…ç†å¯¹åº”çš„è¿›åº¦è½®è¯¢
      if (window.historyProgressIntervals && window.historyProgressIntervals[queryIndex]) {
        clearInterval(window.historyProgressIntervals[queryIndex]);
        delete window.historyProgressIntervals[queryIndex];
      }
      
      // å¦‚æœç§»é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ¸…é™¤ä¼šè¯çŠ¶æ€
      if (getCurrentSession() === queryIndex) {
        setCurrentSession(null);
        // é«˜äº®"æ–°å»ºæœç´¢"é¡¹
        const newSearchItem = document.querySelector('.history-item[data-qid="new"]');
        if (newSearchItem) {
          document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove('active');
          });
          newSearchItem.classList.add('active');
        }
      }
    };

    // é‡è¯•åŠ è½½å†å²è¯¦æƒ…
    window.retryLoadHistoryDetails = async function(queryIndex) {
      const card = document.getElementById(`historyCard_${queryIndex}`);
      if (!card) return;
      
      const content = card.querySelector('.card-content');
      content.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text">${i18n.t('index.loading_history_details')}</div>
        </div>
      `;
      
      try {
        const historyData = getHistoryDataByQueryIndex(queryIndex);
        const details = await loadHistoryDetails(queryIndex);
        updateHistoryDescriptionCard(card, historyData, details, queryIndex);
      } catch (error) {
        console.error('Retry failed:', error);
        const historyData = getHistoryDataByQueryIndex(queryIndex);
        updateHistoryDescriptionCardError(card, historyData, error);
      }
    };

    // è·å–å†å²æ•°æ®
    function getHistoryDataByQueryIndex(queryIndex) {
      // ä»å½“å‰å†å²åˆ—è¡¨ä¸­æŸ¥æ‰¾
      const historyItem = document.querySelector(`.history-item[data-qid="${queryIndex}"]`);
      if (historyItem) {
        const title = historyItem.querySelector('.history-item-title').textContent;
        const meta = historyItem.querySelector('.history-item-meta').textContent;
        return {
          query_id: queryIndex,
          research_question: title,
          completed: meta.includes(i18n.t('history.status_done'))
        };
      }
      return { query_id: queryIndex };
    }

    // å†å²ä»»åŠ¡æ“ä½œå‡½æ•°
    window.viewHistoryResults = function(queryIndex) {
      // TODO: å®ç°æŸ¥çœ‹å†å²ç»“æœåŠŸèƒ½
      console.log('View results for query:', queryIndex);
      showInfo(i18n.t('index.feature_coming_soon'));
    };

    // ä¿®å¤36: downloadHistoryResults å‡½æ•°å·²åˆ é™¤ï¼Œæ”¹ç”¨ downloadHistoryCsv å’Œ downloadHistoryBib

    window.viewHistoryProgress = function(queryIndex) {
      // TODO: å®ç°æŸ¥çœ‹å†å²è¿›åº¦åŠŸèƒ½
      console.log('View progress for query:', queryIndex);
      showInfo(i18n.t('index.feature_coming_soon'));
    };

    window.createDistillFromHistory = function(queryIndex) {
      // åˆ›å»ºè’¸é¦å¡ç‰‡
      const distillCard = createDistillInputCard(queryIndex);
      if (distillCard) {
        scrollToCard(distillCard);
      }
    };

    // ==================== è’¸é¦åŠŸèƒ½ç›¸å…³å‡½æ•° ====================

    /**
     * åˆ›å»ºè’¸é¦è¾“å…¥å¡ç‰‡
     * @param {number} queryIndex åŸå§‹æŸ¥è¯¢ç´¢å¼•
     */
    function createDistillInputCard(queryIndex) {
      const cardId = `distill-card-${++distillCardCounter}`;
      const container = document.getElementById('distillCardsContainer');
      
      // æ¸…ç†ç°æœ‰çš„è’¸é¦å†…å®¹ï¼ˆç”¨äºäºŒæ¬¡è’¸é¦ï¼‰
      clearDistillationContent();
      
      // éšè—ä¸»å®¹å™¨ä¸­çš„å…¶ä»–æ‰€æœ‰å®¹å™¨ï¼Œåªæ˜¾ç¤ºè’¸é¦å®¹å™¨
      const inputSection = document.getElementById('inputSection');
      const progressSection = document.getElementById('progressSection');
      const completionSection = document.getElementById('completionSection');
      const searchSummaryCard = document.getElementById('searchSummaryCard');
      
      // éšè—è¾“å…¥åŒºåŸŸ
      if (inputSection) {
        inputSection.style.display = 'none';
        inputSection.classList.add('hidden');
      }
      
      // éšè—è¿›åº¦åŒºåŸŸ
      if (progressSection) {
        progressSection.style.display = 'none';
      }
      
      // éšè—å®ŒæˆåŒºåŸŸ
      if (completionSection) {
        completionSection.style.display = 'none';
      }
      
      // éšè—æœç´¢æ‘˜è¦å¡ç‰‡
      if (searchSummaryCard) {
        searchSummaryCard.style.display = 'none';
      }
      
      // åˆ é™¤æ‰€æœ‰å†å²æè¿°å¡ç‰‡
      document.querySelectorAll('.history-description-card').forEach(card => {
        card.remove();
      });
      
      const cardHtml = `
        <div class="distill-card" id="${cardId}" data-query-index="${queryIndex}">
          <div class="distill-header">
            <div class="distill-title">
              <span class="distill-badge">${i18n.t('index.distill_new')}</span>
              ${i18n.t('index.distill_input_title')}
            </div>
          </div>
          <div class="distill-content">
            <div class="distill-form-group">
              <label>${i18n.t('index.distill_question')}</label>
              <textarea id="${cardId}-question" placeholder="${i18n.t('index.distill_question_ph')}" rows="3"></textarea>
            </div>
            <div class="distill-form-group">
              <label>${i18n.t('index.distill_requirements')}</label>
              <textarea id="${cardId}-requirements" placeholder="${i18n.t('index.distill_requirements_ph')}" rows="2"></textarea>
            </div>
            <div class="distill-cost-info" id="${cardId}-cost-info">
              <div class="distill-cost-item">
                <span class="icon">ğŸ“„</span>
                <span class="cost-label">${i18n.t('index.related_papers_count')}</span>
                <span id="${cardId}-paper-count">${i18n.t('common.loading')}</span>
              </div>
              <div class="distill-cost-item">
                <span class="icon">ğŸ’°</span>
                <span class="cost-label">${i18n.t('index.estimated_consumption')}</span>
                <span id="${cardId}-estimated-cost">${i18n.t('common.loading')}</span>
              </div>
              <div class="distill-cost-item">
                <span class="icon">ğŸ’³</span>
                <span class="cost-label">${i18n.t('index.current_balance')}</span>
                <span id="${cardId}-user-balance">${i18n.t('common.loading')}</span>
              </div>
            </div>
            <div class="distill-actions">
              <button class="btn-orange" onclick="startDistillation('${cardId}', '${queryIndex}')" disabled>
                ${i18n.t('index.start_distillation')}
              </button>
            </div>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('afterbegin', cardHtml);
      activeDistillCards.set(cardId, { queryIndex, type: 'input', costData: null });
      
      // è‡ªåŠ¨ä¼°ç®—è´¹ç”¨ï¼ˆåªéœ€è°ƒç”¨ä¸€æ¬¡ï¼Œè´¹ç”¨ä¸ç”¨æˆ·è¾“å…¥æ— å…³ï¼‰
      estimateDistillationCost(cardId, queryIndex);
      
      // æ·»åŠ é—®é¢˜è¾“å…¥æ¡†çš„ç›‘å¬å™¨ï¼Œæ§åˆ¶æŒ‰é’®çŠ¶æ€ï¼ˆä¿®å¤27ï¼šç§»é™¤APIè°ƒç”¨ï¼Œæ”¹ä¸ºæœ¬åœ°çŠ¶æ€æ£€æŸ¥ï¼‰
      const questionEl = document.getElementById(`${cardId}-question`);
      const startBtn = document.querySelector(`#${cardId} .btn-orange`);
      
      questionEl.addEventListener('input', function() {
        const hasQuestion = this.value.trim().length > 0;
        // ä»ç¼“å­˜ä¸­è¯»å–è´¹ç”¨æ•°æ®ï¼Œé¿å…é‡å¤è°ƒç”¨API
        const cardData = activeDistillCards.get(cardId);
        if (cardData && cardData.costData) {
          const hasEnoughBalance = cardData.costData.user_balance >= cardData.costData.estimated_cost;
          startBtn.disabled = !(hasQuestion && hasEnoughBalance);
        } else {
          // è´¹ç”¨æ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œä¿æŒç¦ç”¨çŠ¶æ€
          startBtn.disabled = true;
        }
      });
      
      // æ»šåŠ¨åˆ°æ–°å¡ç‰‡
      const newCard = document.getElementById(cardId);
      newCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      return newCard;
    }

    /**
     * ä¼°ç®—è’¸é¦è´¹ç”¨
     * ä¿®å¤27ï¼šè´¹ç”¨åªéœ€è·å–ä¸€æ¬¡ï¼Œæ•°æ®ç¼“å­˜åˆ° activeDistillCards ä¸­ä¾› input äº‹ä»¶ä½¿ç”¨
     * @param {string} cardId å¡ç‰‡ID
     * @param {string} queryIndex åŸå§‹æŸ¥è¯¢ç´¢å¼•
     */
    async function estimateDistillationCost(cardId, queryIndex) {
      const questionEl = document.getElementById(`${cardId}-question`);
      const requirementsEl = document.getElementById(`${cardId}-requirements`);
      const costInfoEl = document.getElementById(`${cardId}-cost-info`);
      const startBtn = document.querySelector(`#${cardId} .btn-orange`);
      
      try {
        if (!queryIndex) return;

        // ä¿®å¤37: è·å–è´¹ç”¨ä¼°ç®—ä¿¡æ¯ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼Œuidä»tokenè·å–ï¼‰
        const response = await authFetch('/api/estimate_distillation_cost', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            original_query_id: queryIndex
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // ç¼“å­˜è´¹ç”¨æ•°æ®ä¾›åç»­ input äº‹ä»¶ä½¿ç”¨ï¼Œé¿å…é‡å¤è°ƒç”¨API
          const cardData = activeDistillCards.get(cardId);
          if (cardData) {
            cardData.costData = {
              doi_count: data.doi_count || 0,
              estimated_cost: data.estimated_cost || 0,
              user_balance: data.user_balance || 0
            };
          }
          
          document.getElementById(`${cardId}-paper-count`).textContent = (data.doi_count || 0).toLocaleString();
          document.getElementById(`${cardId}-estimated-cost`).textContent = (data.estimated_cost || 0).toLocaleString();
          document.getElementById(`${cardId}-user-balance`).textContent = (data.user_balance || 0).toLocaleString();
          
          // æ£€æŸ¥æ˜¯å¦æœ‰é—®é¢˜å†…å®¹å’Œä½™é¢æ˜¯å¦è¶³å¤Ÿ
          const question = questionEl.value.trim();
          const hasQuestion = question.length > 0;
          const hasEnoughBalance = data.user_balance >= data.estimated_cost;
          
          startBtn.disabled = !(hasQuestion && hasEnoughBalance);
          
          if (!hasEnoughBalance) {
            showError(i18n.t('index.distill_insufficient_balance'));
          }
        } else {
          // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          document.getElementById(`${cardId}-paper-count`).textContent = i18n.t('index.fetch_failed');
          document.getElementById(`${cardId}-estimated-cost`).textContent = i18n.t('index.fetch_failed');
          document.getElementById(`${cardId}-user-balance`).textContent = i18n.t('index.fetch_failed');
        }
      } catch (error) {
        console.error('Estimate cost error:', error);
        // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        document.getElementById(`${cardId}-paper-count`).textContent = i18n.t('index.fetch_failed');
        document.getElementById(`${cardId}-estimated-cost`).textContent = i18n.t('index.fetch_failed');
        document.getElementById(`${cardId}-user-balance`).textContent = i18n.t('index.fetch_failed');
      }
    }

    /**
     * å¼€å§‹è’¸é¦
     * @param {string} cardId å¡ç‰‡ID
     * @param {number} queryIndex åŸå§‹æŸ¥è¯¢ç´¢å¼•
     */
    async function startDistillation(cardId, queryIndex) {
      const questionEl = document.getElementById(`${cardId}-question`);
      const requirementsEl = document.getElementById(`${cardId}-requirements`);
      
      const question = questionEl.value.trim();
      const requirements = requirementsEl.value.trim();
      
      if (!question) {
        showError(i18n.t('index.distill_no_question'));
        questionEl.focus();
        return;
      }
      
      try {
        // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
        const response = await authFetch('/api/start_distillation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            original_query_id: queryIndex,
            question: question,
            requirements: requirements || '',
            language: i18n.getLang()  // ä¿®å¤36: ä¼ é€’å½“å‰è¯­è¨€ ('zh' æˆ– 'en')
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess(i18n.t('index.distill_start_success'));
          
          // è·å–å½“å‰çš„è´¹ç”¨ä¿¡æ¯
          const paperCountEl = document.getElementById(`${cardId}-paper-count`);
          const estimatedCostEl = document.getElementById(`${cardId}-estimated-cost`);
          
          // è½¬æ¢ä¸ºè’¸é¦æ‘˜è¦å¡ç‰‡
          convertToDistillSummaryCard(cardId, {
            queryIndex: data.query_id,
            question: question,
            requirements: requirements,
            estimatedCost: estimatedCostEl.textContent,
            paperCount: paperCountEl.textContent,
            startTime: new Date().toLocaleString()
          });
          
          // å¼€å§‹è½®è¯¢è¿›åº¦
          startDistillProgressPolling(cardId, data.query_id);
          
          // æŠ˜å åŸå§‹æ£€ç´¢å¡ç‰‡å¹¶æ›´æ–°å†å²åˆ—è¡¨
          collapseSearchSummaryCard();
          

          
          loadHistory(); // åˆ·æ–°å†å²åˆ—è¡¨
          
        } else {
          // é’ˆå¯¹ç‰¹å®šé”™è¯¯ç»™å‡ºæ›´å‹å¥½çš„æç¤º
          let errorMsg = data.message || data.error || i18n.t('index.distill_start_failed');
          if (data.error === 'no_relevant_papers') {
            errorMsg = i18n.t('index.distill_no_relevant_papers');
          } else if (data.error === 'insufficient_balance') {
            errorMsg = i18n.t('index.distill_insufficient_balance');
          }
          showError(errorMsg);
        }
      } catch (error) {
        console.error('Start distillation error:', error);
        showError(i18n.t('index.distill_start_failed') + ': ' + error.message);
      }
    }

    // å°†è’¸é¦å¡ç‰‡è½¬æ¢ä¸ºæ‘˜è¦æ˜¾ç¤ºæ¨¡å¼
    function convertToDistillSummaryCard(cardId, distillData) {
      const card = document.getElementById(cardId);
      if (!card) return;
      
      // éšè—è¾“å…¥åŒºåŸŸï¼Œæ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯
      const formGroups = card.querySelectorAll('.distill-form-group');
      const startBtn = card.querySelector('.distill-actions');
      const costInfo = card.querySelector('.distill-cost-info');
      
      // éšè—è¡¨å•ç»„å’ŒæŒ‰é’®
      formGroups.forEach(group => group.style.display = 'none');
      if (startBtn) startBtn.style.display = 'none';
      
      // éšè—åŸæ¥çš„è´¹ç”¨ä¿¡æ¯ï¼Œé¿å…é‡å¤æ˜¾ç¤º
      if (costInfo) costInfo.style.display = 'none';
      
      // æ›´æ–°å¡ç‰‡æ ‡é¢˜
      const titleElement = card.querySelector('.distill-title');
      if (titleElement) {
        titleElement.innerHTML = `
          <span class="distill-badge distill-running">${i18n.t('index.status_running')}</span>
          ${i18n.t('index.distill_in_progress')}
        `;
      }
      
      // åˆ›å»ºæ‘˜è¦æ˜¾ç¤ºåŒºåŸŸ
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'distill-summary';
      summaryDiv.innerHTML = `
        <div class="summary-content">
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.research_question">${i18n.t('index.research_question')}</div>
            <div class="summary-value">${distillData.question}</div>
          </div>
          ${distillData.requirements ? `
          <div class="summary-item">
            <div class="summary-label" data-i18n="index.research_requirements">${i18n.t('index.research_requirements')}</div>
            <div class="summary-value">${distillData.requirements}</div>
          </div>
          ` : ''}
          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label" data-i18n="index.distill_paper_count">${i18n.t('index.distill_paper_count')}</span>
                <strong>${distillData.paperCount}</strong>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label" data-i18n="index.estimated_cost_points">${i18n.t('index.estimated_cost_points')}</span>
                <strong>${distillData.estimatedCost}</strong>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-content">
                <span class="stat-label" data-i18n="index.distill_start_time">${i18n.t('index.distill_start_time')}</span>
                <strong>${distillData.startTime}</strong>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // æ’å…¥æ‘˜è¦åŒºåŸŸ
      const cardContent = card.querySelector('.distill-content');
      if (cardContent) {
        // å°†æ‘˜è¦åŒºåŸŸæ’å…¥åˆ°å¡ç‰‡å†…å®¹çš„å¼€å¤´
        cardContent.insertBefore(summaryDiv, cardContent.firstChild);
      }
      
      // åˆ›å»ºè¿›åº¦æ˜¾ç¤ºåŒºåŸŸ
      const progressDiv = document.createElement('div');
      progressDiv.className = 'distill-progress';
      progressDiv.id = `${cardId}-progress-section`; // æ·»åŠ IDä»¥ä¾¿åç»­æ“ä½œ
      progressDiv.innerHTML = `
        <div class="progress-container">
          <div class="progress-bar-wrapper">
            <div class="progress-bar">
              <div class="progress-fill" id="${cardId}-progress-fill"></div>
            </div>
            <div class="progress-text" id="${cardId}-progress-text">0%</div>
          </div>
        </div>
        <div class="progress-actions">
          <button class="btn-secondary pause-btn" id="${cardId}-pause-btn">
            ${i18n.t('index.pause')}
          </button>
        </div>
      `;
      
      if (cardContent) {
        cardContent.appendChild(progressDiv);
        
        // æ·»åŠ éšæœºæ–‡å­—æ˜¾ç¤º
        updateProgressRandomText(`${cardId}-progress-section`);
        
        // è®¾ç½®æš‚åœ/æ¢å¤æŒ‰é’®
        setupDistillPauseResumeButton(cardId, distillData.queryIndex);
      }
    }

    // è®¾ç½®è’¸é¦æš‚åœ/æ¢å¤æŒ‰é’®
    function setupDistillPauseResumeButton(cardId, queryIndex) {
      const pauseBtn = document.getElementById(`${cardId}-pause-btn`);
      if (!pauseBtn) return;
      
      pauseBtn.addEventListener('click', async () => {
        try {
          const isPaused = pauseBtn.textContent.includes(i18n.t('index.resume'));
          const action = isPaused ? 'resume' : 'pause';
          
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
          const response = await authFetch('/api/update_pause_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query_id: queryIndex,
              should_pause: action === 'pause'
            })
          });
          
          if (response.ok) {
            pauseBtn.textContent = isPaused ? i18n.t('index.pause') : i18n.t('index.resume');
          }
        } catch (error) {
          console.error('Pause/resume error:', error);
        }
      });
    }

    // å¼€å§‹è’¸é¦è¿›åº¦è½®è¯¢
    function startDistillProgressPolling(cardId, queryIndex) {
      const progressFill = document.getElementById(`${cardId}-progress-fill`);
      const progressText = document.getElementById(`${cardId}-progress-text`);
      
      if (!progressFill || !progressText) return;
      
      // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è½®è¯¢
      if (distillProgressIntervals.has(cardId)) {
        clearInterval(distillProgressIntervals.get(cardId));
      }
      
      const pollInterval = setInterval(async () => {
        try {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼ˆuidä»tokenè·å–ï¼‰
          const response = await authFetch(`/api/query_progress?query_id=${encodeURIComponent(queryIndex)}`);
          if (!response.ok) return;
          
          const data = await response.json();
          const progress = Math.max(0, Math.min(100, Number(data.progress || 0)));
          
          progressFill.style.width = progress + '%';
          progressText.textContent = progress + '%';
          
          if (data.completed) {
            clearInterval(pollInterval);
            distillProgressIntervals.delete(cardId);
            showDistillationComplete(cardId, queryIndex, data);
          }
        } catch (error) {
          console.error('Distillation progress polling error:', error);
        }
      }, 2000);
      
      // ä¿å­˜è½®è¯¢é—´éš”ID
      distillProgressIntervals.set(cardId, pollInterval);
    }

    // æ˜¾ç¤ºè’¸é¦å®Œæˆ
    function showDistillationComplete(cardId, queryIndex, data) {
      const card = document.getElementById(cardId);
      if (!card) return;
      
      const progressDiv = card.querySelector('.distill-progress');
      if (progressDiv) {
        progressDiv.innerHTML = `
          <div class="completion-message">
            <h4>${i18n.t('index.distillation_completed')}</h4>
            <div class="completion-actions">
              <button class="btn-secondary" onclick="downloadDistillationCSV('${queryIndex}')">
                <span data-i18n="index.download_all_results">${i18n.t('index.download_all_results')}</span>
              </button>
              <button class="btn-secondary" onclick="downloadDistillationBIB('${queryIndex}')">
                <span data-i18n="index.download_bib_results">${i18n.t('index.download_bib_results')}</span>
              </button>
              <button class="btn-orange" onclick="createDistillInputCard('${queryIndex}')">
                <span data-i18n="index.distill">${i18n.t('index.distill')}</span>
              </button>
            </div>
          </div>
        `;
      }
      
      // åˆ·æ–°å†å²è®°å½•
      loadHistory();
    }

    // ä¸‹è½½è’¸é¦ç»“æœ - CSVï¼ˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—APIï¼‰- ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
    window.downloadDistillationCSV = async function(queryIndex) {
      const token = localStorage.getItem('userToken');
      if (!token) {
        showError(i18n.t('index.login_required'));
        return;
      }
      
      showInfo(i18n.t('index.download_generating'));
      
      try {
        // ä¿®å¤37: åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼Œuidä»tokenè·å–ï¼‰
        const createResp = await authFetch('/api/download/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryIndex,
            type: 'csv'
          })
        });
        
        const createData = await createResp.json();
        if (!createData.success || !createData.task_id) {
          throw new Error(createData.error || 'Failed to create download task');
        }
        
        const taskId = createData.task_id;
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        let attempts = 0;
        const maxAttempts = 120;
        
        while (attempts < maxAttempts) {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
          const statusResp = await authFetch(`/api/download/status?task_id=${encodeURIComponent(taskId)}`);
          const status = await statusResp.json();
          
          if (status.state === 'READY') {
            window.location.href = `/api/download/file?task_id=${encodeURIComponent(taskId)}&token=${encodeURIComponent(localStorage.getItem('userToken'))}`;
            showSuccess(i18n.t('index.download_success'));
            break;
          } else if (status.state === 'FAILED') {
            throw new Error(status.error || 'Download generation failed');
          } else {
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
          }
        }
        
        if (attempts >= maxAttempts) {
          throw new Error('Download timeout');
        }
      } catch (error) {
        console.error('CSV download error:', error);
        showError(i18n.t('index.download_failed') + ': ' + error.message);
      }
    };

    // ä¸‹è½½è’¸é¦ç»“æœ - BIBï¼ˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—APIï¼‰- ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
    window.downloadDistillationBIB = async function(queryIndex) {
      const token = localStorage.getItem('userToken');
      if (!token) {
        showError(i18n.t('index.login_required'));
        return;
      }
      
      showInfo(i18n.t('index.download_generating'));
      
      try {
        // ä¿®å¤37: åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„ fetchï¼Œuidä»tokenè·å–ï¼‰
        const createResp = await authFetch('/api/download/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query_id: queryIndex,
            type: 'bib'
          })
        });
        
        const createData = await createResp.json();
        if (!createData.success || !createData.task_id) {
          throw new Error(createData.error || 'Failed to create download task');
        }
        
        const taskId = createData.task_id;
        
        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        let attempts = 0;
        const maxAttempts = 120;
        
        while (attempts < maxAttempts) {
          // ä¿®å¤37: ä½¿ç”¨å¸¦è®¤è¯çš„ fetch
          const statusResp = await authFetch(`/api/download/status?task_id=${encodeURIComponent(taskId)}`);
          const status = await statusResp.json();
          
          if (status.state === 'READY') {
            window.location.href = `/api/download/file?task_id=${encodeURIComponent(taskId)}&token=${encodeURIComponent(localStorage.getItem('userToken'))}`;
            showSuccess(i18n.t('index.download_success'));
            break;
          } else if (status.state === 'FAILED') {
            throw new Error(status.error || 'Download generation failed');
          } else {
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
          }
        }
        
        if (attempts >= maxAttempts) {
          throw new Error('Download timeout');
        }
      } catch (error) {
        console.error('BIB download error:', error);
        showError(i18n.t('index.download_failed') + ': ' + error.message);
      }
    };

    // é¡µé¢åˆå§‹åŒ–ï¼ˆæ”¾åˆ° DOMContentLoadedï¼Œç¡®ä¿å…ˆæ‰§è¡Œ i18n.applyI18n å†è®¾ç½®æ¬¢è¿è¯­ï¼Œé¿å…è¢«è¦†ç›–ï¼‰
    document.addEventListener('DOMContentLoaded', async () => {
      // ä¿®å¤35æ–°å¢ï¼šå…ˆæ£€æŸ¥ç»´æŠ¤æ¨¡å¼ï¼Œå¦‚æœåœ¨ç»´æŠ¤ä¸­ä¼šè·³è½¬åˆ°ç»´æŠ¤é¡µé¢
      const inMaintenance = await checkMaintenanceMode();
      if (inMaintenance) return;
      
      // ä¿®å¤35æ–°å¢ï¼šæ£€æŸ¥å…¬å‘Šæ 
      await checkAnnouncement();
      
      // æ·»åŠ ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
      document.getElementById('sidebarToggle').addEventListener('click', function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
      });

      // æ·»åŠ å†å²è®°å½•æŠ˜å åŠŸèƒ½
      document.getElementById('historyToggle').addEventListener('click', toggleHistoryCollapse);

      // æ€»æ˜¯å°è¯•åŠ è½½å†å²è®°å½•ï¼ˆå‡½æ•°å†…éƒ¨ä¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
      loadHistory().then(() => {
        // å†å²è®°å½•åŠ è½½å®Œæˆåæ¢å¤ä¼šè¯çŠ¶æ€
        restoreCurrentSession();
      });
      
      // æ¢å¤å½“å‰ä¼šè¯çŠ¶æ€
      restoreCurrentSession();

      // æ›´æ–°æ ‡é¢˜ä¸­çš„ç”¨æˆ·åæ˜¾ç¤º
      updateTitleGreeting();

      if (checkLogin()) {
        document.getElementById('submitBtn').addEventListener('click', updateStats);
        document.getElementById('startSearchBtn').addEventListener('click', startSearch);
        document.getElementById('backToInputBtn').addEventListener('click', backToInput);
        document.getElementById('clearTagsBtn').addEventListener('click', clearAllTagSelections);

        // åˆå§‹åŒ–ç”¨æˆ·ä½™é¢å¸¸é©»æ˜¾ç¤º
        initUserBalance();

        // åŠ è½½æ ‡ç­¾å’ŒæœŸåˆŠæ•°æ®
        loadTags().then(() => {
          loadJournals();
        });

        // è®¾ç½®é»˜è®¤å¹´ä»½
        const currentYear = new Date().getFullYear();
        document.getElementById('endYear').value = currentYear;
        document.getElementById('startYear').value = currentYear - 5;

      }
    });

    // ==================== å‰©ä½™è’¸é¦å‡½æ•° ====================

    // æš´éœ²å…¨å±€å‡½æ•°
    window.startDistillation = startDistillation;
    window.updateTitleGreeting = updateTitleGreeting;

  </script>
</body>
</html>