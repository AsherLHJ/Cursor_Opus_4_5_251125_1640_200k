<!doctype html>
<!--
  AutoPaperWeb æŸ¥è¯¢å†å²é¡µé¢
  
  æ•°æ®ç»“æ„è¯´æ˜ï¼š
  å†å²æ¡ç›® (item) åŒ…å«çš„å­—æ®µï¼š
  - query_index: æŸ¥è¯¢ç´¢å¼•
  - research_question: ç ”ç©¶é—®é¢˜
  - query_time: æŸ¥è¯¢æ—¶é—´
  - selected_folders: é€‰æ‹©çš„æ–‡ä»¶å¤¹ (è’¸é¦æ¡ç›®æ˜¾ç¤ºä¸º"è¢«è’¸é¦çš„æ£€ç´¢çš„æ•°æ®èŒƒå›´")
  - year_range: å¹´ä»½èŒƒå›´ (è’¸é¦æ¡ç›®æ˜¾ç¤ºä¸º"è¢«è’¸é¦çš„æ£€ç´¢çš„æ—¶é—´èŒƒå›´")
  - requirements: æŸ¥è¯¢è¦æ±‚
  - completed: æ˜¯å¦å®Œæˆ
  - should_pause: æ˜¯å¦æš‚åœ
  - start_time: å¼€å§‹æ—¶é—´
  - is_distillation: æ˜¯å¦ä¸ºè’¸é¦æ¡ç›® (æ•°æ®åº“å­—æ®µï¼Œ1=true, 0=falseï¼Œæ–°å¢å­—æ®µï¼Œä¸ºåç»­å¼€å‘æä¾›ä¾¿åˆ©)
-->
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="history.title">AutoPaperWeb æŸ¥è¯¢å†å²</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 22px; font-weight: 600; }
    .nav a {
      color: white;
      text-decoration: none;
      background: rgba(255,255,255,0.2);
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.3s;
      margin-left: 10px;
    }
    .nav a:hover { background: rgba(255,255,255,0.3); }
    .content { padding: 24px; }
    .status-bar { margin-bottom: 12px; color: #555; }
    .list { display: grid; gap: 12px; }
    .card {
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 16px;
      background: #fff;
    }
    .card.focused { border-color: #ff9800; background: #fff7e6; }
    /* è’¸é¦æ¡ç›®ç‰¹æ®Šæ ·å¼ - ä½¿ç”¨ç´«è‰²ä¸»é¢˜åŒºåˆ† */
    .card.distill-entry {
      border-left: 4px solid #9c27b0;
      background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
      box-shadow: 0 2px 8px rgba(156, 39, 176, 0.1);
    }
    /* è’¸é¦æ¡ç›®èšç„¦çŠ¶æ€ */
    .card.distill-entry.focused {
      border-color: #9c27b0;
      background: linear-gradient(135deg, #e1bee7 0%, #f8bbd9 100%);
      box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2);
    }
    /* è’¸é¦æ¡ç›®æ ‡é¢˜é¢œè‰²è°ƒæ•´ */
    .card.distill-entry .card-title {
      color: #6a1b9a;
    }
    .card-title { font-weight: 600; color: #333; margin-bottom: 8px; }
    .card-meta { color: #777; font-size: 13px; margin-bottom: 12px; }
    .progress {
      width: 100%;
      height: 10px;
      background: #f1f3f5;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      transition: width 0.3s ease;
    }
    
    /* è’¸é¦æ¡ç›®è¿›åº¦æ¡æ ·å¼ */
    .card.distill-entry .progress-bar {
      background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%);
    }
    .actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .btn {
      border: none; border-radius: 6px; padding: 8px 12px;
      cursor: pointer; color: white; font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .btn-csv { background: #28a745; }
    .btn-bib { background: #6f42c1; }
    .btn-distill { background: #ff6b6b; }
    .btn-pause { background: #ffc107; color: #212529; }
    .btn-resume { background: #17a2b8; }
    
    /* è’¸é¦æ¡ç›®æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .card.distill-entry .btn {
      box-shadow: 0 2px 4px rgba(156, 39, 176, 0.1);
    }
    .card.distill-entry .btn:hover {
      box-shadow: 0 4px 8px rgba(156, 39, 176, 0.2);
    }
    .msg { display: none; margin-top: 10px; padding: 10px; border-radius: 6px; }
    .msg.error { display:block; background:#f8d7da; color:#721c24; }
    .msg.success { display:block; background:#d4edda; color:#155724; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
  <h1 data-i18n="history.title">ğŸ“œ æŸ¥è¯¢å†å²</h1>
    <div class="nav">
  <span id="userWelcome">æ¬¢è¿ï¼Œæ¸¸å®¢</span>
  <a href="billing.html" data-i18n="common.billing">æ£€ç´¢è´¦å•</a>
  <a href="/index.html" data-i18n="common.back_home">è¿”å›é¦–é¡µ</a>
  <a href="#" id="logoutBtn" data-i18n="common.logout">é€€å‡ºç™»å½•</a>
      </div>
    </div>
    <div class="content">
  <div class="status-bar" id="statusBar" data-i18n="history.status_loading">åŠ è½½ä¸­...</div>
      <div id="historyList" class="list"></div>
      <div id="message" class="msg"></div>
    </div>
  </div>

  <script src="/static/js/i18n.js"></script>
  <script>
    // ç¼“å­˜å†å²æ•°æ®ï¼Œé¿å…è¯­è¨€åˆ‡æ¢æ—¶é‡å¤è¯·æ±‚
    let cachedHistoryData = null;

    // ç™»å½•æ ¡éªŒä¸æ˜¾ç¤º
    function updateWelcome(){
      const username = localStorage.getItem('username');
      const el = document.getElementById('userWelcome');
      if (username) {
        el.textContent = (i18n.getLang()==='zh'?'æ¬¢è¿ï¼Œ':'Welcome, ') + username;
      } else {
        el.textContent = (i18n.getLang()==='zh'?'æ¬¢è¿ï¼Œæ¸¸å®¢':'Welcome, Guest');
      }
    }
    window.apw_afterLangChange = function(){ 
      updateWelcome(); 
      // é‡æ–°åº”ç”¨å›½é™…åŒ–
      i18n.applyI18n();
      // å¦‚æœæœ‰ç¼“å­˜çš„å†å²æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è¯­è¨€
      if (cachedHistoryData) {
        document.getElementById('statusBar').textContent = i18n.t('history.total_records', {n: cachedHistoryData.length});
        renderHistory(cachedHistoryData);
      }
    };

    function checkLogin() {
      const token = localStorage.getItem('userToken');
      const username = localStorage.getItem('username');
      if (!token || !username) {
        window.location.href = '/login.html';
        return false;
      }
      updateWelcome();
      return true;
    }

    // é€€å‡ºç™»å½•
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('userToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      window.location.href = '/login.html';
    });

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, isError = false) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'msg ' + (isError ? 'error' : 'success');
      setTimeout(() => { msg.className = 'msg'; }, 3000);
    }

    // è§£æ DB ä¸­çš„ UTC å­—ç¬¦ä¸²åˆ° Dateï¼ˆæ”¯æŒ "UTC-YYYY-MM-DD HH:MM:SS" æˆ– "YYYY-MM-DD HH:MM:SS"ï¼‰
    function parseUtcDate(timeStr) {
      if (!timeStr) return null;
      try {
        let s = String(timeStr);
        if (s.startsWith('UTC-')) s = s.slice(4);
        const iso = s.replace(' ', 'T') + 'Z';
        const d = new Date(iso);
        return isNaN(d.getTime()) ? null : d;
      } catch (_) { return null; }
    }

    // æ ¼å¼åŒ–æ—¶é—´æˆ³ï¼ˆç”¨äºæ–‡ä»¶åï¼‰
    function formatTimestamp(timeStr) {
      const date = parseUtcDate(timeStr);
      if (!date) return 'unknown';
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      return `${year}${month}${day}_${hour}${minute}`;
    }

    // åŠ è½½å†å²è®°å½•
    async function loadHistory() {
      try {
        const uid = localStorage.getItem('userId');
        if (!uid) {
          showMessage(i18n.t('history.user_missing'), true);
          return;
        }

        const res = await fetch('/api/query_history?uid=' + encodeURIComponent(uid));
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');

        const logs = data.logs || [];
        cachedHistoryData = logs; // ç¼“å­˜æ•°æ®
        document.getElementById('statusBar').textContent = i18n.t('history.total_records', {n: logs.length});
        renderHistory(logs);

        // æ£€æŸ¥æ˜¯å¦éœ€è¦èšç„¦ç‰¹å®šæŸ¥è¯¢
        const focusQuery = new URLSearchParams(window.location.search).get('focus_query');
        if (focusQuery) {
          setTimeout(() => {
            const targetCard = document.querySelector(`[data-query-index="${focusQuery}"]`);
            if (targetCard) {
              targetCard.classList.add('focused');
              targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 100);
        }

      } catch (e) {
        console.error('åŠ è½½å†å²å¤±è´¥', e);
        showMessage(i18n.t('history.load_fail', {msg: e.message}), true);
      }
    }

    // æ¸²æŸ“å†å²è®°å½•
    function renderHistory(logs) {
      const list = document.getElementById('historyList');
      list.innerHTML = '';

      if (logs.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">' + i18n.t('history.no_records') + '</div>';
        return;
      }

      for (const item of logs) {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-query-index', item.query_index);
        
        // æ–°å¢ï¼šè’¸é¦æ¡ç›®æ ‡è¯†ï¼Œä¸ºåç»­å¼€å‘æä¾›ä¾¿åˆ©
        // æ•°æ®åº“ä¸­å­—æ®µåä¸º is_distillationï¼Œå€¼ä¸º 1(true) æˆ– 0(false)
        const isDistill = !!(item.is_distillation);
        card.setAttribute('data-is-distill', isDistill);
        
        // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºè’¸é¦æ¡ç›®çš„è¯†åˆ«ç»“æœ
        if (item.is_distillation !== undefined) {
          console.log(`Query ${item.query_index}: is_distillation=${item.is_distillation}, isDistill=${isDistill}`);
          if (isDistill) {
            console.log(`  - selected_folders: ${item.selected_folders}`);
            console.log(`  - year_range: ${item.year_range}`);
          }
        }
        
        // å¯é€‰ï¼šä¸ºè’¸é¦æ¡ç›®æ·»åŠ ç‰¹æ®Šçš„CSSç±»ï¼Œæ–¹ä¾¿åç»­æ ·å¼å®šåˆ¶
        if (isDistill) {
          card.classList.add('distill-entry');
        }

        const title = document.createElement('div');
        title.className = 'card-title';
        
        // ä¸ºè’¸é¦æ¡ç›®æ·»åŠ ç‰¹æ®Šå›¾æ ‡æ ‡è¯†
        const titleText = item.research_question || i18n.t('history.research_question_empty');
        if (isDistill) {
          title.innerHTML = 'ğŸ§ª ' + titleText;
          title.style.color = '#6a1b9a';
        } else {
          title.textContent = titleText;
        }

        const meta = document.createElement('div');
        meta.className = 'card-meta';
        const localTime = (() => {
          const d = parseUtcDate(item.query_time);
          return d ? d.toLocaleString() : (item.query_time || 'unknown');
        })();
        meta.textContent = i18n.t('history.time_and_id', {time: localTime, id: item.query_index});

        // æ•°æ®èŒƒå›´ä¿¡æ¯ - è’¸é¦æ¡ç›®æ˜¾ç¤ºä¸åŒå†…å®¹
        const rangeInfo = document.createElement('div');
        rangeInfo.className = 'card-meta';
        
        if (isDistill) {
          // è’¸é¦æ¡ç›®ï¼šæ˜¾ç¤ºè¢«è’¸é¦çš„æ£€ç´¢çš„æ•°æ®èŒƒå›´å’Œæ—¶é—´èŒƒå›´
          const sourceFolders = item.selected_folders || 'none';
          const sourceYear = item.year_range || 'none';
          rangeInfo.textContent = i18n.t('history.distill_source_info', {
            question: sourceFolders, 
            time: sourceYear
          });
        } else {
          // æ™®é€šæ¡ç›®ï¼šæ˜¾ç¤ºæ•°æ®èŒƒå›´å’Œæ—¶é—´èŒƒå›´
          rangeInfo.textContent = i18n.t('history.range_info', {
            folders: (item.selected_folders || 'none'), 
            year: (item.year_range || 'none')
          });
        }

        // æ–°å¢ï¼šæŸ¥è¯¢è¦æ±‚ä¿¡æ¯
        const requirementsInfo = document.createElement('div');
        requirementsInfo.className = 'card-meta';
        const requirements = item.requirements || (i18n.getLang()==='zh'?'æ— ç‰¹æ®Šè¦æ±‚':'none');
        requirementsInfo.textContent = i18n.t('history.requirements', {req: requirements});

        const status = document.createElement('div');
        status.className = 'card-meta';
        status.textContent = item.completed ? i18n.t('history.status_done') : i18n.t('history.status_running');

        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(rangeInfo);
        card.appendChild(requirementsInfo);
        card.appendChild(status);

        if (!item.completed) {
          const progress = document.createElement('div');
          progress.className = 'progress';
          const bar = document.createElement('div');
          bar.className = 'progress-bar';
          progress.appendChild(bar);
          card.appendChild(progress);

          // ä¸ºæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ·»åŠ æš‚åœ/æ¢å¤æŒ‰é’®
          addProgressButtons(card, item.query_index, item);

          // è½®è¯¢è¿›åº¦ï¼ˆç¬¬6æ­¥å°†æä¾›APIï¼Œè¿™é‡Œå…ˆå ä½ï¼‰
          const qid = item.query_index;
          const uid = localStorage.getItem('userId');
          const interval = setInterval(async () => {
            try {
              const res = await fetch('/api/query_progress?query_index=' + encodeURIComponent(qid) + '&uid=' + encodeURIComponent(uid || ''));
              if (!res.ok) return;
              const data = await res.json();
              const pct = Math.max(0, Math.min(100, Number(data.progress || 0)));
              bar.style.width = pct + '%';
              if (data.completed) {
                clearInterval(interval);
                // åˆ‡æ¢ä¸ºä¸‹è½½æŒ‰é’®
                bar.style.width = '100%';
                status.textContent = i18n.t('history.status_done');
                progress.remove();
                // ç§»é™¤æš‚åœæŒ‰é’®ï¼Œæ·»åŠ ä¸‹è½½æŒ‰é’®
                const existingActions = card.querySelector('.actions');
                if (existingActions) {
                  existingActions.remove();
                }
                
                // è·å–æœ€æ–°çš„ä»»åŠ¡çŠ¶æ€ä»¥æ­£ç¡®æ˜¾ç¤ºæŒ‰é’®
                try {
                  const historyRes = await fetch('/api/get_history');
                  if (historyRes.ok) {
                    const historyData = await historyRes.json();
                    const updatedItem = historyData.find(h => h.query_index === qid);
                    if (updatedItem) {
                      // ä½¿ç”¨æœ€æ–°çš„ä»»åŠ¡çŠ¶æ€
                      updatedItem.completed = true; // ç¡®ä¿æ ‡è®°ä¸ºå·²å®Œæˆ
                      addDownloadButtons(card, qid, updatedItem.start_time, updatedItem);
                    } else {
                      // å¦‚æœæ‰¾ä¸åˆ°æœ€æ–°çŠ¶æ€ï¼Œä½¿ç”¨åŸå§‹itemä½†æ ‡è®°ä¸ºå·²å®Œæˆ
                      const completedItem = {...item, completed: true};
                      addDownloadButtons(card, qid, completedItem.start_time, completedItem);
                    }
                  } else {
                    // APIè°ƒç”¨å¤±è´¥æ—¶çš„åå¤‡æ–¹æ¡ˆ
                    const completedItem = {...item, completed: true};
                    addDownloadButtons(card, qid, completedItem.start_time, completedItem);
                  }
                } catch (e) {
                  // å¼‚å¸¸æ—¶çš„åå¤‡æ–¹æ¡ˆ
                  const completedItem = {...item, completed: true};
                  addDownloadButtons(card, qid, completedItem.start_time, completedItem);
                }
              }
            } catch (e) {}
          }, 2000);
        } else {
          addDownloadButtons(card, item.query_index, item.start_time, item);
        }

        list.appendChild(card);
      }
    }

    // ä¸ºæ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡æ·»åŠ æš‚åœ/æ¢å¤æŒ‰é’®
    function addProgressButtons(card, queryIndex, item) {
      const actions = document.createElement('div');
      actions.className = 'actions';

      // ç”Ÿæˆtimestampæ ¼å¼çš„æ–‡ä»¶ååç¼€
      const timestamp = formatTimestamp(item.start_time);

      // æš‚åœ/æ¢å¤æŒ‰é’®
      const btnPauseResume = document.createElement('button');
      const isPaused = item.should_pause;
      btnPauseResume.className = isPaused ? 'btn btn-resume' : 'btn btn-pause';
      btnPauseResume.textContent = isPaused ? i18n.t('history.resume') : i18n.t('history.pause');
      btnPauseResume.addEventListener('click', () => {
        const confirmMessage = isPaused ? i18n.t('history.resume_confirm') : i18n.t('history.pause_confirm');
        if (confirm(confirmMessage)) {
          const uid = localStorage.getItem('userId');
          if (!uid) {
            alert(i18n.t('history.user_missing'));
            return;
          }
          
          fetch('/api/update_pause_status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              query_index: queryIndex,
              uid: uid,
              should_pause: !isPaused
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const successMessage = isPaused ? i18n.t('history.resume_success') : i18n.t('history.pause_success');
              alert(successMessage);
              // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
              loadHistory();
            } else {
              const failMessage = isPaused ? i18n.t('history.resume_fail', {msg: data.error || 'Unknown error'}) : i18n.t('history.pause_fail', {msg: data.error || 'Unknown error'});
              alert(failMessage);
            }
          })
          .catch(error => {
            console.error('Pause/Resume error:', error);
            const failMessage = isPaused ? i18n.t('history.resume_fail', {msg: error.message}) : i18n.t('history.pause_fail', {msg: error.message});
            alert(failMessage);
          });
        }
      });

      // å¦‚æœä»»åŠ¡å·²æš‚åœï¼Œæ·»åŠ ä¸‹è½½å’Œåˆ é™¤æŒ‰é’®
      if (isPaused) {
        // ä¸‹è½½CSVæŒ‰é’®
        const btnCsv = document.createElement('button');
        btnCsv.className = 'btn btn-csv';
        btnCsv.textContent = i18n.t('history.download_csv');
        btnCsv.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/download_csv?query_index=' + encodeURIComponent(queryIndex));
            if (!res.ok) throw new Error('API error');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Overall_' + timestamp + '.csv';
            a.click();
            URL.revokeObjectURL(url);
          } catch (e) {
            showMessage(i18n.t('history.csv_fail', {msg: e.message}), true);
          }
        });

        // ä¸‹è½½BibæŒ‰é’®
        const btnBib = document.createElement('button');
        btnBib.className = 'btn btn-bib';
        btnBib.textContent = i18n.t('history.download_bib');
        btnBib.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/download_bib?query_index=' + encodeURIComponent(queryIndex));
            if (!res.ok) throw new Error('API error');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Result_' + timestamp + '.bib';
            a.click();
            URL.revokeObjectURL(url);
          } catch (e) {
            showMessage(i18n.t('history.bib_fail', {msg: e.message}), true);
          }
        });

        actions.appendChild(btnCsv);
        actions.appendChild(btnBib);
        actions.appendChild(btnPauseResume);
      } else {
        // æœªæš‚åœæ—¶åªæ˜¾ç¤ºæš‚åœæŒ‰é’®
        actions.appendChild(btnPauseResume);
      }

      card.appendChild(actions);
    }

    function addDownloadButtons(card, queryIndex, startTime, item) {
      const actions = document.createElement('div');
      actions.className = 'actions';

      // ç”Ÿæˆtimestampæ ¼å¼çš„æ–‡ä»¶ååç¼€
      const timestamp = formatTimestamp(startTime);

      const btnCsv = document.createElement('button');
      btnCsv.className = 'btn btn-csv';
      btnCsv.textContent = i18n.t('history.download_csv');
      btnCsv.addEventListener('click', async () => {
        try {
          const res = await fetch('/api/download_csv?query_index=' + encodeURIComponent(queryIndex));
          if (!res.ok) throw new Error('API error');
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Overall_' + timestamp + '.csv';
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          showMessage(i18n.t('history.csv_fail', {msg: e.message}), true);
        }
      });

      const btnBib = document.createElement('button');
      btnBib.className = 'btn btn-bib';
      btnBib.textContent = i18n.t('history.download_bib');
      btnBib.addEventListener('click', async () => {
        try {
          const res = await fetch('/api/download_bib?query_index=' + encodeURIComponent(queryIndex));
          if (!res.ok) throw new Error('API error');
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Result_' + timestamp + '.bib';
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          showMessage(i18n.t('history.bib_fail', {msg: e.message}), true);
        }
      });

      // è’¸é¦æŒ‰é’®
      const btnDistill = document.createElement('button');
      btnDistill.className = 'btn btn-distill';
      btnDistill.textContent = i18n.t('history.distill');
      btnDistill.addEventListener('click', () => {
        // è·³è½¬åˆ°è’¸é¦é¡µé¢ï¼Œä¼ é€’æŸ¥è¯¢ç´¢å¼•
        window.location.href = '/distill.html?query_index=' + encodeURIComponent(queryIndex);
      });

      // æ ¹æ®ä»»åŠ¡çŠ¶æ€æ·»åŠ ä¸åŒçš„æŒ‰é’®ç»„åˆ
      actions.appendChild(btnCsv);
      actions.appendChild(btnBib);
      
      // åªæœ‰å·²å®Œæˆä¸”æœªæš‚åœçš„ä»»åŠ¡æ‰æ˜¾ç¤ºè’¸é¦æŒ‰é’®
      if (item.completed && !item.should_pause) {
        actions.appendChild(btnDistill);
      }
      
      card.appendChild(actions);
    }

    // è’¸é¦æ¡ç›®ç›¸å…³è¾…åŠ©å‡½æ•° - ä¸ºåç»­å¼€å‘æä¾›ä¾¿åˆ©
    
    /**
     * è·å–æ‰€æœ‰è’¸é¦æ¡ç›®
     * @returns {NodeList} æ‰€æœ‰è’¸é¦æ¡ç›®çš„DOMå…ƒç´ 
     */
    function getDistillEntries() {
      return document.querySelectorAll('.card[data-is-distill="true"]');
    }
    
    /**
     * æ£€æŸ¥æŒ‡å®šæŸ¥è¯¢ç´¢å¼•æ˜¯å¦ä¸ºè’¸é¦æ¡ç›®
     * @param {string} queryIndex æŸ¥è¯¢ç´¢å¼•
     * @returns {boolean} æ˜¯å¦ä¸ºè’¸é¦æ¡ç›®
     */
    function isDistillEntry(queryIndex) {
      const card = document.querySelector(`[data-query-index="${queryIndex}"]`);
      return card ? card.getAttribute('data-is-distill') === 'true' : false;
    }
    
    /**
     * åˆ‡æ¢è’¸é¦æ¡ç›®çš„æ˜¾ç¤ºçŠ¶æ€ï¼ˆä¸ºåç»­åŠŸèƒ½é¢„ç•™ï¼‰
     * @param {boolean} show æ˜¯å¦æ˜¾ç¤ºè’¸é¦æ¡ç›®
     */
    function toggleDistillEntries(show = true) {
      const distillEntries = getDistillEntries();
      distillEntries.forEach(entry => {
        entry.style.display = show ? 'block' : 'none';
      });
    }

    // é¡µé¢åˆå§‹åŒ–
    if (checkLogin()) {
      loadHistory();
    }
  </script>
</body>
</html>