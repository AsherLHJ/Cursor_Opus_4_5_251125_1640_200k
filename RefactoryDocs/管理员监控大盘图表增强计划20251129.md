<!-- b3e9dec1-8b77-4100-905a-d6693568f420 8424cab8-8825-4b71-a167-14bab937d52c -->
# 修复轮次十九：管理员监控大盘图表增强

## 需求概述

1. **布局与刷新功能调整**

   - "活跃任务队列"版块移至页面最下方
   - "刷新数据"按钮改为"手动刷新"
   - 新增"自动刷新间隔"下拉菜单（1秒、5秒、10秒、30秒、1分钟）

2. **新增趋势图表版块**

   - 显示：实时 TPM、实时 RPM、活跃 Workers、进行中任务
   - 时间范围可选：过去30分钟、过去1小时、过去24小时
   - 位置：数值展示卡片下方

---

## 技术方案

### 图表库选择

使用 **Chart.js**（轻量级、CDN 引入、无需构建）

### 数据存储方案

采用**前端数据采集**模式：

- 在前端 JavaScript 中维护历史数据队列
- 每次刷新时记录数据点（时间戳 + 值）
- 队列最大保留 24 小时的数据点（按采样间隔计算）
- 页面刷新后数据重新收集

### 图表设计

参考用户提供的监控图，使用**折线图**：

- X轴：时间（格式化为 HH:mm:ss）
- Y轴：对应指标值
- 4条数据线分别对应 TPM、RPM、Workers、Tasks
- 支持缩放和平滑曲线

---

## 实现计划

### 任务1：调整页面布局

**文件**: `lib/html/admin/dashboard.html`

1. 移动"活跃任务队列"面板到"系统健康状态"面板之后
2. 修改刷新按钮区域：

   - 按钮文字从"刷新数据"改为"手动刷新"
   - 在按钮右侧新增自动刷新间隔下拉菜单
```html
<!-- 刷新控制区域 -->
<div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
    <button class="refresh-btn" onclick="refreshData()">🔄 手动刷新</button>
    <label style="display:flex;align-items:center;gap:0.5rem;">
        自动刷新间隔:
        <select id="refreshInterval" onchange="setRefreshInterval(this.value)">
            <option value="1000">1秒</option>
            <option value="5000" selected>5秒</option>
            <option value="10000">10秒</option>
            <option value="30000">30秒</option>
            <option value="60000">1分钟</option>
        </select>
    </label>
    <span id="lastUpdate"></span>
</div>
```


### 任务2：新增图表版块

在数值卡片（stats-grid）下方添加图表面板：

```html
<!-- 趋势图表面板 -->
<div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h2>📈 实时趋势图</h2>
        <select id="chartTimeRange" onchange="updateChartTimeRange(this.value)">
            <option value="30">过去30分钟</option>
            <option value="60" selected>过去1小时</option>
            <option value="1440">过去24小时</option>
        </select>
    </div>
    <canvas id="metricsChart" height="300"></canvas>
</div>
```

### 任务3：实现JavaScript逻辑

1. **引入Chart.js**：通过CDN引入
2. **数据结构**：维护历史数据队列
3. **图表初始化**：创建折线图实例
4. **数据更新**：每次刷新时更新图表
5. **时间范围切换**：筛选数据并重绘图表
6. **自动刷新控制**：支持动态修改刷新间隔

---

## 页面最终结构顺序

1. 页头（Header）
2. 导航栏（Nav）
3. 刷新控制区域（手动刷新 + 自动刷新间隔 + 最后更新时间）
4. 数值统计卡片（TPM/RPM/Workers/Tasks）
5. **趋势图表面板**（新增）
6. 系统健康状态面板
7. **活跃任务队列面板**（移至此处）

---

## 样式增强

为下拉菜单和图表添加协调的样式：

- 下拉菜单与深色主题一致
- 图表颜色方案：TPM(蓝)、RPM(绿)、Workers(橙)、Tasks(紫)

---

## 文档更新

- 更新 `RefactoryDocs/PROGRESS_LOG.md`
- 更新 `RefactoryDocs/INTERFACE_SUMMARY.md`

---

## 附加任务：数据分析系统设计文档

创建 `RefactoryDocs/DATA_ANALYTICS_DESIGN.md`，内容包括：

### 1. 系统架构设计

- 三层数据架构（实时层/近线层/离线层）
- 数据流向图

### 2. 数据库表设计

- `metrics_minute` - 系统指标分钟级汇总表
- `metrics_hourly` - 系统指标小时级汇总表  
- `metrics_daily` - 系统指标日级汇总表
- `user_activity_daily` - 用户活动日汇总表
- `system_stats_daily` - 系统统计日汇总表
- 完整的 CREATE TABLE SQL 语句

### 3. 需要采集的商业数据清单

- 系统性能指标
- 用户增长指标
- 业务指标
- 用户行为指标
- 成本指标

### 4. 数据采集实现方案

- 实时采集（滑动窗口扩展）
- 定时汇总任务设计
- 事件埋点方案

### 5. CSV导出功能设计

- 导出接口API设计
- 数据格式规范
- 权限控制

### 6. 性能优化策略

- 批量写入
- 表分区方案
- 索引设计
- 数据归档策略

### 7. 实施路线图

- 阶段一：基础表结构和采集框架
- 阶段二：仪表板集成
- 阶段三：CSV导出和高级分析

### To-dos

- [x] 修复index.html中4处onclick属性的queryIndex参数添加引号
- [x] 修改register.html样式为深色主题匹配login.html
- [x] 更新PROGRESS_LOG.md和INTERFACE_SUMMARY.md记录修复内容