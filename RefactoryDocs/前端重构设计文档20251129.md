# AutoPaperWeb 前端重构设计文档

> **文档状态**: 规划阶段（未实施）  
> **创建日期**: 2025-11-29  
> **推荐实施时机**: 功能稳定后，有明确新功能需求时

---

## 1. 现状分析

### 1.1 当前技术栈

| 层级 | 技术 |
|------|------|
| 结构 | 纯 HTML |
| 样式 | 内联 CSS（`<style>` 标签）|
| 交互 | Vanilla JavaScript（`<script>` 标签）|
| 国际化 | 自定义 i18n.js |
| 构建 | 无（直接服务静态文件）|

### 1.2 代码规模统计

| 文件 | 行数 | 说明 |
|------|------|------|
| `index.html` | 4774 | 主页面，包含历史/蒸馏功能 |
| `history.html` | 633 | 独立历史页面（功能已整合到 index）|
| `distill.html` | 588 | 独立蒸馏页面（功能已整合到 index）|
| `billing.html` | 548 | 账单页面 |
| `login.html` | ~200 | 登录页面 |
| `register.html` | ~150 | 注册页面 |
| `admin/*.html` | ~1800 | 管理员页面（5个）|
| **总计** | **~8700** | |

### 1.3 存在的问题

1. **代码臃肿**: 单个 HTML 文件超过 4000 行，难以维护
2. **样式分散**: CSS 内联在每个页面，存在大量重复
3. **逻辑耦合**: JavaScript 与 HTML 混合，难以复用
4. **无组件化**: 相似的 UI 元素（按钮、卡片、表格）在各页面重复实现
5. **无构建优化**: 无法进行代码压缩、Tree Shaking、按需加载

---

## 2. 框架选型

### 2.1 候选框架对比

| 框架 | 学习曲线 | 迁移难度 | 构建工具 | 包大小 | 生态系统 | 适用场景 |
|------|---------|---------|---------|--------|---------|---------|
| **Vue.js 3** | 平缓 | 中等 | Vite | ~40KB | 完善 | 渐进式重构，中小型项目 |
| React | 较陡 | 较高 | Webpack/Vite | ~45KB | 最大 | 复杂交互，大型团队 |
| Alpine.js | 最低 | 最低 | 无需 | ~15KB | 较小 | 轻量增强，简单交互 |
| Svelte | 中等 | 中等 | Vite | ~2KB | 较小 | 性能优先，新项目 |

### 2.2 推荐方案：Vue.js 3

### 2.3 选型理由

1. **渐进式框架**: 可以逐页面迁移，不需要一次性重写全部代码
2. **单文件组件 (SFC)**: HTML/CSS/JS 在同一 `.vue` 文件，组织清晰
3. **响应式系统**: 自动追踪数据变化，简化状态管理
4. **生态完善**: 
   - Vue Router（路由）
   - Pinia（状态管理）
   - Element Plus / Naive UI（UI 组件库）
5. **中文友好**: 作者为华人，文档完善，社区活跃
6. **Vite 原生支持**: 开发体验极佳，热更新秒级

---

## 3. 新项目结构

### 3.1 目录规划

```
lib/html/
├── src/                          # Vue 源代码目录
│   ├── main.js                   # 应用入口
│   ├── App.vue                   # 根组件
│   │
│   ├── router/                   # 路由配置
│   │   └── index.js
│   │
│   ├── stores/                   # Pinia 状态管理
│   │   ├── user.js               # 用户状态（登录、余额、权限）
│   │   └── task.js               # 任务状态（进度、轮询）
│   │
│   ├── api/                      # API 封装层
│   │   ├── request.js            # Axios 封装（统一错误处理）
│   │   ├── user.js               # 用户相关 API
│   │   ├── query.js              # 查询相关 API
│   │   └── admin.js              # 管理员相关 API
│   │
│   ├── components/               # 可复用组件
│   │   ├── common/               # 通用组件
│   │   │   ├── AppHeader.vue
│   │   │   ├── AppSidebar.vue
│   │   │   ├── LoadingSpinner.vue
│   │   │   ├── MessageToast.vue
│   │   │   └── ConfirmDialog.vue
│   │   │
│   │   ├── search/               # 搜索相关组件
│   │   │   ├── JournalSelector.vue
│   │   │   ├── TagFilter.vue
│   │   │   ├── SearchForm.vue
│   │   │   └── ProgressCard.vue
│   │   │
│   │   ├── history/              # 历史相关组件
│   │   │   ├── HistoryList.vue
│   │   │   └── HistoryCard.vue
│   │   │
│   │   └── admin/                # 管理员组件
│   │       ├── StatsCard.vue
│   │       ├── UserTable.vue
│   │       └── TaskTable.vue
│   │
│   ├── views/                    # 页面组件
│   │   ├── user/                 # 普通用户页面
│   │   │   ├── LoginView.vue
│   │   │   ├── RegisterView.vue
│   │   │   ├── HomeView.vue
│   │   │   ├── HistoryView.vue
│   │   │   ├── DistillView.vue
│   │   │   └── BillingView.vue
│   │   │
│   │   └── admin/                # 管理员页面
│   │       ├── AdminLoginView.vue
│   │       ├── DashboardView.vue
│   │       ├── UsersView.vue
│   │       ├── TasksView.vue
│   │       ├── ControlView.vue
│   │       └── DebugView.vue
│   │
│   ├── styles/                   # 全局样式
│   │   ├── variables.css         # CSS 变量
│   │   ├── base.css              # 基础样式
│   │   └── dark-theme.css        # 深色主题
│   │
│   └── utils/                    # 工具函数
│       ├── i18n.js               # 国际化
│       ├── storage.js            # localStorage 封装
│       └── format.js             # 格式化函数
│
├── public/                       # 静态资源
│   └── favicon.ico
│
├── index.html                    # Vite 入口 HTML
├── vite.config.js                # Vite 配置
├── package.json                  # 依赖配置
└── .gitignore
```

---

## 4. 组件化设计

### 4.1 通用组件清单

| 组件名 | 功能 | 使用页面 |
|--------|------|---------|
| `AppHeader` | 顶部导航、用户信息、余额显示 | 所有页面 |
| `AppSidebar` | 左侧历史记录面板 | HomeView |
| `LoadingSpinner` | 加载动画 | 所有页面 |
| `MessageToast` | 消息提示 | 所有页面 |
| `ConfirmDialog` | 确认对话框 | 需要确认操作的页面 |
| `DataTable` | 数据表格 | 管理员页面 |
| `StatsCard` | 统计卡片 | DashboardView |
| `ProgressBar` | 进度条 | HomeView, HistoryView |

### 4.2 页面组件拆分（以 HomeView 为例）

```
HomeView.vue (主容器，约 100 行)
│
├── AppHeader.vue (顶部导航)
│   ├── Logo
│   ├── UserInfo (用户名 + 余额)
│   ├── LanguageSwitch
│   └── LogoutButton
│
├── AppSidebar.vue (左侧面板)
│   ├── NewSearchButton
│   └── HistoryList.vue
│       └── HistoryCard.vue (单条记录)
│           ├── Title
│           ├── Status Badge
│           └── Action Buttons
│
└── MainContent.vue (右侧主区域)
    │
    ├── SearchSection.vue (搜索配置区)
    │   ├── SearchForm.vue
    │   │   ├── QuestionInput
    │   │   └── RequirementsInput
    │   ├── TagFilter.vue
    │   ├── JournalSelector.vue
    │   │   ├── SearchBox
    │   │   ├── JournalList
    │   │   └── YearRangeSelector
    │   └── CostEstimate.vue
    │
    ├── ProgressSection.vue (进度显示区)
    │   ├── ProgressCard.vue
    │   │   ├── ProgressBar
    │   │   ├── StatsDisplay
    │   │   └── ControlButtons (暂停/终止)
    │   └── RandomSentence.vue
    │
    ├── ResultSection.vue (结果显示区)
    │   └── DownloadButtons.vue
    │
    └── DistillSection.vue (蒸馏功能区)
        ├── DistillForm.vue
        └── DistillProgress.vue
```

### 4.3 组件层级图

```
App.vue
├── RouterView
│   │
│   ├── [User Routes]
│   │   ├── LoginView
│   │   ├── RegisterView
│   │   ├── HomeView
│   │   │   ├── AppHeader
│   │   │   ├── AppSidebar
│   │   │   │   └── HistoryCard (v-for)
│   │   │   └── MainContent
│   │   │       ├── SearchSection
│   │   │       ├── ProgressSection
│   │   │       ├── ResultSection
│   │   │       └── DistillSection
│   │   ├── HistoryView
│   │   ├── DistillView
│   │   └── BillingView
│   │
│   └── [Admin Routes]
│       ├── AdminLoginView
│       ├── DashboardView
│       │   ├── AdminHeader
│       │   ├── AdminNav
│       │   └── StatsCard (v-for)
│       ├── UsersView
│       ├── TasksView
│       ├── ControlView
│       └── DebugView
│
└── MessageToast (全局)
```

---

## 5. 构建工具配置

### 5.1 Vite 配置示例

```javascript
// vite.config.js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  plugins: [vue()],
  
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@components': path.resolve(__dirname, 'src/components'),
      '@views': path.resolve(__dirname, 'src/views'),
      '@api': path.resolve(__dirname, 'src/api'),
      '@stores': path.resolve(__dirname, 'src/stores'),
      '@utils': path.resolve(__dirname, 'src/utils'),
    }
  },
  
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',  // Python 后端
        changeOrigin: true
      }
    }
  },
  
  build: {
    outDir: 'dist',
    assetsDir: 'static',
    // 分包配置
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'vue-router', 'pinia'],
          'ui': ['@element-plus/icons-vue']  // 如果使用 UI 库
        }
      }
    }
  }
})
```

### 5.2 开发/生产环境配置

```javascript
// .env.development
VITE_API_BASE_URL=http://localhost:8080
VITE_DEBUG=true

// .env.production
VITE_API_BASE_URL=
VITE_DEBUG=false
```

---

## 6. 设计系统

### 6.1 CSS 变量定义

```css
/* src/styles/variables.css */
:root {
  /* ========== 颜色系统 - 深色主题 ========== */
  
  /* 背景色层级 */
  --color-bg-primary: #0a0a0a;      /* 页面背景 */
  --color-bg-secondary: #1a1a1a;    /* 卡片背景 */
  --color-bg-tertiary: #2a2a2a;     /* 输入框背景 */
  --color-bg-hover: #333333;        /* 悬停背景 */
  
  /* 文字色层级 */
  --color-text-primary: #e5e5e5;    /* 主要文字 */
  --color-text-secondary: #a0a0a0;  /* 次要文字 */
  --color-text-muted: #666666;      /* 提示文字 */
  --color-text-inverse: #0a0a0a;    /* 反色文字 */
  
  /* 边框色 */
  --color-border-primary: #333333;
  --color-border-secondary: #444444;
  --color-border-focus: #4a90d9;
  
  /* 强调色 */
  --color-accent-blue: #4a90d9;     /* 主色调 */
  --color-accent-green: #28a745;    /* 成功 */
  --color-accent-orange: #ff9800;   /* 警告 */
  --color-accent-red: #dc3545;      /* 危险/错误 */
  --color-accent-purple: #8b5cf6;   /* 蒸馏/特殊 */
  
  /* ========== 间距系统 ========== */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --spacing-2xl: 48px;
  
  /* ========== 圆角 ========== */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  
  /* ========== 阴影 ========== */
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
  --shadow-glow-blue: 0 0 20px rgba(74, 144, 217, 0.3);
  
  /* ========== 字体 ========== */
  --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 
                 'Helvetica Neue', Arial, sans-serif;
  --font-family-mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, 
                      Consolas, 'Liberation Mono', monospace;
  
  --font-size-xs: 12px;
  --font-size-sm: 14px;
  --font-size-md: 16px;
  --font-size-lg: 18px;
  --font-size-xl: 20px;
  --font-size-2xl: 24px;
  --font-size-3xl: 30px;
  
  /* ========== 动画 ========== */
  --transition-fast: 150ms ease;
  --transition-normal: 300ms ease;
  --transition-slow: 500ms ease;
  
  /* ========== 层级 (z-index) ========== */
  --z-dropdown: 100;
  --z-modal: 200;
  --z-toast: 300;
  --z-tooltip: 400;
}
```

### 6.2 深色主题规范

| 元素 | 颜色变量 | 示例值 |
|------|---------|--------|
| 页面背景 | `--color-bg-primary` | `#0a0a0a` |
| 卡片背景 | `--color-bg-secondary` | `#1a1a1a` |
| 输入框背景 | `--color-bg-tertiary` | `#2a2a2a` |
| 主要文字 | `--color-text-primary` | `#e5e5e5` |
| 边框 | `--color-border-primary` | `#333333` |
| 主按钮 | `--color-accent-blue` | `#4a90d9` |
| 成功状态 | `--color-accent-green` | `#28a745` |
| 危险按钮 | `--color-accent-red` | `#dc3545` |

---

## 7. 状态管理

### 7.1 Pinia Store 设计

#### 用户状态 (user.js)

```javascript
// src/stores/user.js
import { defineStore } from 'pinia'
import { userApi } from '@/api/user'

export const useUserStore = defineStore('user', {
  state: () => ({
    uid: null,
    username: '',
    balance: 0,
    permission: 0,
    isLoggedIn: false,
    token: ''
  }),
  
  getters: {
    displayBalance: (state) => state.balance.toLocaleString(),
    canStartSearch: (state) => state.balance > 0
  },
  
  actions: {
    async login(username, password) {
      const { success, uid, token, balance, permission } = await userApi.login(username, password)
      if (success) {
        this.uid = uid
        this.username = username
        this.token = token
        this.balance = balance
        this.permission = permission
        this.isLoggedIn = true
        this.saveToStorage()
      }
      return success
    },
    
    logout() {
      this.$reset()
      localStorage.removeItem('user')
    },
    
    async refreshBalance() {
      if (!this.uid) return
      const { balance } = await userApi.getInfo(this.uid)
      this.balance = balance
    },
    
    saveToStorage() {
      localStorage.setItem('user', JSON.stringify({
        uid: this.uid,
        username: this.username,
        token: this.token
      }))
    },
    
    loadFromStorage() {
      const saved = localStorage.getItem('user')
      if (saved) {
        const { uid, username, token } = JSON.parse(saved)
        this.uid = uid
        this.username = username
        this.token = token
        this.isLoggedIn = true
      }
    }
  }
})
```

#### 任务状态 (task.js)

```javascript
// src/stores/task.js
import { defineStore } from 'pinia'
import { queryApi } from '@/api/query'

export const useTaskStore = defineStore('task', {
  state: () => ({
    currentQueryId: null,
    progress: 0,
    status: 'idle',  // idle | running | paused | completed | cancelled
    totalPapers: 0,
    processedPapers: 0,
    actualCost: 0,
    pollingTimer: null
  }),
  
  getters: {
    isRunning: (state) => state.status === 'running',
    isPaused: (state) => state.status === 'paused',
    isCompleted: (state) => state.status === 'completed'
  },
  
  actions: {
    startPolling(queryId) {
      this.currentQueryId = queryId
      this.status = 'running'
      this.pollingTimer = setInterval(() => this.fetchProgress(), 2000)
    },
    
    stopPolling() {
      if (this.pollingTimer) {
        clearInterval(this.pollingTimer)
        this.pollingTimer = null
      }
    },
    
    async fetchProgress() {
      if (!this.currentQueryId) return
      
      const data = await queryApi.getProgress(this.currentQueryId)
      this.progress = data.progress
      this.processedPapers = data.processed
      this.totalPapers = data.total
      this.actualCost = data.actual_cost
      
      if (data.completed) {
        this.status = 'completed'
        this.stopPolling()
      }
    },
    
    async pauseTask() {
      await queryApi.updatePauseStatus(this.currentQueryId, true)
      this.status = 'paused'
      this.stopPolling()
    },
    
    async resumeTask() {
      await queryApi.updatePauseStatus(this.currentQueryId, false)
      this.status = 'running'
      this.startPolling(this.currentQueryId)
    },
    
    reset() {
      this.stopPolling()
      this.$reset()
    }
  }
})
```

---

## 8. API 封装层

### 8.1 统一请求封装

```javascript
// src/api/request.js
import axios from 'axios'
import { useUserStore } from '@/stores/user'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器
request.interceptors.request.use(
  (config) => {
    const userStore = useUserStore()
    if (userStore.token) {
      config.headers['Authorization'] = `Bearer ${userStore.token}`
    }
    return config
  },
  (error) => Promise.reject(error)
)

// 响应拦截器
request.interceptors.response.use(
  (response) => {
    const data = response.data
    if (data.success === false) {
      // 业务错误
      return Promise.reject(new Error(data.message || data.error || '请求失败'))
    }
    return data
  },
  (error) => {
    // HTTP 错误
    if (error.response) {
      switch (error.response.status) {
        case 401:
          // 未授权，跳转登录
          const userStore = useUserStore()
          userStore.logout()
          window.location.href = '/login'
          break
        case 403:
          console.error('无权访问')
          break
        case 500:
          console.error('服务器错误')
          break
      }
    }
    return Promise.reject(error)
  }
)

export default request
```

### 8.2 错误处理规范

```javascript
// src/utils/error-handler.js
import { ElMessage } from 'element-plus'  // 或自定义 Toast

export function handleApiError(error, customMessage) {
  const message = customMessage || error.message || '操作失败'
  
  // 显示错误提示
  ElMessage.error(message)
  
  // 日志记录（生产环境可上报）
  if (import.meta.env.VITE_DEBUG) {
    console.error('[API Error]', error)
  }
}

// 使用示例
async function startSearch() {
  try {
    const result = await queryApi.startSearch(params)
    // 成功处理
  } catch (error) {
    handleApiError(error, '启动搜索失败')
  }
}
```

---

## 9. 迁移策略

### 9.1 方案A：一次性重构（推荐）

**优点**：
- 代码一致性好
- 无需维护两套系统
- 最终代码质量高

**缺点**：
- 周期较长（约 3-4 周）
- 期间功能冻结

### 9.2 四阶段实施计划

#### 阶段一（Week 1）: 基础搭建

| 任务 | 时间 | 产出 |
|------|------|------|
| 环境搭建 | 4h | Vite + Vue 3 + Router + Pinia 项目 |
| 设计系统 | 8h | variables.css + base.css |
| API 封装 | 8h | request.js + 各模块 API |
| 通用组件 | 16h | Header/Sidebar/Toast/Loading 等 |

#### 阶段二（Week 2）: 用户页面

| 任务 | 时间 | 产出 |
|------|------|------|
| 登录/注册 | 8h | LoginView + RegisterView |
| 首页框架 | 16h | HomeView + 搜索相关组件 |
| 历史功能 | 8h | HistoryList + HistoryCard |
| 进度/结果 | 8h | ProgressSection + ResultSection |

#### 阶段三（Week 3）: 完善功能

| 任务 | 时间 | 产出 |
|------|------|------|
| 蒸馏功能 | 8h | DistillSection + DistillView |
| 账单页面 | 4h | BillingView |
| 管理员页面 | 24h | 5 个管理员视图 |
| 国际化适配 | 4h | i18n 集成 |

#### 阶段四（Week 4）: 测试上线

| 任务 | 时间 | 产出 |
|------|------|------|
| 功能测试 | 16h | 完整功能验证 |
| 兼容性测试 | 8h | Chrome/Firefox/Edge |
| 部署调整 | 8h | 后端静态服务配置 |
| 文档更新 | 8h | 开发/部署文档 |

---

## 10. 工作量评估

### 10.1 前端改动

| 类别 | 工作项 | 估计工时 |
|------|--------|---------|
| 环境搭建 | Vite + Vue 3 + Router + Pinia | 4h |
| API 封装 | 统一请求层、错误处理 | 8h |
| 通用组件 | Header/Sidebar/Toast/Loading 等 | 16h |
| 用户页面 | 6 个页面迁移 | 40h |
| 管理员页面 | 6 个页面迁移 | 24h |
| 状态管理 | 用户状态、任务状态、轮询逻辑 | 8h |
| 样式统一 | 设计系统、深色主题 | 12h |
| 国际化 | i18n 适配 Vue | 8h |
| 测试调试 | 功能测试、兼容性测试 | 16h |
| **合计** | | **约 136h（17天 × 8h）** |

### 10.2 后端改动

| 类别 | 工作项 | 估计工时 |
|------|--------|---------|
| 静态文件服务 | 调整 server.py 服务 Vue dist 目录 | 2h |
| CORS 配置 | 开发环境跨域支持 | 1h |
| **合计** | | **约 3h** |

### 10.3 涉及文件清单

**需要重写的 HTML 文件（10个）**：

| 原文件 | 新文件 | 行数变化 |
|--------|--------|---------|
| `index.html` | `HomeView.vue` + 多组件 | 4774 → ~800 |
| `login.html` | `LoginView.vue` | ~200 → ~100 |
| `register.html` | `RegisterView.vue` | ~150 → ~80 |
| `history.html` | `HistoryView.vue` | 633 → ~150 |
| `distill.html` | `DistillView.vue` | 588 → ~150 |
| `billing.html` | `BillingView.vue` | 548 → ~120 |
| `admin/login.html` | `AdminLoginView.vue` | ~200 → ~100 |
| `admin/dashboard.html` | `DashboardView.vue` | ~360 → ~150 |
| `admin/users.html` | `UsersView.vue` | ~220 → ~120 |
| `admin/tasks.html` | `TasksView.vue` | ~200 → ~120 |
| `admin/control.html` | `ControlView.vue` | ~450 → ~150 |

**后端需微调的文件（1个）**：
- `lib/webserver/server.py` - 静态文件服务配置

---

## 11. 风险与建议

### 11.1 实施时机建议

| 条件 | 说明 |
|------|------|
| ✅ 应该重构 | 功能已稳定，有新的大功能需求 |
| ✅ 应该重构 | 团队有 Vue.js 经验 |
| ✅ 应该重构 | 可以接受 3-4 周的功能冻结期 |
| ❌ 不应重构 | 当前仍有大量 Bug 待修复 |
| ❌ 不应重构 | 短期内有紧急功能上线需求 |

**当前建议**：先完成 Bug 修复和功能稳定，待系统运行稳定后再考虑前端重构。

### 11.2 注意事项

1. **保持 API 兼容**: 前端重构不应影响后端 API，保持接口不变
2. **渐进式测试**: 每完成一个页面就进行测试，不要积累到最后
3. **保留旧代码**: 重构期间保留旧代码作为参考，完全验证通过后再删除
4. **文档同步**: 重构过程中同步更新开发文档和部署文档
5. **团队培训**: 如果团队不熟悉 Vue.js，需要预留学习时间

---

## 附录：技术选型参考链接

- [Vue.js 3 官方文档](https://cn.vuejs.org/)
- [Vite 官方文档](https://cn.vitejs.dev/)
- [Pinia 状态管理](https://pinia.vuejs.org/zh/)
- [Vue Router](https://router.vuejs.org/zh/)
- [Element Plus UI](https://element-plus.org/zh-CN/)

