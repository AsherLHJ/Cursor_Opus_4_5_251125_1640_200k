sequenceDiagram
    autonumber
    actor Admin as Admin (管理员)
    participant Server as Server (Admin API)
    participant Redis as Redis (Cache/Queue)
    participant MySQL as MySQL (DB)

    Note over Admin, MySQL: === 1. 管理员登录 ===
    Admin->>Server: 访问 /admin/login.html -> 提交账号密码
    Server->>MySQL: SELECT * FROM admin_info WHERE username=...
    MySQL-->>Server: 返回管理员信息
    Server->>Server: 验证密码 (Bcrypt)
    Server->>Redis: SET admin:session:{token} (创建管理员会话)
    Server-->>Admin: 登录成功 (Set-Cookie)

    Note over Admin, MySQL: === 2. 系统监控大盘 (Dashboard) ===
    Admin->>Server: 获取监控数据 (Get Dashboard)
    
    par 队列监控
        Server->>Redis: KEYS task:*:pending_blocks (扫描活跃任务队列)
        Server->>Redis: LLEN task:{uid}:{qid}:pending_blocks (获取堆积任务数)
        Server->>Redis: LLEN billing_queue:{uid} (获取待同步账单数)
    and 流量监控 (TPM/RPM)
        Server->>Server: 读取内存中的滑动窗口 (Sliding Window)
        Note right of Server: 获取实时 TPM (Tokens Per Minute) <br/> 和 RPM (Requests Per Minute)
    and 资源监控
        Server->>Server: 统计活跃 Worker 线程数
    end
    
    Server-->>Admin: 返回监控大盘数据 (JSON)

    Note over Admin, MySQL: === 3. 用户管理 (User Management) ===
    Admin->>Server: 获取用户列表
    Server->>MySQL: SELECT uid, username, balance, permission FROM user_info
    MySQL-->>Server: 返回用户列表
    Server-->>Admin: 展示用户列表

    Admin->>Server: 修改用户余额 (充值/扣款)
    Server->>MySQL: UPDATE user_info SET balance = new_value WHERE uid=...
    Server->>Redis: DEL user:{uid}:balance (删除缓存, 强制下次读取回源)
    Server->>Redis: SET user:{uid}:balance new_value (或直接更新缓存)
    Server-->>Admin: 操作成功

    Admin->>Server: 修改并发权限 (Permission)
    Server->>MySQL: UPDATE user_info SET permission = new_value WHERE uid=...
    Server->>Redis: HSET user:{uid}:info permission new_value (更新缓存)
    Server-->>Admin: 操作成功

    Note over Admin, MySQL: === 4. 任务管理 (Task Management) ===
    Admin->>Server: 查看某用户的正在运行任务
    Server->>Redis: KEYS task:{uid}:*:pending_blocks
    Server-->>Admin: 返回任务ID列表

    Admin->>Server: 强制终止任务
    Server->>Redis: SET query:{uid}:{qid}:pause_signal "1" (发送暂停/终止信号)
    Server->>Redis: EXPIRE query:{uid}:{qid}:pause_signal 604800 (7天过期)
    Note right of Server: Worker线程检测到信号后<br/>会自动退出并释放资源
    Server-->>Admin: 终止指令已发送

